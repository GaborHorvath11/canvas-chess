var CHESS=CHESS||{};CHESS.Board=function(d){var e,b={subscribers:{any:[]}},c=CHESS.engine.createPosition(),a={container:null,canvas:null,ctx:null,snapshot:null,snapshot_ctx:null,snapshot_img:new Image(),square_size:80,square_color_light:"#ececd7",square_color_dark:"#7389b6",square_hover_light:"#b4d990",square_hover_dark:"#85c249",square_light:new Image(),square_dark:new Image(),dragok:false,drag_piece:"",drag_clear_i:0,drag_clear_j:0,left:0,top:0,last_draw_left:0,last_draw_top:0,piece_not_lifted:true,white_down:true,highlight_move:false,highlight_hover:false,show_row_col_labels:true,pieces:new Image()};b.myCancel=function(f){f.preventDefault();a.dragok=false;a.drag_piece="";a.left=0;a.top=0;a.takeSnapshot();a.refresh()};b.myDown=function(m){var g,f,h,l,k=a.canvas.getBoundingClientRect();if(c.active){if(m.hasOwnProperty("clientX")){a.left=m.clientX-k.left;a.top=m.clientY-k.top;a.canvas.style.cursor="move"}else{if(m.hasOwnProperty("changedTouches")){a.left=m.changedTouches[0].pageX-k.left;a.top=m.changedTouches[0].pageY-k.top}else{return}}g=parseInt(a.top/a.square_size,10);f=parseInt(a.left/a.square_size,10);if(!a.white_down){g=7-g;f=7-f}if(g<8){h=c.position_array[g][f]}else{if(c.mode==="setup"){h=c.piecebox_array[g-8][f]}}l=h.substr(0,1);if(c.mode!=="setup"&&((c.white_to_move&&l==="b")||(!c.white_to_move&&l==="w"))){a.canvas.style.cursor="default";return}if(h!==""){a.drag_clear_i=g;a.drag_clear_j=f;a.drag_piece=h;a.dragok=true;a.takeSnapshot()}else{a.canvas.style.cursor="default"}}};b.myMove=function(w){w.preventDefault();var m=a,t,q,l,v,g,o,n,x,p,y,u,r,h,f=m.canvas.getBoundingClientRect(),s,k=m.square_size*8;if(m.dragok){t=parseInt(m.top/m.square_size,10);q=parseInt(m.left/m.square_size,10);o=(q-1)*m.square_size;n=(t-1)*m.square_size;x=m.square_size*3;p=m.square_size*3;if(!(t<0||t>7||q<0||q>7)){if(o<0){o=0}if(n<0){n=0}if(o+x>k){x=k-o}if(n+p>k){p=k-n}m.ctx.drawImage(m.snapshot,0,0,k,k,0,0,k,k)}if(w.hasOwnProperty("clientX")){m.left=w.clientX-f.left;m.top=w.clientY-f.top}else{if(w.hasOwnProperty("changedTouches")){m.left=w.changedTouches[0].pageX-f.left;m.top=w.changedTouches[0].pageY-f.top}else{return}}t=parseInt(m.top/m.square_size,10);q=parseInt(m.left/m.square_size,10);if(t<0||t>7||q<0||q>7){return}if(m.highlight_hover){m.drawSquare("hover",t*m.square_size,q*m.square_size)}m.ctx.save();y=(m.square_size/55);m.ctx.scale(y,y);l=t;v=q;if(!m.white_down){l=7-t;v=7-q}g=c.position_array[l][v].substr(0,2);if(g!==""&&!(l===m.drag_clear_i&&v===m.drag_clear_j)){u=parseInt((q*m.square_size/y),10);r=parseInt((t*m.square_size/y),10);switch(g){case"wk":m.ctx.drawImage(m.pieces,0,0,55,55,u,r,55,55);break;case"wq":m.ctx.drawImage(m.pieces,55,0,55,55,u,r,55,55);break;case"wr":m.ctx.drawImage(m.pieces,110,0,55,55,u,r,55,55);break;case"wb":m.ctx.drawImage(m.pieces,160,0,55,55,u,r,55,55);break;case"wn":m.ctx.drawImage(m.pieces,215,0,55,55,u,r,55,55);break;case"wp":m.ctx.drawImage(m.pieces,270,0,55,55,u,r,55,55);break;case"bk":m.ctx.drawImage(m.pieces,0,55,55,55,u,r,55,55);break;case"bq":m.ctx.drawImage(m.pieces,55,55,55,55,u,r,55,55);break;case"br":m.ctx.drawImage(m.pieces,110,55,55,55,u,r,55,55);break;case"bb":m.ctx.drawImage(m.pieces,160,55,55,55,u,r,55,55);break;case"bn":m.ctx.drawImage(m.pieces,215,55,55,55,u,r,55,55);break;case"bp":m.ctx.drawImage(m.pieces,270,55,55,55,u,r,55,55);break}}g=m.drag_piece.substr(0,2);u=parseInt(((m.left-(m.square_size/2))/y),10);r=parseInt(((m.top-(m.square_size/2))/y),10);h=55;if(c.mode==="setup"&&m.top>m.square_size*7.5){h=h-((m.top-m.square_size*7.5)/y)}switch(g){case"wk":m.ctx.drawImage(m.pieces,0,0,55,55,u,r,55,h);break;case"wq":m.ctx.drawImage(m.pieces,55,0,55,55,u,r,55,h);break;case"wr":m.ctx.drawImage(m.pieces,110,0,55,55,u,r,55,h);break;case"wb":m.ctx.drawImage(m.pieces,160,0,55,55,u,r,55,h);break;case"wn":m.ctx.drawImage(m.pieces,215,0,55,55,u,r,55,h);break;case"wp":m.ctx.drawImage(m.pieces,270,0,55,55,u,r,55,h);break;case"bk":m.ctx.drawImage(m.pieces,0,55,55,55,u,r,55,h);break;case"bq":m.ctx.drawImage(m.pieces,55,55,55,55,u,r,55,h);break;case"br":m.ctx.drawImage(m.pieces,110,55,55,55,u,r,55,h);break;case"bb":m.ctx.drawImage(m.pieces,160,55,55,55,u,r,55,h);break;case"bn":m.ctx.drawImage(m.pieces,215,55,55,55,u,r,55,h);break;case"bp":m.ctx.drawImage(m.pieces,270,55,55,55,u,r,55,h);break}m.ctx.restore()}};b.myUp=function(m){var l,k,h=["a","b","c","d","e","f","g","h"],g,f,q,p,n=a.canvas.getBoundingClientRect(),o;if(c.active&&a.dragok){if(m.hasOwnProperty("clientX")){g=parseInt((m.clientY-n.top)/a.square_size,10);f=parseInt((m.clientX-n.left)/a.square_size,10);a.canvas.style.cursor="default"}else{if(m.hasOwnProperty("changedTouches")){g=parseInt((m.changedTouches[0].pageY-n.top)/a.square_size,10);f=parseInt((m.changedTouches[0].pageX-n.left)/a.square_size,10)}else{return}}if(!a.white_down){g=7-g;f=7-f}o=a.drag_piece;a.dragok=false;a.drag_piece="";a.left=0;a.top=0;a.piece_not_lifted=true;if(a.drag_clear_i>=8){l="piecebox"}else{l=h[a.drag_clear_j]+(8-a.drag_clear_i)}if(g>=8){k="piecebox"}else{k=h[f]+(8-g)}q=CHESS.engine.getArrayPosition(l);p=CHESS.engine.getArrayPosition(k);if(c.mode==="setup"){if(l!==k&&l!=="piecebox"&&k!=="piecebox"){c.position_array[p.substr(1,1)][p.substr(0,1)]=o;c.position_array[q.substr(1,1)][q.substr(0,1)]=""}else{if(l==="piecebox"&&k==="piecebox"){}else{if(l==="piecebox"){c.position_array[p.substr(1,1)][p.substr(0,1)]=o}else{if(k==="piecebox"){c.position_array[q.substr(1,1)][q.substr(0,1)]=""}}}}}else{c.move(l,k)}a.takeSnapshot();a.refresh()}};b.publish=function(f,g){this.visitSubscribers("publish",f,g)};b.visitSubscribers=function(l,g,k){var h=k||"any",m=this.subscribers[h],j,f=0;if(m!==undefined){f=m.length}for(j=0;j<f;j+=1){if(l==="publish"){m[j](g)}else{if(m[j]===g){m.splice(j,1)}}}};b.resize=function(f,g){var i=0,h=8;f=f||0;g=g||0;f=parseInt(f,10);g=parseInt(g,10);if(f===0||g===0){f=parseInt(window.getComputedStyle(a.canvas.parentNode,null).getPropertyValue("height"),10);g=parseInt(window.getComputedStyle(a.canvas.parentNode,null).getPropertyValue("width"),10)}i=(f<g?f:g);if(c.mode==="setup"){h=10}a.square_size=(f<g?parseInt(i/h,10):parseInt(i/8,10));a.canvas.height=a.square_size*h;a.canvas.width=a.square_size*8};c.move=function(g,f){var l={position_array:CHESS.engine.clonePositionArray(this.position_array),white_to_move:this.white_to_move,en_passant:this.en_passant,active:this.active,gs_castle_kside_w:this.gs_castle_kside_w,gs_castle_qside_w:this.gs_castle_qside_w,gs_castle_kside_b:this.gs_castle_kside_b,gs_castle_qside_b:this.gs_castle_qside_b},i={fen:CHESS.engine.getFEN(this),player_to_move:(this.white_to_move?"w":"b"),sq1:g,sq2:f,promote:false},k,j,h;if(this.last_move){l.last_move={sq1:this.last_move.sq1,sq2:this.last_move.sq2}}k=CHESS.engine.getArrayPosition(g);j=CHESS.engine.getArrayPosition(f);h=c.position_array[k.substr(1,1)][k.substr(0,1)].substr(1,1);if(h==="p"&&((c.white_to_move&&f.substr(1,1)==="8")||(!c.white_to_move&&f.substr(1,1)==="1"))){i.promote=true}if(!CHESS.engine.moveTemp(l,g,f)){a.takeSnapshot();a.refresh();return}b.publish(i,"move_before");this.position_array=CHESS.engine.clonePositionArray(l.position_array);this.white_to_move=l.white_to_move;this.en_passant=l.en_passant;this.active=l.active;this.gs_castle_kside_w=l.gs_castle_kside_w;this.gs_castle_qside_w=l.gs_castle_qside_w;this.gs_castle_kside_b=l.gs_castle_kside_b;this.gs_castle_qside_b=l.gs_castle_qside_b;this.moves+=1;if(l.last_move){this.last_move={sq1:l.last_move.sq1,sq2:l.last_move.sq2}}a.takeSnapshot();a.refresh();if(!this.active){return}};c.setPosition=function(f){CHESS.engine.setPosition(this,f)};a.buildHtml=function(f){this.canvas=document.createElement("canvas");this.canvas.className="chessboard";this.canvas.setAttribute("tabindex",0);this.ctx=this.canvas.getContext("2d");this.snapshot=document.createElement("canvas");if(f!==undefined){document.getElementById(f).appendChild(this.canvas)}};a.drawPiece=function(g,f,k){var i,h,j=1;this.snapshot_ctx.save();j=this.square_size/55;this.snapshot_ctx.scale(j,j);i=f/j;h=k/j;switch(g){case"wk":this.snapshot_ctx.drawImage(this.pieces,0,0,55,55,i,h,55,55);break;case"wq":this.snapshot_ctx.drawImage(this.pieces,55,0,55,55,i,h,55,55);break;case"wr":this.snapshot_ctx.drawImage(this.pieces,110,0,55,55,i,h,55,55);break;case"wb":this.snapshot_ctx.drawImage(this.pieces,160,0,55,55,i,h,55,55);break;case"wn":this.snapshot_ctx.drawImage(this.pieces,215,0,55,55,i,h,55,55);break;case"wp":this.snapshot_ctx.drawImage(this.pieces,270,0,55,55,i,h,55,55);break;case"bk":this.snapshot_ctx.drawImage(this.pieces,0,55,55,55,i,h,55,55);break;case"bq":this.snapshot_ctx.drawImage(this.pieces,55,55,55,55,i,h,55,55);break;case"br":this.snapshot_ctx.drawImage(this.pieces,110,55,55,55,i,h,55,55);break;case"bb":this.snapshot_ctx.drawImage(this.pieces,160,55,55,55,i,h,55,55);break;case"bn":this.snapshot_ctx.drawImage(this.pieces,215,55,55,55,i,h,55,55);break;case"bp":this.snapshot_ctx.drawImage(this.pieces,270,55,55,55,i,h,55,55);break}this.snapshot_ctx.restore()};a.drawSquare=function(l,r,p,f){var s=f||this.snapshot_ctx,q,o,j=1,i,g=parseInt(r/this.square_size,10),t=parseInt(p/this.square_size,10),m,h,n=parseInt(this.square_size/55*10,10),k=parseInt(this.square_size/55*7,10);if(l==="hover"){this.ctx.beginPath();if((g+t)%2===0){this.ctx.fillStyle=this.square_hover_light}else{this.ctx.fillStyle=this.square_hover_dark}this.ctx.rect(t*this.square_size,g*this.square_size,this.square_size,this.square_size);this.ctx.fill()}else{i=(l==="light"?this.square_light:this.square_dark);this.snapshot_ctx.save();j=this.square_size/55;this.snapshot_ctx.scale(j,j);q=r/j;o=p/j;this.snapshot_ctx.drawImage(i,0,0,55,55,q,o,55,55);this.snapshot_ctx.restore()}if(t===7||g===0){h=parseInt(this.square_size/55*11,10),this.snapshot_ctx.font=h+"px arial";this.snapshot_ctx.fillStyle=(((7-t)+g)%2===0?this.square_color_light:this.square_color_dark);if(g===0){if(this.white_down){m=8-t}else{m=t+1}this.snapshot_ctx.fillText(m,2,(t*this.square_size)+n)}if(t===7){if(this.white_down){m=String.fromCharCode(g+97)}else{m=String.fromCharCode((7-g)+97)}this.snapshot_ctx.fillText(m,((this.square_size*g)+this.square_size)-k,(this.square_size*8)-2)}}};a.refresh=function(){this.ctx.clearRect(0,this.square_size*8,this.square_size*8,this.square_size*2);this.ctx.drawImage(this.snapshot,0,0)};a.takeSnapshot=function(){var g,f,p,k,o,n,l,h,r,q=8,m;if(c.mode==="setup"){q=10}this.snapshot.width=this.square_size*8;this.snapshot.height=this.square_size*q;this.snapshot_ctx=this.snapshot.getContext("2d");if(this.square_light.src===""){this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=this.square_color_light;this.snapshot_ctx.rect(0,0,this.square_size*8,this.square_size*8);this.snapshot_ctx.fill()}else{for(n=0;n<8;n+=1){for(o=0;o<8;o+=1){if((o+n)%2===0){l=o*this.square_size;h=n*this.square_size;this.drawSquare("light",l,h)}}}}for(n=0;n<8;n+=1){for(o=0;o<8;o+=1){if((o+n)%2!==0){l=o*this.square_size;h=n*this.square_size;if(this.square_dark.src===""){this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=this.square_color_dark;this.snapshot_ctx.rect(l,h,this.square_size,this.square_size);this.snapshot_ctx.fill()}else{this.drawSquare("dark",l,h)}}}}if(this.highlight_move){if(typeof c.last_move==="object"&&c.last_move.sq1!==undefined){o=c.last_move.sq1.substr(0,1);n=c.last_move.sq1.substr(1,1);if(!this.white_down){o=7-o;n=7-n}this.snapshot_ctx.lineWidth=2;this.snapshot_ctx.strokeStyle="#ff8d8d";this.snapshot_ctx.strokeRect(o*this.square_size,n*this.square_size,this.square_size,this.square_size);o=c.last_move.sq2.substr(0,1);n=c.last_move.sq2.substr(1,1);if(!this.white_down){o=7-o;n=7-n}this.snapshot_ctx.strokeRect(o*this.square_size,n*this.square_size,this.square_size,this.square_size)}}for(g=0;g<8;g+=1){for(f=0;f<8;f+=1){if(!this.dragok||!(g===this.drag_clear_i&&f===this.drag_clear_j)){r=c.position_array[g][f].substr(0,2);p=g;k=f;if(!this.white_down){p=7-g;k=7-f}o=k*this.square_size;n=p*this.square_size;if(r!==""){this.drawPiece(r,o,n)}}}}if(c.mode==="setup"){for(g=0;g<2;g+=1){for(f=0;f<8;f+=1){r=c.piecebox_array[g][f].substr(0,2);o=f*this.square_size;n=(g+8)*this.square_size;if(r!==""){this.drawPiece(r,o,n)}}}}if(this.dragok){g=this.drag_clear_i;f=this.drag_clear_j;if(!this.white_down){g=7-this.drag_clear_i;f=7-this.drag_clear_j}m=(g+f)%2===0;if(m){if(this.square_light.src!==""){this.drawSquare("light",f*this.square_size,g*this.square_size,this.ctx)}else{this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=this.square_color_light;this.snapshot_ctx.rect(f*this.square_size,g*this.square_size,this.square_size,this.square_size);this.snapshot_ctx.fill()}}else{if(this.square_dark.src!==""){this.drawSquare("dark",f*this.square_size,g*this.square_size,this.ctx)}else{this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=this.square_color_dark;this.snapshot_ctx.rect(f*this.square_size,g*this.square_size,this.square_size,this.square_size);this.snapshot_ctx.fill()}}}};this.display=function(){a.takeSnapshot();a.refresh()};this.flip=function(){a.white_down=!a.white_down;a.takeSnapshot();a.refresh()};this.getActiveColor=function(){return(c.white_to_move?"w":"b")};this.getFEN=function(){return CHESS.engine.getFEN(c)};this.getCanvas=function(){return a.canvas};this.move=function(g){var i,h,f;i=CHESS.engine.getLongNotation(c,g);i=i.split("-");h=i[0];f=i[1];c.move(h,f)};this.positionClear=function(){c.position_array=[["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""]];c.last_move={};c.en_passant="";c.white_to_move=true;c.gs_castle_kside_w=true;c.gs_castle_qside_w=true;c.gs_castle_kside_b=true;c.gs_castle_qside_b=true;c.moves=0;a.takeSnapshot();a.refresh()};this.positionStart=function(){c.position_array=[["br","bn","bb","bq","bk","bb","bn","br"],["bp","bp","bp","bp","bp","bp","bp","bp"],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["wp","wp","wp","wp","wp","wp","wp","wp"],["wr","wn","wb","wq","wk","wb","wn","wr"]];c.last_move={};c.en_passant="";c.white_to_move=true;c.gs_castle_kside_w=true;c.gs_castle_qside_w=true;c.gs_castle_kside_b=true;c.gs_castle_qside_b=true;c.moves=0;a.takeSnapshot();a.refresh()};this.resize=function(f,g){b.resize(f,g);a.takeSnapshot();a.refresh()};this.setActive=function(f){c.active=(f===true)};this.setLastMove=function(g,f){g=CHESS.engine.getArrayPosition(g);f=CHESS.engine.getArrayPosition(f);c.last_move={sq1:g,sq2:f}};this.setMode=function(f){c.mode=f;if(f==="setup"){c.active=true}b.resize(a.canvas.height,a.canvas.width);a.takeSnapshot();a.refresh()};this.setPosition=function(f){c.setPosition(f);a.takeSnapshot();a.refresh()};this.subscribe=function(g,f){f=f||"any";if(b.subscribers[f]===undefined){b.subscribers[f]=[]}b.subscribers[f].push(g)};this.unsubscribe=function(g,f){b.visitSubscribers("unsubscribe",g,f)};e=function(){a.buildHtml(d.container);a.canvas.onmousedown=b.myDown;a.canvas.onmouseup=b.myUp;a.canvas.onmousemove=b.myMove;a.canvas.addEventListener("touchstart",b.myDown,false);a.canvas.addEventListener("touchend",b.myUp,false);a.canvas.addEventListener("touchmove",b.myMove,false);a.canvas.addEventListener("touchleave",b.myCancel,false);a.canvas.addEventListener("touchcancel",b.myCancel,false);a.highlight_move=(d.highlight_move===true?true:false);a.highlight_hover=(d.highlight_hover===true?true:false);a.show_row_col_labels=(d.show_row_col_labels===false?false:true);a.square_color_light=(d.square_color_light?d.square_color_light:a.square_color_light);a.square_color_dark=(d.square_color_dark?d.square_color_dark:a.square_color_dark);a.square_hover_light=(d.square_hover_light?d.square_hover_light:a.square_hover_light);a.square_hover_dark=(d.square_hover_dark?d.square_hover_dark:a.square_hover_dark);c.mode=d.mode;c.active=true;if(d.fen){c.setPosition(d.fen)}else{c.setPosition("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")}b.resize(d.height,d.width);a.pieces.src=CHESS.config.library_path+"/img/pieces.png";a.pieces.onload=function(){a.takeSnapshot();a.refresh()};if(typeof d.square_dark==="string"){a.square_dark.src=d.square_dark;a.square_dark.onload=function(){a.takeSnapshot();a.refresh()}}if(typeof d.square_light==="string"){a.square_light.src=d.square_light;a.square_light.onload=function(){a.takeSnapshot();a.refresh()}}};e()};
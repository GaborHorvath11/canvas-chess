var CHESS=CHESS||{};CHESS.config={library_path:"canvaschess"};CHESS.nag_code={"0":"","1":"!","2":"?","3":"!!","4":"??","5":"!?","6":"?!","10":"="};CHESS.hexToRgb=function(c){var b=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;c=c.replace(b,function(e,h,f,d){return h+h+f+f+d+d});var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(c);return a?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16)}:null};
CHESS.engine={};CHESS.engine.createPosition=function(c){var a=function(){var m="",p=[],l=[],g={},h="",n=true,q=true,j=true,o=true,f=true,k=false,e=0};var d=function(){};d.prototype=a;var b=new d();if(c!==undefined){this.setPosition(b,c)}return b};CHESS.engine.setPosition=function(q,e){var m,o,a,p=[],b="",c=0,g="",r="",d="",n=["a","b","c","d","e","f","g","h"],l=0,h=0,f=0;m=e.split(" ");o=m[0];a=m[2];p=o.split("/");q.en_passant=m[3];q.white_to_move=(m[1]==="w");if(a==="-"){q.gs_castle_kside_w=false;q.gs_castle_qside_w=false;q.gs_castle_kside_b=false;q.gs_castle_qside_b=false}else{if(a.indexOf("K")>=0){q.gs_castle_kside_w=true}if(a.indexOf("Q")>=0){q.gs_castle_qside_w=true}if(a.indexOf("k")>=0){q.gs_castle_kside_b=true}if(a.indexOf("q")>=0){q.gs_castle_qside_b=true}}q.position_array=[["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"]];q.piecebox_array=[["-","wk","wq","wr","wb","wn","wp","-"],["-","bk","bq","br","bb","bn","bp","-"]];q.moves=0;q.last_move={};for(l=0;l<p.length;l+=1){for(h=0;h<p[l].length;h+=1){b=p[l].charAt(h);for(f=0;f<q.position_array[l].length;f+=1){if(q.position_array[l][f]==="-"){c=f;f=q.position_array[l].length}}if(/[0-9]/.test(b)){for(f=0;f<parseInt(b,10);f+=1){q.position_array[l][f+c]=""}}else{g="w";if(/[a-z]/.test(b)){g="b"}r=b.toLowerCase();d="";if(r==="p"){d=n[c]}q.position_array[l][c]=g+r+d}}}};CHESS.engine.getFEN=function(l){var g=[],h,a="",b="",k=[],d="",m="",f=0,e=0,c=0;for(f=0;f<l.position_array.length;f+=1){k[f]="";for(e=0;e<l.position_array[f].length;e+=1){m=l.position_array[f][e];if(m===""){c+=1}else{if(c>0){k[f]+=(c+"");c=0}d=m.substr(0,1);m=m.substr(1,1);if(d==="w"){m=m.toUpperCase()}k[f]+=m}}if(c>0){k[f]+=(c+"");c=0}}h=k.join("/");g.push(h);g.push(l.white_to_move?"w":"b");a="-";if(l.gs_castle_kside_w||l.gs_castle_qside_w||l.gs_castle_kside_b||l.gs_castle_qside_b){if(l.gs_castle_kside_w){a+="K"}if(l.gs_castle_qside_w){a+="Q"}if(l.gs_castle_kside_b){a+="k"}if(l.gs_castle_qside_b){a+="q"}}g.push(a);b=(l.en_passant===""?"-":l.en_passant);g.push(b);g.push("0 1");return g.join(" ")};CHESS.engine.isLegal=function(k,c,a){var t,n,m,v,f,u,e,l,p,q,r,h,b,d,g,o,s,j;n=this.getArrayPosition(c);m=this.getArrayPosition(a);if(!n||!m){return false}v=parseInt(n.substr(0,1));f=parseInt(n.substr(1,1));u=parseInt(m.substr(0,1));e=parseInt(m.substr(1,1));l=k.position_array[f][v];p=k.position_array[e][u];q=l.substr(1,1);r=l.substr(0,1);h=false;if((k.white_to_move&&r==="b")||(!k.white_to_move&&r==="w")){return false}if(p.substr(0,1)===l.substr(0,1)){return false}if(q==="p"){if(f===e){return false}if((r==="w"&&e>f)||(r==="b"&&e<f)){return false}if(!(Math.abs(f-e)===1||(Math.abs(f-e)===2&&((r==="w"&&f===6&&k.position_array[5][v]==="")||(r==="b"&&f===1&&k.position_array[2][v]===""))))){return false}if(Math.abs(v-u)===0&&k.position_array[e][u]!==""){return false}if(Math.abs(v-u)>0){b=(p.substr(0,1)!==""&&p.substr(0,1)!==r);h=k.en_passant===this.reverseArrayPosition(e+""+u);if(!(Math.abs(v-u)===1&&Math.abs(f-e)===1&&(b||h))){return false}}}if(q==="k"){if(Math.abs(v-u)===2){if(r==="w"){if(a==="g1"&&k.gs_castle_kside_w&&k.position_array[7][5]===""&&k.position_array[7][6]===""){if(this.isSquareAttacked(k.position_array,4,7,"w")){return false}if(this.isSquareAttacked(k.position_array,5,7,"w")){return false}if(this.isSquareAttacked(k.position_array,6,7,"w")){return false}}else{if(a==="c1"&&k.gs_castle_qside_w&&k.position_array[7][1]===""&&k.position_array[7][2]===""&&k.position_array[7][3]===""){if(this.isSquareAttacked(k.position_array,2,7,"w")){return false}if(this.isSquareAttacked(k.position_array,3,7,"w")){return false}if(this.isSquareAttacked(k.position_array,4,7,"w")){return false}}else{return false}}}else{if(r==="b"){if(a==="g8"&&k.gs_castle_kside_b&&k.position_array[0][5]===""&&k.position_array[0][6]===""){if(this.isSquareAttacked(k.position_array,4,0,"b")){return false}if(this.isSquareAttacked(k.position_array,5,0,"b")){return false}if(this.isSquareAttacked(k.position_array,6,0,"b")){return false}}else{if(a==="c8"&&k.gs_castle_qside_b&&k.position_array[0][1]===""&&k.position_array[0][2]===""&&k.position_array[0][3]===""){if(this.isSquareAttacked(k.position_array,2,0,"b")){return false}if(this.isSquareAttacked(k.position_array,3,0,"b")){return false}if(this.isSquareAttacked(k.position_array,4,0,"b")){return false}}else{return false}}}}}else{if(!(Math.abs(v-u)<2&&Math.abs(f-e)<2)){return false}}}if(q==="n"&&!((Math.abs(v-u)===1&&Math.abs(f-e)===2)||(Math.abs(v-u)===2&&Math.abs(f-e)===1))){return false}if(q==="r"){if(v!==u&&f!==e){return false}}if(q==="b"){if(Math.abs(v-u)!==Math.abs(f-e)){return false}}if(q==="q"){if((Math.abs(v-u)!==Math.abs(f-e))&&(v!==u&&f!==e)){return false}}if(q==="q"||q==="b"||q==="r"){t=0;d=v-u;g=f-e;o=0;s=0;if(d<0){o=1}else{if(d>0){o=-1}}if(g<0){s=1}else{if(g>0){s=-1}}t=1;while(!(parseInt(v)+t*o===u&&parseInt(f)+t*s===e)){if(t>8){break}if(k.position_array[parseInt(f)+t*s][parseInt(v)+t*o]!==""){return false}t+=1}}j=this.clonePositionArray(k.position_array);j[m.substr(1,1)][m.substr(0,1)]=j[n.substr(1,1)][n.substr(0,1)];j[n.substr(1,1)][n.substr(0,1)]="";if(h){j[n.substr(1,1)][m.substr(0,1)]=""}if(this.isCheck(j,r)){return false}return true};CHESS.engine.isCheck=function(f,e){var d,b,c=0,a=0;for(d=0;d<8;d++){for(b=0;b<8;b++){if(f[d][b]===e+"k"){c=b;a=d}}}if(this.isSquareAttacked(f,c,a,e)){return true}return false};CHESS.engine.isMate=function(h){var v,t,q=(h.white_to_move?"w":"b"),p=0,n=0,s,u,r,o,c=this.clonePositionArray(h.position_array);for(v=0;v<8;v++){for(t=0;t<8;t++){if(c[v][t]===q+"k"){p=t;n=v}}}s=this.getAttacker(c,p,n,q);if(s===""){return false}c[n][p]="";if(n>0){if(c[n-1][p].substr(0,1)!==q){if(!this.isSquareAttacked(c,p,n-1,q)){return false}}}if(n<7){if(c[n+1][p].substr(0,1)!==q){if(!this.isSquareAttacked(c,p,n+1,q)){return false}}}if(p>0){if(c[n][p-1].substr(0,1)!==q){if(!this.isSquareAttacked(c,p-1,n,q)){return false}}}if(p<7){if(c[n][p+1].substr(0,1)!==q){if(!this.isSquareAttacked(c,p+1,n,q)){return false}}}if(p>0&&n>0){if(c[n-1][p-1].substr(0,1)!==q){if(!this.isSquareAttacked(c,p-1,n-1,q)){return false}}}if(p<7&&n>0){if(c[n-1][p+1].substr(0,1)!==q){if(!this.isSquareAttacked(c,p+1,n-1,q)){return false}}}if(p>0&&n<7){if(c[n+1][p-1].substr(0,1)!==q){if(!this.isSquareAttacked(c,p-1,n+1,q)){return false}}}if(p<7&&n<7){if(c[n+1][p+1].substr(0,1)!==q){if(!this.isSquareAttacked(c,p+1,n+1,q)){return false}}}c[n][p]=q+"k";u=parseInt(s.substr(1,1));r=parseInt(s.substr(0,1));var l="b";if(q==="b"){l="w"}o=this.getAttacker(c,r,u,l);if(o!==""){var f=this.reverseArrayPosition(o);var d=this.reverseArrayPosition(s);if(this.isLegal(h,f,d)){return false}}var k=c[r][u].substr(1,1);if(k==="r"||k==="b"||k==="q"){if(Math.abs(p-u)>1||Math.abs(n-r)>1){var x=u-p;var e=r-n;var g=0;var m=0;if(x>0){g=1}if(e>0){m=1}if(x<0){g=-1}if(e<0){m=-1}var y=p+g,w=n+m;c[n][p]=l+"k";while(y!==u||w!==r){if(this.isSquareBlockable(c,y,w,l)){return false}y+=g;w+=m}}}if(k==="p"){if(q==="w"&&r===3&&h.en_passant===this.reverseArrayPosition((r-1)+""+u)){if(u>0&&c[3][u-1].substr(0,2)==="wp"){return false}if(u<7&&c[3][u+1].substr(0,2)==="wp"){return false}}if(q==="b"&&r===4&&h.en_passant===this.reverseArrayPosition((r+1)+""+u)){if(u>0&&c[4][u-1].substr(0,2)==="bp"){return false}if(u<7&&c[4][u+1].substr(0,2)==="bp"){return false}}}return true};CHESS.engine.isSquareAttacked=function(e,c,b,d){var a;c=parseInt(c);b=parseInt(b);if(b>0&&c>1&&e[b-1][c-2].substr(1,1)==="n"&&e[b-1][c-2].substr(0,1)!==d){return true}if(b>0&&c<6&&e[b-1][c+2].substr(1,1)==="n"&&e[b-1][c+2].substr(0,1)!==d){return true}if(b<7&&c>1&&e[b+1][c-2].substr(1,1)==="n"&&e[b+1][c-2].substr(0,1)!==d){return true}if(b<7&&c<6&&e[b+1][c+2].substr(1,1)==="n"&&e[b+1][c+2].substr(0,1)!==d){return true}if(b>1&&c>0&&e[b-2][c-1].substr(1,1)==="n"&&e[b-2][c-1].substr(0,1)!==d){return true}if(b>1&&c<7&&e[b-2][c+1].substr(1,1)==="n"&&e[b-2][c+1].substr(0,1)!==d){return true}if(b<6&&c>0&&e[b+2][c-1].substr(1,1)==="n"&&e[b+2][c-1].substr(0,1)!==d){return true}if(b<6&&c<7&&e[b+2][c+1].substr(1,1)==="n"&&e[b+2][c+1].substr(0,1)!==d){return true}i=1;while(c+i<8){a=e[b][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0){a=e[b][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(b-i>=0){a=e[b-i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(b+i<8){a=e[b+i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c+i<8&&b-i>=0){a=e[b-i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c+i<8&&b+i<8){a=e[b+i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b+i<8){a=e[b+i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b-i>=0){a=e[b-i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}if(d==="w"){if(c-1>=0&&b-1>=0){a=e[b-1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}if(c+1<8&&b-1>=0){a=e[b-1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}}else{if(c-1>=0&&b+1<8){a=e[b+1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}if(c+1<8&&b+1<8){a=e[b+1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}}return false};CHESS.engine.isSquareBlockable=function(d,e,c,b){var a;e=parseInt(e);c=parseInt(c);if(c>0&&e>1&&d[c-1][e-2].substr(1,1)==="n"&&d[c-1][e-2].substr(0,1)!==b){return true}if(c>0&&e<6&&d[c-1][e+2].substr(1,1)==="n"&&d[c-1][e+2].substr(0,1)!==b){return true}if(c<7&&e>1&&d[c+1][e-2].substr(1,1)==="n"&&d[c+1][e-2].substr(0,1)!==b){return true}if(c<7&&e<6&&d[c+1][e+2].substr(1,1)==="n"&&d[c+1][e+2].substr(0,1)!==b){return true}if(c>1&&e>0&&d[c-2][e-1].substr(1,1)==="n"&&d[c-2][e-1].substr(0,1)!==b){return true}if(c>1&&e<7&&d[c-2][e+1].substr(1,1)==="n"&&d[c-2][e+1].substr(0,1)!==b){return true}if(c<6&&e>0&&d[c+2][e-1].substr(1,1)==="n"&&d[c+2][e-1].substr(0,1)!==b){return true}if(c<6&&e<7&&d[c+2][e+1].substr(1,1)==="n"&&d[c+2][e+1].substr(0,1)!==b){return true}i=1;while(e+i<8){a=d[c][e+i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(e-i>=0){a=d[c][e-i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0){a=d[c-i][e];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(c+i<8){a=d[c+i][e];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(e+i<8&&c-i>=0){a=d[c-i][e+i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}i=1;while(e+i<8&&c+i<8){a=d[c+i][e+i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}i=1;while(e-i>=0&&c+i<8){a=d[c+i][e-i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}i=1;while(e-i>=0&&c-i>=0){a=d[c-i][e-i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}if(b==="w"){if(c-1>=0){a=d[c-1][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}if(c===3&&d[2][e]===""){a=d[1][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}}else{if(c+1<8){a=d[c+1][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}if(c===4&&d[5][e]===""){a=d[6][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}}return false};CHESS.engine.getAttacker=function(e,c,b,d){var a;c=parseInt(c);b=parseInt(b);if(b>0&&c>1&&e[b-1][c-2].substr(1,1)==="n"&&e[b-1][c-2].substr(0,1)!==d){return(b-1)+""+(c-2)}if(b>0&&c<6&&e[b-1][c+2].substr(1,1)==="n"&&e[b-1][c+2].substr(0,1)!==d){return(b-1)+""+(c+2)}if(b<7&&c>1&&e[b+1][c-2].substr(1,1)==="n"&&e[b+1][c-2].substr(0,1)!==d){return(b+1)+""+(c-2)}if(b<7&&c<6&&e[b+1][c+2].substr(1,1)==="n"&&e[b+1][c+2].substr(0,1)!==d){return(b+1)+""+(c+2)}if(b>1&&c>0&&e[b-2][c-1].substr(1,1)==="n"&&e[b-2][c-1].substr(0,1)!==d){return(b-2)+""+(c-1)}if(b>1&&c<7&&e[b-2][c+1].substr(1,1)==="n"&&e[b-2][c+1].substr(0,1)!==d){return(b-2)+""+(c+1)}if(b<6&&c>0&&e[b+2][c-1].substr(1,1)==="n"&&e[b+2][c-1].substr(0,1)!==d){return(b+2)+""+(c-1)}if(b<6&&c<7&&e[b+2][c+1].substr(1,1)==="n"&&e[b+2][c+1].substr(0,1)!==d){return(b+2)+""+(c+1)}i=1;while(c+i<8){a=e[b][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b)+""+(c+i)}if(a!==""){break}i+=1}i=1;while(c-i>=0){a=e[b][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b)+""+(c-i)}if(a!==""){break}i+=1}i=1;while(b-i>=0){a=e[b-i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b-i)+""+(c)}if(a!==""){break}i+=1}i=1;while(b+i<8){a=e[b+i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b+i)+""+(c)}if(a!==""){break}i+=1}i=1;while(c+i<8&&b-i>=0){a=e[b-i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b-i)+""+(c+i)}if(a!==""){break}i+=1}i=1;while(c+i<8&&b+i<8){a=e[b+i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b+i)+""+(c+i)}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b+i<8){a=e[b+i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b+i)+""+(c-i)}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b-i>=0){a=e[b-i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b-i)+""+(c-i)}if(a!==""){break}i+=1}if(d==="w"){if(c-1>0&&b-1>=0){a=e[b-1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b-1)+""+(c-1)}}if(c+1<8&&b-1>=0){a=e[b-1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b-1)+""+(c+1)}}}else{if(c-1>=0&&b+1<8){a=e[b+1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b+1)+""+(c-1)}}if(c+1<8&&b+1<8){a=e[b+1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b+1)+""+(c+1)}}}return""};CHESS.engine.isStalemate=function(b){var a=!this.getLegalMoves(b,true);return a};CHESS.engine.getLegalMoves=function(n,h){var g,f,l,k,d="",m=[],e=(n.white_to_move?"w":"b"),c,b=0,a;for(g=0;g<8;g++){for(f=0;f<8;f++){l=this.reverseArrayPosition(g+""+f);if(n.position_array[g][f]===e+"k"){if(g>0){k=this.reverseArrayPosition((g-1)+""+f);d=l+"-"+k;m.push(d)}if(g>0&&f<7){k=this.reverseArrayPosition((g-1)+""+(f+1));d=l+"-"+k;m.push(d)}if(f<7){k=this.reverseArrayPosition(g+""+(f+1));d=l+"-"+k;m.push(d)}if(g<7&&f<7){k=this.reverseArrayPosition((g+1)+""+(f+1));d=l+"-"+k;m.push(d)}if(g<7){k=this.reverseArrayPosition((g+1)+""+f);d=l+"-"+k;m.push(d)}if(g<7&&f>0){k=this.reverseArrayPosition((g+1)+""+(f-1));d=l+"-"+k;m.push(d)}if(f>0){k=this.reverseArrayPosition(g+""+(f-1));d=l+"-"+k;m.push(d)}if(g>0&&f>0){k=this.reverseArrayPosition((g-1)+""+(f-1));d=l+"-"+k;m.push(d)}}if(n.position_array[g][f].substr(0,2)===e+"p"){c=(e==="w"?-1:1);k=this.reverseArrayPosition((g+c)+""+f);d=l+"-"+k;m.push(d);if((e==="w"&&g===6)||(e==="b"&&g===1)){k=this.reverseArrayPosition((g+(c*2))+""+f);d=l+"-"+k;m.push(d)}if(/[a-h][1-8]/.test(n.en_passant)){a=parseInt(this.getArrayPosition(n.en_passant).substr(0,1),10)}if(e==="w"&&g===3){if(a===(f-1)){k=this.reverseArrayPosition((g-1)+""+(f-1));d=l+"-"+k;m.push(d)}if(a===(f+1)){k=this.reverseArrayPosition((g-1)+""+(f+1));d=l+"-"+k;m.push(d)}}if(e==="b"&&g===4){if(a===(f-1)){k=this.reverseArrayPosition((g+1)+""+(f-1));d=l+"-"+k;m.push(d)}if(a===(f+1)){k=this.reverseArrayPosition((g+1)+""+(f+1));d=l+"-"+k;m.push(d)}}}if(n.position_array[g][f]===e+"q"){b=1;while(g-b>=0){k=this.reverseArrayPosition((g-b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(g-b>=0&&f+b<=7){k=this.reverseArrayPosition((g-b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7){k=this.reverseArrayPosition(g+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7&&g+b<=7){k=this.reverseArrayPosition((g+b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7){k=this.reverseArrayPosition((g+b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7&&f-b>=0){k=this.reverseArrayPosition((g+b)+""+(f-b));d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0){k=this.reverseArrayPosition(g+""+(f-b));d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0&&g-b>=0){k=this.reverseArrayPosition((g-b)+""+(f-b));d=l+"-"+k;m.push(d);b++}}if(n.position_array[g][f]===e+"r"){b=1;while(g-b>=0){k=this.reverseArrayPosition((g-b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7){k=this.reverseArrayPosition(g+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7){k=this.reverseArrayPosition((g+b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0){k=this.reverseArrayPosition(g+""+(f-b));d=l+"-"+k;m.push(d);b++}}if(n.position_array[g][f]===e+"b"){b=1;while(g-b>=0&&f+b<=7){k=this.reverseArrayPosition((g-b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7&&g+b<=7){k=this.reverseArrayPosition((g+b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7&&f-b>=0){k=this.reverseArrayPosition((g+b)+""+(f-b));d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0&&g-b>=0){k=this.reverseArrayPosition((g-b)+""+(f-b));d=l+"-"+k;m.push(d);b++}}if(n.position_array[g][f]===e+"n"){if(g>=2&&f<=6){k=this.reverseArrayPosition((g-2)+""+(f+1));d=l+"-"+k;m.push(d)}if(g>=1&&f<=5){k=this.reverseArrayPosition((g-1)+""+(f+2));d=l+"-"+k;m.push(d)}if(g<=6&&f<=5){k=this.reverseArrayPosition((g+1)+""+(f+2));d=l+"-"+k;m.push(d)}if(g<=5&&f<=6){k=this.reverseArrayPosition((g+2)+""+(f+1));d=l+"-"+k;m.push(d)}if(g<=5&&f>=1){k=this.reverseArrayPosition((g+2)+""+(f-1));d=l+"-"+k;m.push(d)}if(g<=6&&f>=2){k=this.reverseArrayPosition((g+1)+""+(f-2));d=l+"-"+k;m.push(d)}if(g>=1&&f>=2){k=this.reverseArrayPosition((g-1)+""+(f-2));d=l+"-"+k;m.push(d)}if(g>=2&&f>=1){k=this.reverseArrayPosition((g-2)+""+(f-1));d=l+"-"+k;m.push(d)}}}}for(g=0;g<m.length;g++){l=m[g].split("-")[0];k=m[g].split("-")[1];if(!this.isLegal(n,l,k)){m.splice(g,1);g--}else{if(h){return true}}}if(h){return false}return m};CHESS.engine.getLongNotation=function(l,a){var e,d,b="",k,h=a.replace(/[#+=xKQRBN]/g,""),c=(l.white_to_move?"w":"b"),m=a.substring(0,1),g="",f="";if(a==="O-O"){if(c==="w"){return"e1-g1"}else{return"e8-g8"}}else{if(a==="O-O-O"){if(c==="w"){return"e1-c1"}else{return"e8-c8"}}}if(h.length===3){g=h.substr(0,1);h=h.substr(h.length-2,2);if(/[0-9]/.test(g)){f="rank"}else{if(/[a-z]/.test(g)){g=g.charCodeAt(0)-97;f="file"}}}if(m!=="K"&&m!=="Q"&&m!=="W"&&m!=="R"&&m!=="B"&&m!=="N"){m="p"}m=m.toLowerCase();for(e=0;e<8;e++){for(d=0;d<8;d++){if(f==="rank"&&parseInt(g)!==(8-e)){continue}else{if(f==="file"&&parseInt(g)!==d){continue}}if(l.position_array[e][d].length>1&&l.position_array[e][d].substr(0,2)===c+m){k=this.reverseArrayPosition(e+""+d);if(this.isLegal(l,k,h)){b=k+"-"+h}}}}return b};CHESS.engine.getArrayPosition=function(b){var a,d,c=false;if(/[a-h][1-8]/.test(b)){a=b.substr(0,1).toLowerCase();d=b.substr(1,1);a=a.charCodeAt(0)-97;d=8-d;c=a+""+d}return c};CHESS.engine.reverseArrayPosition=function(b){var a=parseInt(b.substr(1,1)),c=parseInt(b.substr(0,1));a=String.fromCharCode(a+97);c=8-c;return a+""+c};CHESS.engine.clonePositionArray=function(b){var a=0,c=[];for(a=0;a<8;a+=1){c[a]=b[a].slice(0)}return c};CHESS.engine.moveTemp=function(m,b,a){var q,p,f,e,d,o,c,n,s,r,h,g,w,l,v,k,u,t="",j;if(!this.isLegal(m,b,a)){return false}m.last_move={sq1:this.getArrayPosition(b),sq2:this.getArrayPosition(a)};if(m.white_to_move){q=b;p=a;f=this.getArrayPosition(q);e=this.getArrayPosition(p);d=parseInt(f.substr(0,1));o=parseInt(f.substr(1,1));c=parseInt(e.substr(0,1));n=parseInt(e.substr(1,1));t=m.position_array[n][c];j=m.position_array[o][d];m.position_array[n][c]=m.position_array[o][d];m.position_array[o][d]="";f=this.getArrayPosition(q);if(j.substr(0,2)==="wp"&&n-o===-2){m.en_passant=this.reverseArrayPosition((n+1)+""+c)}else{m.en_passant=""}if(j.substr(0,2)==="wp"&&c!==d&&t===""){m.position_array[o][c]="";u=p.substr(0,1)+q.substr(1,1)}if(j.substr(0,2)==="wp"&&n===0){m.position_array[n][c]="wq"}if(j==="wk"&&q==="e1"){if(p==="g1"){m.position_array[7][5]="wrk";m.position_array[7][7]=""}else{if(p==="c1"){m.position_array[7][3]="wrq";m.position_array[7][0]=""}}}if(j==="wk"){m.gs_castle_kside_w=false;m.gs_castle_qside_w=false}else{if(j==="wr"&&q==="h1"){m.gs_castle_kside_w=false}else{if(j==="wr"&&q==="a1"){m.gs_castle_qside_w=false}else{if(t==="br"&&p==="a8"){m.gs_castle_qside_b=false}else{if(t==="br"&&p==="h8"){m.gs_castle_kside_b=false}}}}}m.white_to_move=false}else{s=b;r=a;h=this.getArrayPosition(s);g=this.getArrayPosition(r);w=parseInt(h.substr(0,1));l=parseInt(h.substr(1,1));v=parseInt(g.substr(0,1));k=parseInt(g.substr(1,1));t=m.position_array[k][v];j=m.position_array[l][w];m.position_array[k][v]=m.position_array[l][w];m.position_array[l][w]="";h=this.getArrayPosition(s);if(j.substr(0,2)==="bp"&&k-l===2){m.en_passant=this.reverseArrayPosition((k-1)+""+v)}else{m.en_passant=""}if(j.substr(0,2)==="bp"&&v!==w&&t===""){m.position_array[l][v]="";u=r.substr(0,1)+s.substr(1,1)}if(j.substr(0,2)==="bp"&&k===7){m.position_array[k][v]="bq"}if(j==="bk"&&s==="e8"){if(r==="g8"){m.position_array[0][5]="brk";m.position_array[0][7]=""}else{if(r==="c8"){m.position_array[0][3]="brq";m.position_array[0][0]=""}}}if(j==="bk"){m.gs_castle_kside_b=false;m.gs_castle_qside_b=false}else{if(j==="br"&&s==="h8"){m.gs_castle_kside_b=false}else{if(j==="br"&&s==="a8"){m.gs_castle_qside_b=false}else{if(t==="wr"&&r==="a1"){m.gs_castle_qside_w=false}else{if(t==="wr"&&r==="h1"){m.gs_castle_kside_w=false}}}}}m.white_to_move=true}if(this.isMate(m)||this.isStalemate(m)){m.active=false}return true};
CHESS.Board=function(d){var e,b={subscribers:{any:[]}},c=CHESS.engine.createPosition(),a={container:null,canvas:null,ctx:null,snapshot:null,snapshot_ctx:null,snapshot_img:new Image(),square_size:80,square_color_light:"#ececd7",square_color_dark:"#7389b6",square_hover_light:"#b4d990",square_hover_dark:"#85c249",square_light:new Image(),square_dark:new Image(),dragok:false,drag_piece:"",drag_clear_i:0,drag_clear_j:0,left:0,top:0,last_draw_left:0,last_draw_top:0,piece_not_lifted:true,white_down:true,highlight_move:false,highlight_move_color:"#FF0000",highlight_move_alpha:"0.5",highlight_hover:false,show_row_col_labels:true,wp:new Image(),wr:new Image(),wn:new Image(),wb:new Image(),wq:new Image(),wk:new Image(),bp:new Image(),br:new Image(),bn:new Image(),bb:new Image(),bq:new Image(),bk:new Image()};b.myCancel=function(f){f.preventDefault();a.dragok=false;a.drag_piece="";a.left=0;a.top=0;a.takeSnapshot();a.refresh()};b.myDown=function(m){var g,f,h,l,k=a.canvas.getBoundingClientRect();if(c.active){if(m.hasOwnProperty("clientX")){a.left=m.clientX-k.left;a.top=m.clientY-k.top;a.canvas.style.cursor="move"}else{if(m.hasOwnProperty("changedTouches")){a.left=m.changedTouches[0].pageX-k.left;a.top=m.changedTouches[0].pageY-k.top}else{return}}g=parseInt(a.top/a.square_size,10);f=parseInt(a.left/a.square_size,10);if(!a.white_down){g=7-g;f=7-f}if(g<8){h=c.position_array[g][f]}else{if(c.mode==="setup"){h=c.piecebox_array[g-8][f]}}l=h.substr(0,1);if(c.mode!=="setup"&&((c.white_to_move&&l==="b")||(!c.white_to_move&&l==="w"))){a.canvas.style.cursor="default";return}if(h!==""){a.drag_clear_i=g;a.drag_clear_j=f;a.drag_piece=h;a.dragok=true;a.takeSnapshot()}else{a.canvas.style.cursor="default"}}};b.myMove=function(q){q.preventDefault();var r=a,l,k,w,o,x,p,n,m,g,h,v,t,s,u=r.canvas.getBoundingClientRect(),f=r.square_size*8;if(r.dragok){l=parseInt(r.top/r.square_size,10);k=parseInt(r.left/r.square_size,10);p=(k-1)*r.square_size;n=(l-1)*r.square_size;m=r.square_size*3;g=r.square_size*3;if(!(l<0||l>7||k<0||k>7)){if(p<0){p=0}if(n<0){n=0}if(p+m>f){m=f-p}if(n+g>f){g=f-n}r.ctx.drawImage(r.snapshot,p,n,m,g,p,n,m,g)}if(q.hasOwnProperty("clientX")){r.left=q.clientX-u.left;r.top=q.clientY-u.top}else{if(q.hasOwnProperty("changedTouches")){r.left=q.changedTouches[0].pageX-u.left;r.top=q.changedTouches[0].pageY-u.top}else{return}}l=parseInt(r.top/r.square_size,10);k=parseInt(r.left/r.square_size,10);if(l<0||l>7||k<0||k>7){return}if(r.highlight_hover){r.drawSquare("hover",l*r.square_size,k*r.square_size)}r.ctx.save();h=(r.square_size/55);r.ctx.scale(h,h);w=l;o=k;if(!r.white_down){w=7-l;o=7-k}x=c.position_array[w][o].substr(0,2);if(x!==""&&!(w===r.drag_clear_i&&o===r.drag_clear_j)){v=parseInt((k*r.square_size/h),10);t=parseInt((l*r.square_size/h),10);r.ctx.drawImage(r[x],v,t,55,55)}x=r.drag_piece.substr(0,2);v=parseInt(((r.left-(r.square_size/2))/h),10);t=parseInt(((r.top-(r.square_size/2))/h),10);s=55;if(c.mode==="setup"&&r.top>r.square_size*7.5){s=s-((r.top-r.square_size*7.5)/h)}r.ctx.drawImage(r[x],v,t,55,55);r.ctx.restore()}};b.myUp=function(m){var l,k,h=["a","b","c","d","e","f","g","h"],g,f,q,p,n=a.canvas.getBoundingClientRect(),o;if(c.active&&a.dragok){if(m.hasOwnProperty("clientX")){g=parseInt((m.clientY-n.top)/a.square_size,10);f=parseInt((m.clientX-n.left)/a.square_size,10);a.canvas.style.cursor="default"}else{if(m.hasOwnProperty("changedTouches")){g=parseInt((m.changedTouches[0].pageY-n.top)/a.square_size,10);f=parseInt((m.changedTouches[0].pageX-n.left)/a.square_size,10)}else{return}}if(!a.white_down){g=7-g;f=7-f}o=a.drag_piece;a.dragok=false;a.drag_piece="";a.left=0;a.top=0;a.piece_not_lifted=true;if(a.drag_clear_i>=8){l="piecebox"}else{l=h[a.drag_clear_j]+(8-a.drag_clear_i)}if(g>=8){k="piecebox"}else{k=h[f]+(8-g)}q=CHESS.engine.getArrayPosition(l);p=CHESS.engine.getArrayPosition(k);if(c.mode==="setup"){if(l!==k&&l!=="piecebox"&&k!=="piecebox"){c.position_array[p.substr(1,1)][p.substr(0,1)]=o;c.position_array[q.substr(1,1)][q.substr(0,1)]=""}else{if(l==="piecebox"&&k==="piecebox"){}else{if(l==="piecebox"){c.position_array[p.substr(1,1)][p.substr(0,1)]=o}else{if(k==="piecebox"){c.position_array[q.substr(1,1)][q.substr(0,1)]=""}}}}}else{c.move(l,k)}a.takeSnapshot();a.refresh()}};b.publish=function(f,g){this.visitSubscribers("publish",f,g)};b.visitSubscribers=function(l,g,k){var h=k||"any",m=this.subscribers[h],j,f=0;if(m!==undefined){f=m.length}for(j=0;j<f;j+=1){if(l==="publish"){m[j](g)}else{if(m[j]===g){m.splice(j,1)}}}};b.resize=function(f,g){var i=0,h=8;f=f||0;g=g||0;f=parseInt(f,10);g=parseInt(g,10);if(f===0||g===0){f=parseInt(window.getComputedStyle(a.canvas.parentNode,null).getPropertyValue("height"),10);g=parseInt(window.getComputedStyle(a.canvas.parentNode,null).getPropertyValue("width"),10)}i=(f<g?f:g);if(c.mode==="setup"){h=10}a.square_size=(f<g?parseInt(i/h,10):parseInt(i/8,10));a.canvas.height=a.square_size*h;a.canvas.width=a.square_size*8};c.move=function(g,f){var l={position_array:CHESS.engine.clonePositionArray(this.position_array),white_to_move:this.white_to_move,en_passant:this.en_passant,active:this.active,gs_castle_kside_w:this.gs_castle_kside_w,gs_castle_qside_w:this.gs_castle_qside_w,gs_castle_kside_b:this.gs_castle_kside_b,gs_castle_qside_b:this.gs_castle_qside_b},i={fen:CHESS.engine.getFEN(this),player_to_move:(this.white_to_move?"w":"b"),sq1:g,sq2:f,promote:false,mate:false,stalemate:false},k,j,h;if(this.last_move){l.last_move={sq1:this.last_move.sq1,sq2:this.last_move.sq2}}k=CHESS.engine.getArrayPosition(g);j=CHESS.engine.getArrayPosition(f);h=c.position_array[k.substr(1,1)][k.substr(0,1)].substr(1,1);if(h==="p"&&((c.white_to_move&&f.substr(1,1)==="8")||(!c.white_to_move&&f.substr(1,1)==="1"))){i.promote=true}if(!CHESS.engine.moveTemp(l,g,f)){a.takeSnapshot();a.refresh();return}if(CHESS.engine.isMate(l)){i.mate=true}else{if(CHESS.engine.isStalemate(l)){i.stalemate=true}}b.publish(i,"move_before");this.position_array=CHESS.engine.clonePositionArray(l.position_array);this.white_to_move=l.white_to_move;this.en_passant=l.en_passant;this.active=l.active;this.gs_castle_kside_w=l.gs_castle_kside_w;this.gs_castle_qside_w=l.gs_castle_qside_w;this.gs_castle_kside_b=l.gs_castle_kside_b;this.gs_castle_qside_b=l.gs_castle_qside_b;this.moves+=1;if(l.last_move){this.last_move={sq1:l.last_move.sq1,sq2:l.last_move.sq2}}a.takeSnapshot();a.refresh();if(!this.active){return}};c.setPosition=function(f){CHESS.engine.setPosition(this,f)};a.buildHtml=function(f){this.canvas=document.createElement("canvas");this.canvas.className="chessboard";this.canvas.setAttribute("tabindex",0);this.ctx=this.canvas.getContext("2d");this.snapshot=document.createElement("canvas");this.snapshot_ctx=this.snapshot.getContext("2d");if(f!==undefined){document.getElementById(f).appendChild(this.canvas)}};a.drawPiece=function(g,f,k){var i,h,j=1;this.snapshot_ctx.save();j=this.square_size/55;this.snapshot_ctx.scale(j,j);i=f/j;h=k/j;this.snapshot_ctx.drawImage(this[g],i,h,55,55);this.snapshot_ctx.restore()};a.drawSquare=function(l,r,p,f){var s=f||this.snapshot_ctx,q,o,j=1,i,g=parseInt(r/this.square_size,10),t=parseInt(p/this.square_size,10),m,h,n=parseInt(this.square_size/55*10,10),k=parseInt(this.square_size/55*7,10);if(l==="hover"){this.ctx.beginPath();if((g+t)%2===0){this.ctx.fillStyle=this.square_hover_light}else{this.ctx.fillStyle=this.square_hover_dark}this.ctx.rect(t*this.square_size,g*this.square_size,this.square_size,this.square_size);this.ctx.fill()}else{q=r/j;o=p/j;i=(l==="light"?this.square_light:this.square_dark);if(i.src!==""){this.snapshot_ctx.save();j=this.square_size/55;this.snapshot_ctx.scale(j,j);this.snapshot_ctx.drawImage(i,0,0,55,55,q,o,55,55);this.snapshot_ctx.restore()}else{this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=(l==="light"?this.square_color_light:this.square_color_dark);this.snapshot_ctx.rect(q,o,this.square_size,this.square_size);this.snapshot_ctx.fill()}}if(this.show_row_col_labels&&(t===7||g===0)){h=parseInt(this.square_size/55*11,10),this.snapshot_ctx.font=h+"px arial";this.snapshot_ctx.fillStyle=(((7-t)+g)%2===0?this.square_color_light:this.square_color_dark);if(g===0){if(this.white_down){m=8-t}else{m=t+1}this.snapshot_ctx.fillText(m,2,(t*this.square_size)+n)}if(t===7){if(this.white_down){m=String.fromCharCode(g+97)}else{m=String.fromCharCode((7-g)+97)}this.snapshot_ctx.fillText(m,((this.square_size*g)+this.square_size)-k,(this.square_size*8)-2)}}};a.refresh=function(){this.ctx.clearRect(0,this.square_size*8,this.square_size*8,this.square_size*2);this.ctx.drawImage(this.snapshot,0,0)};a.takeSnapshot=function(){var g,f,q,k,p,o,l,h,s,r=8,m,n=CHESS.hexToRgb(this.highlight_move_color);if(c.mode==="setup"){r=10}this.snapshot.width=this.square_size*8;this.snapshot.height=this.square_size*r;for(o=0;o<8;o+=1){for(p=0;p<8;p+=1){if((p+o)%2===0){l=p*this.square_size;h=o*this.square_size;this.drawSquare("light",l,h)}}}for(o=0;o<8;o+=1){for(p=0;p<8;p+=1){if((p+o)%2!==0){l=p*this.square_size;h=o*this.square_size;this.drawSquare("dark",l,h)}}}if(this.highlight_move){if(typeof c.last_move==="object"&&c.last_move.sq1!==undefined){this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle="rgba("+n.r+","+n.g+","+n.b+", "+this.highlight_move_alpha+")";p=c.last_move.sq1.substr(0,1);o=c.last_move.sq1.substr(1,1);if(!this.white_down){p=7-p;o=7-o}this.snapshot_ctx.rect(p*this.square_size,o*this.square_size,this.square_size,this.square_size);p=c.last_move.sq2.substr(0,1);o=c.last_move.sq2.substr(1,1);if(!this.white_down){p=7-p;o=7-o}this.snapshot_ctx.rect(p*this.square_size,o*this.square_size,this.square_size,this.square_size);this.snapshot_ctx.fill()}}for(g=0;g<8;g+=1){for(f=0;f<8;f+=1){if(!this.dragok||!(g===this.drag_clear_i&&f===this.drag_clear_j)){s=c.position_array[g][f].substr(0,2);q=g;k=f;if(!this.white_down){q=7-g;k=7-f}p=k*this.square_size;o=q*this.square_size;if(s!==""){this.drawPiece(s,p,o)}}}}if(c.mode==="setup"){for(g=0;g<2;g+=1){for(f=0;f<8;f+=1){s=c.piecebox_array[g][f].substr(0,2);p=f*this.square_size;o=(g+8)*this.square_size;if(s!==""){this.drawPiece(s,p,o)}}}}if(this.dragok){g=this.drag_clear_i;f=this.drag_clear_j;if(!this.white_down){g=7-this.drag_clear_i;f=7-this.drag_clear_j}m=(g+f)%2===0;if(m){if(this.square_light.src!==""){this.drawSquare("light",f*this.square_size,g*this.square_size,this.ctx)}else{this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=this.square_color_light;this.snapshot_ctx.rect(f*this.square_size,g*this.square_size,this.square_size,this.square_size);this.snapshot_ctx.fill()}}else{if(this.square_dark.src!==""){this.drawSquare("dark",f*this.square_size,g*this.square_size,this.ctx)}else{this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=this.square_color_dark;this.snapshot_ctx.rect(f*this.square_size,g*this.square_size,this.square_size,this.square_size);this.snapshot_ctx.fill()}}}};this.display=function(){a.takeSnapshot();a.refresh()};this.flip=function(){a.white_down=!a.white_down;a.takeSnapshot();a.refresh()};this.getActiveColor=function(){return(c.white_to_move?"w":"b")};this.getFEN=function(){return CHESS.engine.getFEN(c)};this.getCanvas=function(){return a.canvas};this.isMate=function(){return CHESS.engine.isMate(c)};this.isStalemate=function(){return CHESS.engine.isStalemate(c)};this.move=function(i){var h,g,f;h=CHESS.engine.getLongNotation(c,i);h=h.split("-");g=h[0];f=h[1];c.move(g,f)};this.positionClear=function(){c.position_array=[["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""]];c.last_move={};c.en_passant="";c.white_to_move=true;c.gs_castle_kside_w=true;c.gs_castle_qside_w=true;c.gs_castle_kside_b=true;c.gs_castle_qside_b=true;c.moves=0;a.takeSnapshot();a.refresh()};this.positionStart=function(){c.position_array=[["br","bn","bb","bq","bk","bb","bn","br"],["bp","bp","bp","bp","bp","bp","bp","bp"],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["wp","wp","wp","wp","wp","wp","wp","wp"],["wr","wn","wb","wq","wk","wb","wn","wr"]];c.last_move={};c.en_passant="";c.white_to_move=true;c.gs_castle_kside_w=true;c.gs_castle_qside_w=true;c.gs_castle_kside_b=true;c.gs_castle_qside_b=true;c.moves=0;c.active=true;a.takeSnapshot();a.refresh()};this.resize=function(f,g){b.resize(f,g);a.takeSnapshot();a.refresh()};this.setActive=function(f){c.active=(f===true)};this.setLastMove=function(g,f){g=CHESS.engine.getArrayPosition(g);f=CHESS.engine.getArrayPosition(f);c.last_move={sq1:g,sq2:f}};this.setMode=function(f){c.mode=f;if(f==="setup"){c.active=true}b.resize(a.canvas.height,a.canvas.width);a.takeSnapshot();a.refresh()};this.setPosition=function(f){c.setPosition(f);c.active=true;a.takeSnapshot();a.refresh()};this.subscribe=function(g,f){g=g||"any";if(b.subscribers[g]===undefined){b.subscribers[g]=[]}b.subscribers[g].push(f)};this.unsubscribe=function(g,f){b.visitSubscribers("unsubscribe",g,f)};e=function(){var f;a.buildHtml(d.container);a.canvas.onmousedown=b.myDown;a.canvas.onmouseup=b.myUp;a.canvas.onmousemove=b.myMove;a.canvas.addEventListener("touchstart",b.myDown,false);a.canvas.addEventListener("touchend",b.myUp,false);a.canvas.addEventListener("touchmove",b.myMove,false);a.canvas.addEventListener("touchleave",b.myCancel,false);a.canvas.addEventListener("touchcancel",b.myCancel,false);a.highlight_move=(d.highlight_move===true?true:false);a.highlight_hover=(d.highlight_hover===true?true:false);a.show_row_col_labels=(d.show_row_col_labels===false?false:true);a.square_color_light=(d.square_color_light?d.square_color_light:a.square_color_light);a.square_color_dark=(d.square_color_dark?d.square_color_dark:a.square_color_dark);a.highlight_move_color=(d.highlight_move_color?d.highlight_move_color:a.highlight_move_color);a.highlight_move_alpha=(d.highlight_move_alpha?d.highlight_move_alpha:a.highlight_move_alpha);a.square_hover_light=(d.square_hover_light?d.square_hover_light:a.square_hover_light);a.square_hover_dark=(d.square_hover_dark?d.square_hover_dark:a.square_hover_dark);c.mode=d.mode;c.active=true;if(d.fen){c.setPosition(d.fen)}else{c.setPosition("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")}b.resize(d.height,d.width);f=CHESS.config.library_path+"/img/pieces/"+(d.piece_set||"default");a.wp.src=f+"/wp.svg";a.wp.onload=function(){a.takeSnapshot();a.refresh()};a.wr.src=f+"/wr.svg";a.wr.onload=function(){a.takeSnapshot();a.refresh()};a.wn.src=f+"/wn.svg";a.wn.onload=function(){a.takeSnapshot();a.refresh()};a.wb.src=f+"/wb.svg";a.wb.onload=function(){a.takeSnapshot();a.refresh()};a.wq.src=f+"/wq.svg";a.wq.onload=function(){a.takeSnapshot();a.refresh()};a.wk.src=f+"/wk.svg";a.wk.onload=function(){a.takeSnapshot();a.refresh()};a.bp.src=f+"/bp.svg";a.bp.onload=function(){a.takeSnapshot();a.refresh()};a.br.src=f+"/br.svg";a.br.onload=function(){a.takeSnapshot();a.refresh()};a.bn.src=f+"/bn.svg";a.bn.onload=function(){a.takeSnapshot();a.refresh()};a.bb.src=f+"/bb.svg";a.bb.onload=function(){a.takeSnapshot();a.refresh()};a.bq.src=f+"/bq.svg";a.bq.onload=function(){a.takeSnapshot();a.refresh()};a.bk.src=f+"/bk.svg";a.bk.onload=function(){a.takeSnapshot();a.refresh()};if(typeof d.square_dark==="string"){a.square_dark.src=d.square_dark;a.square_dark.onload=function(){a.takeSnapshot();a.refresh()}}if(typeof d.square_light==="string"){a.square_light.src=d.square_light;a.square_light.onload=function(){a.takeSnapshot();a.refresh()}}};e()};
CHESS.PgnViewer=function(d){var e,b={},c={event:"",site:"",date:"",round:"",white:"",black:"",result:"",fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",game_list:[]},a={board:null,container:null,main_box:null,header_box:null,header_details_box:null,control_box:null,move_control_box:null,board_control_box:null,header_players_elem:null,header_event_elem:null,header_site_elem:null,header_date_elem:null,header_result_elem:null,control_play_elem:null,control_pause_elem:null,control_start_elem:null,control_prev_elem:null,control_next_elem:null,control_end_elem:null,download_btn:null,flip_board_btn:null,move_list:null,game_list:null,current_move:null,ply:0,start_end_variation:false};b.goEnd=function(){if(a.current_move!==null){a.changeMove(a.current_move.parentNode.lastChild)}};b.goNext=function(){var f;if(a.current_move!==null){f=a.getSiblingMove(a.current_move,1);a.changeMove(f)}};b.goPrev=function(){var f;if(a.current_move!==null){f=a.getSiblingMove(a.current_move,-1);a.changeMove(f)}};b.goStart=function(){if(a.current_move!==null){a.changeMove(a.current_move.parentNode.firstChild)}};b.updateBoard=function(f){a.board.setPosition(f.currentTarget.fen);a.board.setLastMove(f.currentTarget.move.sq1,f.currentTarget.move.sq2);a.board.display();a.board.setActive(true);if(a.current_move!==null){a.current_move.removeAttribute("class")}f.currentTarget.className="current";a.current_move=f.currentTarget};a.buildHtml=function(h,g){var j,l=document,k,f;if(h.id!==undefined){this.container=document.getElementById(h.id)}if(this.container===undefined||this.container===null){document.write("<div id='canvaschess' class='canvaschesspgn'></div>");this.container=document.getElementById("canvaschess");this.container.removeAttribute("id")}this.container.setAttribute("tabindex",0);this.main_box=l.createElement("div");this.main_box.className="pgn_main_box";this.container.appendChild(this.main_box);this.buildHtmlHeader();this.buildHtmlControls();this.main_box.appendChild(g);this.move_list=l.createElement("ol");this.move_list.className="move_list";this.main_box.appendChild(this.move_list);if(h.width!==null){this.container.style.width=h.width+"px"}if(h.board_width!==null){this.header_details_box.style.width=h.board_width+"px"}if(h.move_list_width!==null){this.game_list.style.width=h.move_list_width+"px";this.move_list.style.width=(h.move_list_width-30)+"px";this.move_list.style.height=h.board_width+"px";this.move_control_box.style.width=h.move_list_width+"px";k=document.getElementsByClassName("pgn_ctrl_btn");f=parseInt((h.move_list_width-120)/8,10);for(j=0;j<k.length;j+=1){k[j].style.margin="0 "+f+"px"}}};a.buildHtmlControls=function(){var f=document;this.control_box=f.createElement("div");this.control_box.className="pgn_control_box";this.container.appendChild(this.control_box);this.board_control_box=f.createElement("span");this.board_control_box.className="board_controls";this.control_box.appendChild(this.board_control_box);this.flip_board_btn=f.createElement("a");this.flip_board_btn.className="board_ctrl_btn board_flip";this.flip_board_btn.title="Flip";this.flip_board_btn.onclick=this.board.flip;this.download_btn=f.createElement("a");this.download_btn.className="board_ctrl_btn board_download";this.download_btn.title="Download PGN";this.board_control_box.appendChild(this.flip_board_btn);this.board_control_box.appendChild(this.download_btn);this.move_control_box=f.createElement("span");this.move_control_box.className="move_controls";this.control_box.appendChild(this.move_control_box);this.control_play_elem=f.createElement("a");this.control_play_elem.className="pgn_ctrl_btn pgn_play";this.control_play_elem.title="Play";this.control_play_elem.onclick=b.goPlay;this.control_pause_elem=f.createElement("a");this.control_pause_elem.className="pgn_ctrl_btn pgn_pause";this.control_pause_elem.title="Pause";this.control_pause_elem.onclick=b.goPause;this.control_start_elem=f.createElement("a");this.control_start_elem.className="pgn_ctrl_btn pgn_start";this.control_start_elem.title="Start";this.control_start_elem.onclick=b.goStart;this.control_prev_elem=f.createElement("a");this.control_prev_elem.className="pgn_ctrl_btn pgn_prev";this.control_prev_elem.title="Previous";this.control_prev_elem.onclick=b.goPrev;this.control_next_elem=f.createElement("a");this.control_next_elem.className="pgn_ctrl_btn pgn_next";this.control_next_elem.title="Next";this.control_next_elem.onclick=b.goNext;this.control_end_elem=f.createElement("a");this.control_end_elem.className="pgn_ctrl_btn pgn_end";this.control_end_elem.title="End";this.control_end_elem.onclick=b.goEnd;this.move_control_box.appendChild(this.control_start_elem);this.move_control_box.appendChild(this.control_prev_elem);this.move_control_box.appendChild(this.control_next_elem);this.move_control_box.appendChild(this.control_end_elem)};a.buildHtmlHeader=function(){var f=document;this.header_box=f.createElement("div");this.header_box.className="pgn_header_box";this.container.insertBefore(this.header_box,this.container.firstChild);this.header_details_box=f.createElement("div");this.header_details_box.className="pgn_header_details_box";this.header_box.appendChild(this.header_details_box);this.header_players_elem=f.createElement("span");this.header_players_elem.className="pgn_players";this.header_players_elem.title="Players";this.header_players_elem.innerHTML="Players";this.header_event_elem=f.createElement("span");this.header_event_elem.className="pgn_event";this.header_event_elem.title="Event";this.header_event_elem.innerHTML="Event";this.header_site_elem=f.createElement("span");this.header_site_elem.className="pgn_site";this.header_site_elem.title="Site";this.header_site_elem.innerHTML="Site";this.header_date_elem=f.createElement("span");this.header_date_elem.className="pgn_date";this.header_date_elem.title="Date";this.header_date_elem.innerHTML="Date";this.header_result_elem=f.createElement("span");this.header_result_elem.className="pgn_result";this.header_result_elem.title="Result";this.header_result_elem.innerHTML="Result";this.header_details_box.appendChild(this.header_players_elem);this.header_details_box.appendChild(this.header_event_elem);this.header_details_box.appendChild(this.header_site_elem);this.header_details_box.appendChild(this.header_date_elem);this.header_details_box.appendChild(this.header_result_elem);this.game_list=f.createElement("select");this.game_list.className="game_list";this.game_list.onchange=function(g){a.changeGame(g.currentTarget.value)};this.header_box.appendChild(this.game_list)};a.changeGame=function(h){var j,o,k,g,s,f,r,q,t,m,p,n,l;c.event="";c.site="";c.date="";c.round="";c.white="";c.black="";c.result="";c.fen="";while(this.move_list.firstChild){this.move_list.removeChild(this.move_list.firstChild)}this.current_move=null;o=c.game_list[h];k=o.match(/\[([^\[]+)\]/g);for(j=0;j<k.length;j+=1){g=k[j].match(/\[(\S+)\s"(.+?)"\]/);g[1]=g[1].replace(/\s+$/,"");g[2]=g[2].replace(/\s+$/,"");switch(g[1].toLowerCase()){case"event":c.event=g[2];break;case"site":c.site=g[2];break;case"date":c.date=g[2];break;case"round":c.round=g[2];break;case"white":c.white=g[2];break;case"black":c.black=g[2];break;case"result":c.result=g[2];break;case"fen":c.fen=g[2];break}}if(c.fen===""){c.fen="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"}this.displayHeader();s=o.match(/\]\s+([{\w][\s\S]+$)/)[1];s=s.replace(/\s*1-0\s*$/,"");s=s.replace(/\s*0-1\s*$/,"");s=s.replace(/\s*1\/2-1\/2\s*$/,"");s=s.replace(/\s*\*\s*$/,"");n=s.match(/\{[^{]*\}/g);s=s.replace(/\{[^{]*\}/g,"{}");f=s.match(/^(\{\})|(\d+[.]{1,3}).+?(?=(\d+[.]{1,3})|$)/g);if(f[0]==="{}"){l=n.shift().replace(/\{/,"").replace(/\}/,"");this.move(null,l)}for(j=0;j<f.length;j+=1){r=f[j].match(/\d+[.]{1,3}\s?([^ )]+)\s?(?:\{\})?/);if(r!==null){m=r[1].match(/[!?=]+/);m=(m&&m[0]?m[0]:null);t=r[1].match(/\$(\d+)/);t=(t&&t[1]?t[1]:null);t=CHESS.nag_code[t];if(t){p=t}else{if(m){p=m}else{p=""}}r[1]=r[1].replace(/[^1-8a-hRNBQKOx\-]*$/,"");r[1]=r[1].replace(/\s*\$.*$/,"");l="";if(/\{\}/.test(r[0])){l=n.shift().replace(/\{/,"").replace(/\}/,"")}this.move(r[1],l,p);f[j]=f[j].replace(r[0],"");q=f[j].match(/(\w[^ )]+)\s?(?:\{\})?/);if(q!==null){m=q[1].match(/[!?=]+/);m=(m&&m[0]?m[0]:null);t=q[1].match(/\$(\d+)/);t=(t&&t[1]?t[1]:null);t=CHESS.nag_code[t];if(t){p=t}else{if(m){p=m}else{p=""}}q[1]=q[1].replace(/[^1-8a-hRNBQKOx\-]*$/,"");q[1]=q[1].replace(/\s*\$.*$/,"");l="";if(/\{\}/.test(q[0])){l=n.shift().replace(/\{/,"").replace(/\}/,"")}this.move(q[1],l,p)}if(/\)/.test(f[j])){this.endVariation()}if(/\(/.test(f[j])){this.startVariation()}}}this.current_move=a.move_list.getElementsByTagName("li")[0];this.board.setPosition(this.current_move.fen);this.board.display();a.move_list.scrollTop=0};a.changeMove=function(g){var f;if(a.current_move!==g){if(a.current_move!==null&&g!==null){a.current_move.removeAttribute("class")}if(g!==null){g.className="current";b.updateBoard({currentTarget:g});a.current_move=g;f=a.current_move.offsetTop-a.move_list.offsetTop;f-=parseInt(a.move_list.offsetHeight/2,10);a.move_list.scrollTop=f}}};a.displayHeader=function(){this.header_date_elem.innerHTML=this.getPgnDate(c.date);this.header_players_elem.innerHTML=c.white+" vs "+c.black;this.header_event_elem.innerHTML=c.event;this.header_site_elem.innerHTML=c.site;this.header_result_elem.innerHTML=c.result};a.endVariation=function(){this.current_move=this.current_move.parentNode.parentNode.previousSibling;this.ply=(+this.current_move.getAttribute("data-ply"));this.start_end_variation=true;return this};a.getPgnDate=function(h){var j=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Jun","Sep","Oct","Nov","Dec"],l=h.split("."),i="",k="",g="",f;if(l.length===3&&l[0].length===4&&l[1].length===2&&l[2].length===2){i=l[0];k=parseInt(l[1],10);g=parseInt(l[2],10);k=(k>0&&k<13?j[k]:"");f=(g>0?g+" ":"")+(k!==""?k+" ":"")+(i>0?i+" ":"");f=f.replace(/\s+$/,"")}return f};a.getSiblingMove=function(f,g){if(g===1){while(f=f.nextSibling){if(!(/variation_list/.test(f.className))){break}}}else{if(g===-1){while(f=f.previousSibling){if(!(/variation_list/.test(f.className))){break}}}}return f};a.importFile=function(k){var j,g,f,n,h,m,l;k=k.replace(/^ +/gm,"").replace(/$ +/gm,"");k=k.replace(/\n/g," ").replace(/\s+/g," ");c.game_list=k.split(/[^\w](?:(?:1-0)|(?:0-1)|(?:1\/2-1\/2)|\*)\s*(?=\[)/);if(c.game_list.length>1){for(j=0;j<c.game_list.length;j+=1){g=c.game_list[j];f=g.match(/\[\s*white\s+['"](.*?)['"]\]/i);f=(f!==null&&f.length>1?f[1]:"");n=g.match(/\[\s*black\s+['"](.*?)['"]\]/i);n=(n!==null&&n.length>1?n[1]:"");h=g.match(/\[\s*date\s+['"]([0-9.?]+)['"]\]/i);h=(h!==null&&h.length>1?h[1]:"");m=f+" vs. "+n;l=document.createElement("option");l.value=j;l.text=m;this.game_list.appendChild(l)}}else{this.game_list.style.display="none"}this.changeGame(0)};a.move=function(l,n,p){var j,r,g,h,k,q,o,i,m,f;if(!l&&!n){return this}if(this.current_move===null){j=document.createElement("li");if(c.fen.length>0){j.fen=c.fen;m=j.fen.match(/\s+([wbWB])\s+([-kqKQ]+)\s+([-\w]{1,2})\s+(\d+)\s+(\d+)\s*$/);f=m[1].toLowerCase();h=+m[5];this.ply=(h*2)-(f==="w"?2:1);j.setAttribute("data-ply",this.ply)}else{j.setAttribute("data-ply",0)}j.move="";j.onclick=b.updateBoard;this.move_list.appendChild(j);this.current_move=j;if(!l&&typeof n==="string"){g=document.createElement("span");g.setAttribute("class","comment");g.innerHTML=n;j.appendChild(g);return}}h=(this.ply%2===0?(parseInt(this.ply/2,10)+1)+".&nbsp;":"");if(this.ply%2===1&&this.start_end_variation){h=(parseInt((this.ply-1)/2,10)+1)+"..."}this.start_end_variation=false;this.ply+=1;r=document.createElement("span");r.setAttribute("class","move_text");r.innerHTML=h+l+p+" ";j=document.createElement("li");j.setAttribute("data-ply",this.ply);j.appendChild(r);if(this.current_move.fen===undefined){if(this.current_move.className==="variation"){k=a.getSiblingMove(this.current_move.parentNode.previousSibling,-1).fen}}else{k=this.current_move.fen}q=CHESS.engine.createPosition(k);o=CHESS.engine.getLongNotation(q,l);i=o.split("-");CHESS.engine.moveTemp(q,i[0],i[1]);k=CHESS.engine.getFEN(q);j.move={sq1:i[0],sq2:i[1]};j.fen=k;j.onclick=b.updateBoard;if(this.current_move.tagName.toLowerCase()==="ol"){this.current_move.appendChild(j)}else{this.current_move.parentNode.appendChild(j)}if(n){g=document.createElement("span");g.setAttribute("class","comment");g.innerHTML=n;j.appendChild(g)}this.current_move=j;return this};a.startVariation=function(){var g,f;if(this.current_move.nextSibling===null){g=document.createElement("li");g.setAttribute("class","variation_list")}else{g=this.current_move.nextSibling}f=document.createElement("ol");f.setAttribute("class","variation");g.appendChild(f);this.current_move.parentNode.appendChild(g);this.current_move=f;this.ply-=1;this.start_end_variation=true;return this};this.flip=function(){a.board.flip()};this.load=function(f,h){var g=new XMLHttpRequest();a.download_btn.href=f;g.onreadystatechange=function(){var i;if(g.readyState===4&&g.status===200){i=g.responseText;a.importFile(i);if(typeof h==="function"){h()}}};g.open("GET",f,true);g.send()};this.loadText=function(f){a.importFile(f)};e=function(f){if(d.width===undefined){d.width=null;d.board_width=null;d.move_list_width=null}else{d.width=parseInt(d.width,10);d.board_width=parseInt((d.width-10)*0.54,10);d.move_list_width=parseInt(d.width,10)-d.board_width}a.board=new CHESS.Board({height:d.board_width,width:d.board_width,square_color_light:d.square_color_light,square_color_dark:d.square_color_dark,square_hover_dark:d.square_hover_dark,square_hover_light:d.square_hover_light,square_dark:d.square_dark,square_light:d.square_light,highlight_move:d.highlight_move,highlight_move_color:d.highlight_move_color,highlight_move_alpha:d.highlight_move_alpha,show_row_col_labels:d.show_row_col_labels,piece_set:d.piece_set});a.buildHtml(d,a.board.getCanvas());a.container.onkeydown=function(g){g.stopPropagation();if(g.keyCode===37){b.goPrev()}else{if(g.keyCode===39){b.goNext()}}};a.container.getElementsByClassName("chessboard")[0].addEventListener("keydown",function(g){g.stopPropagation();if(g.keyCode===37){b.goPrev()}else{if(g.keyCode===39){b.goNext()}}});if(d.url!==undefined){f.load(d.url)}else{if(d.pgn_text!==undefined){f.loadText(d.pgn_text)}}};e(this)};
if(typeof define==="function"&&define.amd){define("chess",[],function(){return CHESS})};
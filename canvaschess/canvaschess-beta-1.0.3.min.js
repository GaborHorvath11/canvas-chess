var CHESS=CHESS||{};CHESS.nag_code={0:{symbol:"",desc:""},1:{symbol:"!",desc:"Good move"},2:{symbol:"?",desc:"Poor move"},3:{symbol:"!!",desc:"Brilliant"},4:{symbol:"??",desc:"Blunder / mistake"},5:{symbol:"!?",desc:"Speculative / interesting"},6:{symbol:"?!",desc:"Questionable / dubious"},10:{symbol:"=",desc:"Even / drawish"},11:{symbol:"=",desc:"Equal chances, quite position"},12:{symbol:"=",desc:"Equal chances, active position"},13:{symbol:"&infin;",desc:"Unclear position"},14:{symbol:"+/=",desc:"White has a slight advantage"},15:{symbol:"=/+",desc:"Black has a slight advantage"},16:{symbol:"&plusmn;",desc:"White has a moderate advantage"},17:{symbol:"&#8723;",desc:"Black has a moderate advantage"},18:{symbol:"+-",desc:"White has a decisive advantage"},19:{symbol:"-+",desc:"Black has a decisive advantage"}};CHESS.hexToRgba=function(c){var b=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;c=c.replace(b,function(e,h,f,d){return h+h+f+f+d+d});var a=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(c);return(a?{r:parseInt(a[1],16),g:parseInt(a[2],16),b:parseInt(a[3],16),a:1}:null)};
CHESS.util={};CHESS.util.createPosition=function(c){var a=function(){var m="",p=[],l=[],g={},h="",n=true,q=true,j=true,o=true,f=true,k=false,e=0};var d=function(){};d.prototype=a;var b=new d();if(c!==undefined){this.setPosition(b,c)}return b};CHESS.util.setPosition=function(q,e){var m,o,a,p=[],b="",c=0,g="",r="",d="",n=["a","b","c","d","e","f","g","h"],l=0,h=0,f=0;m=e.split(" ");o=m[0];a=m[2];p=o.split("/");q.en_passant=m[3];q.white_to_move=(m[1]==="w");if(a==="-"){q.gs_castle_kside_w=false;q.gs_castle_qside_w=false;q.gs_castle_kside_b=false;q.gs_castle_qside_b=false}else{if(a.indexOf("K")>=0){q.gs_castle_kside_w=true}if(a.indexOf("Q")>=0){q.gs_castle_qside_w=true}if(a.indexOf("k")>=0){q.gs_castle_kside_b=true}if(a.indexOf("q")>=0){q.gs_castle_qside_b=true}}q.position_array=[["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"]];q.piecebox_array=[["-","wk","wq","wr","wb","wn","wp","-"],["-","bk","bq","br","bb","bn","bp","-"]];q.moves=0;q.last_move={};for(l=0;l<p.length;l+=1){for(h=0;h<p[l].length;h+=1){b=p[l].charAt(h);for(f=0;f<q.position_array[l].length;f+=1){if(q.position_array[l][f]==="-"){c=f;f=q.position_array[l].length}}if(/[0-9]/.test(b)){for(f=0;f<parseInt(b,10);f+=1){q.position_array[l][f+c]=""}}else{g="w";if(/[a-z]/.test(b)){g="b"}r=b.toLowerCase();d="";if(r==="p"){d=n[c]}q.position_array[l][c]=g+r+d}}}};CHESS.util.getFEN=function(l){var g=[],h,a="",b="",k=[],d="",m="",f=0,e=0,c=0;for(f=0;f<l.position_array.length;f+=1){k[f]="";for(e=0;e<l.position_array[f].length;e+=1){m=l.position_array[f][e];if(m===""){c+=1}else{if(c>0){k[f]+=(c+"");c=0}d=m.substr(0,1);m=m.substr(1,1);if(d==="w"){m=m.toUpperCase()}k[f]+=m}}if(c>0){k[f]+=(c+"");c=0}}h=k.join("/");g.push(h);g.push(l.white_to_move?"w":"b");a="-";if(l.gs_castle_kside_w||l.gs_castle_qside_w||l.gs_castle_kside_b||l.gs_castle_qside_b){if(l.gs_castle_kside_w){a+="K"}if(l.gs_castle_qside_w){a+="Q"}if(l.gs_castle_kside_b){a+="k"}if(l.gs_castle_qside_b){a+="q"}}g.push(a);b=(l.en_passant===""?"-":l.en_passant);g.push(b);g.push("0 1");return g.join(" ")};CHESS.util.isLegal=function(k,c,a){var t,n,m,v,f,u,e,l,p,q,r,h,b,d,g,o,s,j;n=this.getArrayPosition(c);m=this.getArrayPosition(a);if(!n||!m){return false}v=parseInt(n.substr(0,1));f=parseInt(n.substr(1,1));u=parseInt(m.substr(0,1));e=parseInt(m.substr(1,1));l=k.position_array[f][v];p=k.position_array[e][u];q=l.substr(1,1);r=l.substr(0,1);h=false;if((k.white_to_move&&r==="b")||(!k.white_to_move&&r==="w")){return false}if(p.substr(0,1)===l.substr(0,1)){return false}if(q==="p"){if(f===e){return false}if((r==="w"&&e>f)||(r==="b"&&e<f)){return false}if(!(Math.abs(f-e)===1||(Math.abs(f-e)===2&&((r==="w"&&f===6&&k.position_array[5][v]==="")||(r==="b"&&f===1&&k.position_array[2][v]===""))))){return false}if(Math.abs(v-u)===0&&k.position_array[e][u]!==""){return false}if(Math.abs(v-u)>0){b=(p.substr(0,1)!==""&&p.substr(0,1)!==r);h=k.en_passant===this.reverseArrayPosition(e+""+u);if(!(Math.abs(v-u)===1&&Math.abs(f-e)===1&&(b||h))){return false}}}if(q==="k"){if(Math.abs(v-u)===2){if(r==="w"){if(a==="g1"&&k.gs_castle_kside_w&&k.position_array[7][5]===""&&k.position_array[7][6]===""){if(this.isSquareAttacked(k.position_array,4,7,"w")){return false}if(this.isSquareAttacked(k.position_array,5,7,"w")){return false}if(this.isSquareAttacked(k.position_array,6,7,"w")){return false}}else{if(a==="c1"&&k.gs_castle_qside_w&&k.position_array[7][1]===""&&k.position_array[7][2]===""&&k.position_array[7][3]===""){if(this.isSquareAttacked(k.position_array,2,7,"w")){return false}if(this.isSquareAttacked(k.position_array,3,7,"w")){return false}if(this.isSquareAttacked(k.position_array,4,7,"w")){return false}}else{return false}}}else{if(r==="b"){if(a==="g8"&&k.gs_castle_kside_b&&k.position_array[0][5]===""&&k.position_array[0][6]===""){if(this.isSquareAttacked(k.position_array,4,0,"b")){return false}if(this.isSquareAttacked(k.position_array,5,0,"b")){return false}if(this.isSquareAttacked(k.position_array,6,0,"b")){return false}}else{if(a==="c8"&&k.gs_castle_qside_b&&k.position_array[0][1]===""&&k.position_array[0][2]===""&&k.position_array[0][3]===""){if(this.isSquareAttacked(k.position_array,2,0,"b")){return false}if(this.isSquareAttacked(k.position_array,3,0,"b")){return false}if(this.isSquareAttacked(k.position_array,4,0,"b")){return false}}else{return false}}}}}else{if(!(Math.abs(v-u)<2&&Math.abs(f-e)<2)){return false}}}if(q==="n"&&!((Math.abs(v-u)===1&&Math.abs(f-e)===2)||(Math.abs(v-u)===2&&Math.abs(f-e)===1))){return false}if(q==="r"){if(v!==u&&f!==e){return false}}if(q==="b"){if(Math.abs(v-u)!==Math.abs(f-e)){return false}}if(q==="q"){if((Math.abs(v-u)!==Math.abs(f-e))&&(v!==u&&f!==e)){return false}}if(q==="q"||q==="b"||q==="r"){t=0;d=v-u;g=f-e;o=0;s=0;if(d<0){o=1}else{if(d>0){o=-1}}if(g<0){s=1}else{if(g>0){s=-1}}t=1;while(!(parseInt(v)+t*o===u&&parseInt(f)+t*s===e)){if(t>8){break}if(k.position_array[parseInt(f)+t*s][parseInt(v)+t*o]!==""){return false}t+=1}}j=this.clonePositionArray(k.position_array);j[m.substr(1,1)][m.substr(0,1)]=j[n.substr(1,1)][n.substr(0,1)];j[n.substr(1,1)][n.substr(0,1)]="";if(h){j[n.substr(1,1)][m.substr(0,1)]=""}if(this.isCheck(j,r)){return false}return true};CHESS.util.isCheck=function(f,e){var d,b,c=0,a=0;for(d=0;d<8;d++){for(b=0;b<8;b++){if(f[d][b]===e+"k"){c=b;a=d}}}if(this.isSquareAttacked(f,c,a,e)){return true}return false};CHESS.util.isMate=function(h){var v,t,q=(h.white_to_move?"w":"b"),p=0,n=0,s,u,r,o,c=this.clonePositionArray(h.position_array);for(v=0;v<8;v++){for(t=0;t<8;t++){if(c[v][t]===q+"k"){p=t;n=v}}}s=this.getAttacker(c,p,n,q);if(s===""){return false}c[n][p]="";if(n>0){if(c[n-1][p].substr(0,1)!==q){if(!this.isSquareAttacked(c,p,n-1,q)){return false}}}if(n<7){if(c[n+1][p].substr(0,1)!==q){if(!this.isSquareAttacked(c,p,n+1,q)){return false}}}if(p>0){if(c[n][p-1].substr(0,1)!==q){if(!this.isSquareAttacked(c,p-1,n,q)){return false}}}if(p<7){if(c[n][p+1].substr(0,1)!==q){if(!this.isSquareAttacked(c,p+1,n,q)){return false}}}if(p>0&&n>0){if(c[n-1][p-1].substr(0,1)!==q){if(!this.isSquareAttacked(c,p-1,n-1,q)){return false}}}if(p<7&&n>0){if(c[n-1][p+1].substr(0,1)!==q){if(!this.isSquareAttacked(c,p+1,n-1,q)){return false}}}if(p>0&&n<7){if(c[n+1][p-1].substr(0,1)!==q){if(!this.isSquareAttacked(c,p-1,n+1,q)){return false}}}if(p<7&&n<7){if(c[n+1][p+1].substr(0,1)!==q){if(!this.isSquareAttacked(c,p+1,n+1,q)){return false}}}c[n][p]=q+"k";u=parseInt(s.substr(1,1));r=parseInt(s.substr(0,1));var l="b";if(q==="b"){l="w"}o=this.getAttacker(c,r,u,l);if(o!==""){var f=this.reverseArrayPosition(o);var d=this.reverseArrayPosition(s);if(this.isLegal(h,f,d)){return false}}var k=c[r][u].substr(1,1);if(k==="r"||k==="b"||k==="q"){if(Math.abs(p-u)>1||Math.abs(n-r)>1){var x=u-p;var e=r-n;var g=0;var m=0;if(x>0){g=1}if(e>0){m=1}if(x<0){g=-1}if(e<0){m=-1}var y=p+g,w=n+m;c[n][p]=l+"k";while(y!==u||w!==r){if(this.isSquareBlockable(c,y,w,l)){return false}y+=g;w+=m}}}if(k==="p"){if(q==="w"&&r===3&&h.en_passant===this.reverseArrayPosition((r-1)+""+u)){if(u>0&&c[3][u-1].substr(0,2)==="wp"){return false}if(u<7&&c[3][u+1].substr(0,2)==="wp"){return false}}if(q==="b"&&r===4&&h.en_passant===this.reverseArrayPosition((r+1)+""+u)){if(u>0&&c[4][u-1].substr(0,2)==="bp"){return false}if(u<7&&c[4][u+1].substr(0,2)==="bp"){return false}}}return true};CHESS.util.isSquareAttacked=function(e,c,b,d){var a;c=parseInt(c);b=parseInt(b);if(b>0&&c>1&&e[b-1][c-2].substr(1,1)==="n"&&e[b-1][c-2].substr(0,1)!==d){return true}if(b>0&&c<6&&e[b-1][c+2].substr(1,1)==="n"&&e[b-1][c+2].substr(0,1)!==d){return true}if(b<7&&c>1&&e[b+1][c-2].substr(1,1)==="n"&&e[b+1][c-2].substr(0,1)!==d){return true}if(b<7&&c<6&&e[b+1][c+2].substr(1,1)==="n"&&e[b+1][c+2].substr(0,1)!==d){return true}if(b>1&&c>0&&e[b-2][c-1].substr(1,1)==="n"&&e[b-2][c-1].substr(0,1)!==d){return true}if(b>1&&c<7&&e[b-2][c+1].substr(1,1)==="n"&&e[b-2][c+1].substr(0,1)!==d){return true}if(b<6&&c>0&&e[b+2][c-1].substr(1,1)==="n"&&e[b+2][c-1].substr(0,1)!==d){return true}if(b<6&&c<7&&e[b+2][c+1].substr(1,1)==="n"&&e[b+2][c+1].substr(0,1)!==d){return true}i=1;while(c+i<8){a=e[b][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0){a=e[b][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(b-i>=0){a=e[b-i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(b+i<8){a=e[b+i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c+i<8&&b-i>=0){a=e[b-i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c+i<8&&b+i<8){a=e[b+i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b+i<8){a=e[b+i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b-i>=0){a=e[b-i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}if(d==="w"){if(c-1>=0&&b-1>=0){a=e[b-1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}if(c+1<8&&b-1>=0){a=e[b-1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}}else{if(c-1>=0&&b+1<8){a=e[b+1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}if(c+1<8&&b+1<8){a=e[b+1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}}return false};CHESS.util.isSquareBlockable=function(d,e,c,b){var a;e=parseInt(e);c=parseInt(c);if(c>0&&e>1&&d[c-1][e-2].substr(1,1)==="n"&&d[c-1][e-2].substr(0,1)!==b){return true}if(c>0&&e<6&&d[c-1][e+2].substr(1,1)==="n"&&d[c-1][e+2].substr(0,1)!==b){return true}if(c<7&&e>1&&d[c+1][e-2].substr(1,1)==="n"&&d[c+1][e-2].substr(0,1)!==b){return true}if(c<7&&e<6&&d[c+1][e+2].substr(1,1)==="n"&&d[c+1][e+2].substr(0,1)!==b){return true}if(c>1&&e>0&&d[c-2][e-1].substr(1,1)==="n"&&d[c-2][e-1].substr(0,1)!==b){return true}if(c>1&&e<7&&d[c-2][e+1].substr(1,1)==="n"&&d[c-2][e+1].substr(0,1)!==b){return true}if(c<6&&e>0&&d[c+2][e-1].substr(1,1)==="n"&&d[c+2][e-1].substr(0,1)!==b){return true}if(c<6&&e<7&&d[c+2][e+1].substr(1,1)==="n"&&d[c+2][e+1].substr(0,1)!==b){return true}i=1;while(e+i<8){a=d[c][e+i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(e-i>=0){a=d[c][e-i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0){a=d[c-i][e];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(c+i<8){a=d[c+i][e];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(e+i<8&&c-i>=0){a=d[c-i][e+i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}i=1;while(e+i<8&&c+i<8){a=d[c+i][e+i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}i=1;while(e-i>=0&&c+i<8){a=d[c+i][e-i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}i=1;while(e-i>=0&&c-i>=0){a=d[c-i][e-i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}if(b==="w"){if(c-1>=0){a=d[c-1][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}if(c===3&&d[2][e]===""){a=d[1][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}}else{if(c+1<8){a=d[c+1][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}if(c===4&&d[5][e]===""){a=d[6][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}}return false};CHESS.util.getAttacker=function(e,c,b,d){var a;c=parseInt(c);b=parseInt(b);if(b>0&&c>1&&e[b-1][c-2].substr(1,1)==="n"&&e[b-1][c-2].substr(0,1)!==d){return(b-1)+""+(c-2)}if(b>0&&c<6&&e[b-1][c+2].substr(1,1)==="n"&&e[b-1][c+2].substr(0,1)!==d){return(b-1)+""+(c+2)}if(b<7&&c>1&&e[b+1][c-2].substr(1,1)==="n"&&e[b+1][c-2].substr(0,1)!==d){return(b+1)+""+(c-2)}if(b<7&&c<6&&e[b+1][c+2].substr(1,1)==="n"&&e[b+1][c+2].substr(0,1)!==d){return(b+1)+""+(c+2)}if(b>1&&c>0&&e[b-2][c-1].substr(1,1)==="n"&&e[b-2][c-1].substr(0,1)!==d){return(b-2)+""+(c-1)}if(b>1&&c<7&&e[b-2][c+1].substr(1,1)==="n"&&e[b-2][c+1].substr(0,1)!==d){return(b-2)+""+(c+1)}if(b<6&&c>0&&e[b+2][c-1].substr(1,1)==="n"&&e[b+2][c-1].substr(0,1)!==d){return(b+2)+""+(c-1)}if(b<6&&c<7&&e[b+2][c+1].substr(1,1)==="n"&&e[b+2][c+1].substr(0,1)!==d){return(b+2)+""+(c+1)}i=1;while(c+i<8){a=e[b][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b)+""+(c+i)}if(a!==""){break}i+=1}i=1;while(c-i>=0){a=e[b][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b)+""+(c-i)}if(a!==""){break}i+=1}i=1;while(b-i>=0){a=e[b-i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b-i)+""+(c)}if(a!==""){break}i+=1}i=1;while(b+i<8){a=e[b+i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b+i)+""+(c)}if(a!==""){break}i+=1}i=1;while(c+i<8&&b-i>=0){a=e[b-i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b-i)+""+(c+i)}if(a!==""){break}i+=1}i=1;while(c+i<8&&b+i<8){a=e[b+i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b+i)+""+(c+i)}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b+i<8){a=e[b+i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b+i)+""+(c-i)}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b-i>=0){a=e[b-i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b-i)+""+(c-i)}if(a!==""){break}i+=1}if(d==="w"){if(c-1>0&&b-1>=0){a=e[b-1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b-1)+""+(c-1)}}if(c+1<8&&b-1>=0){a=e[b-1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b-1)+""+(c+1)}}}else{if(c-1>=0&&b+1<8){a=e[b+1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b+1)+""+(c-1)}}if(c+1<8&&b+1<8){a=e[b+1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b+1)+""+(c+1)}}}return""};CHESS.util.isStalemate=function(b){var a=!this.getLegalMoves(b,true);return a};CHESS.util.isInsufficientMaterial=function(b){var a=false;return a};CHESS.util.getLegalMoves=function(n,h){var g,f,l,k,d="",m=[],e=(n.white_to_move?"w":"b"),c,b=0,a;for(g=0;g<8;g++){for(f=0;f<8;f++){l=this.reverseArrayPosition(g+""+f);if(n.position_array[g][f]===e+"k"){if(g>0){k=this.reverseArrayPosition((g-1)+""+f);d=l+"-"+k;m.push(d)}if(g>0&&f<7){k=this.reverseArrayPosition((g-1)+""+(f+1));d=l+"-"+k;m.push(d)}if(f<7){k=this.reverseArrayPosition(g+""+(f+1));d=l+"-"+k;m.push(d)}if(g<7&&f<7){k=this.reverseArrayPosition((g+1)+""+(f+1));d=l+"-"+k;m.push(d)}if(g<7){k=this.reverseArrayPosition((g+1)+""+f);d=l+"-"+k;m.push(d)}if(g<7&&f>0){k=this.reverseArrayPosition((g+1)+""+(f-1));d=l+"-"+k;m.push(d)}if(f>0){k=this.reverseArrayPosition(g+""+(f-1));d=l+"-"+k;m.push(d)}if(g>0&&f>0){k=this.reverseArrayPosition((g-1)+""+(f-1));d=l+"-"+k;m.push(d)}}if(n.position_array[g][f].substr(0,2)===e+"p"){c=(e==="w"?-1:1);k=this.reverseArrayPosition((g+c)+""+f);d=l+"-"+k;m.push(d);if((e==="w"&&g===6)||(e==="b"&&g===1)){k=this.reverseArrayPosition((g+(c*2))+""+f);d=l+"-"+k;m.push(d)}if(/[a-h][1-8]/.test(n.en_passant)){a=parseInt(this.getArrayPosition(n.en_passant).substr(0,1),10)}if(e==="w"&&g===3){if(a===(f-1)){k=this.reverseArrayPosition((g-1)+""+(f-1));d=l+"-"+k;m.push(d)}if(a===(f+1)){k=this.reverseArrayPosition((g-1)+""+(f+1));d=l+"-"+k;m.push(d)}}if(e==="b"&&g===4){if(a===(f-1)){k=this.reverseArrayPosition((g+1)+""+(f-1));d=l+"-"+k;m.push(d)}if(a===(f+1)){k=this.reverseArrayPosition((g+1)+""+(f+1));d=l+"-"+k;m.push(d)}}}if(n.position_array[g][f]===e+"q"){b=1;while(g-b>=0){k=this.reverseArrayPosition((g-b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(g-b>=0&&f+b<=7){k=this.reverseArrayPosition((g-b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7){k=this.reverseArrayPosition(g+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7&&g+b<=7){k=this.reverseArrayPosition((g+b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7){k=this.reverseArrayPosition((g+b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7&&f-b>=0){k=this.reverseArrayPosition((g+b)+""+(f-b));d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0){k=this.reverseArrayPosition(g+""+(f-b));d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0&&g-b>=0){k=this.reverseArrayPosition((g-b)+""+(f-b));d=l+"-"+k;m.push(d);b++}}if(n.position_array[g][f]===e+"r"){b=1;while(g-b>=0){k=this.reverseArrayPosition((g-b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7){k=this.reverseArrayPosition(g+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7){k=this.reverseArrayPosition((g+b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0){k=this.reverseArrayPosition(g+""+(f-b));d=l+"-"+k;m.push(d);b++}}if(n.position_array[g][f]===e+"b"){b=1;while(g-b>=0&&f+b<=7){k=this.reverseArrayPosition((g-b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7&&g+b<=7){k=this.reverseArrayPosition((g+b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7&&f-b>=0){k=this.reverseArrayPosition((g+b)+""+(f-b));d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0&&g-b>=0){k=this.reverseArrayPosition((g-b)+""+(f-b));d=l+"-"+k;m.push(d);b++}}if(n.position_array[g][f]===e+"n"){if(g>=2&&f<=6){k=this.reverseArrayPosition((g-2)+""+(f+1));d=l+"-"+k;m.push(d)}if(g>=1&&f<=5){k=this.reverseArrayPosition((g-1)+""+(f+2));d=l+"-"+k;m.push(d)}if(g<=6&&f<=5){k=this.reverseArrayPosition((g+1)+""+(f+2));d=l+"-"+k;m.push(d)}if(g<=5&&f<=6){k=this.reverseArrayPosition((g+2)+""+(f+1));d=l+"-"+k;m.push(d)}if(g<=5&&f>=1){k=this.reverseArrayPosition((g+2)+""+(f-1));d=l+"-"+k;m.push(d)}if(g<=6&&f>=2){k=this.reverseArrayPosition((g+1)+""+(f-2));d=l+"-"+k;m.push(d)}if(g>=1&&f>=2){k=this.reverseArrayPosition((g-1)+""+(f-2));d=l+"-"+k;m.push(d)}if(g>=2&&f>=1){k=this.reverseArrayPosition((g-2)+""+(f-1));d=l+"-"+k;m.push(d)}}}}for(g=0;g<m.length;g++){l=m[g].split("-")[0];k=m[g].split("-")[1];if(!this.isLegal(n,l,k)){m.splice(g,1);g--}else{if(h){return true}}}if(h){return false}return m};CHESS.util.getLongNotation=function(l,a){var e,d,b="",k,h=a.replace(/[#+=xKQRBN]/g,""),c=(l.white_to_move?"w":"b"),m=a.substring(0,1),g="",f="";if(a==="O-O"){if(c==="w"){return"e1-g1"}else{return"e8-g8"}}else{if(a==="O-O-O"){if(c==="w"){return"e1-c1"}else{return"e8-c8"}}}if(h.length===3){g=h.substr(0,1);h=h.substr(h.length-2,2);if(/[0-9]/.test(g)){f="rank"}else{if(/[a-z]/.test(g)){g=g.charCodeAt(0)-97;f="file"}}}if(m!=="K"&&m!=="Q"&&m!=="W"&&m!=="R"&&m!=="B"&&m!=="N"){m="p"}m=m.toLowerCase();for(e=0;e<8;e++){for(d=0;d<8;d++){if(f==="rank"&&parseInt(g)!==(8-e)){continue}else{if(f==="file"&&parseInt(g)!==d){continue}}if(l.position_array[e][d].length>1&&l.position_array[e][d].substr(0,2)===c+m){k=this.reverseArrayPosition(e+""+d);if(this.isLegal(l,k,h)){b=k+"-"+h}}}}return b};CHESS.util.getArrayPosition=function(b){var a,d,c=false;if(/[a-h][1-8]/.test(b)){a=b.substr(0,1).toLowerCase();d=b.substr(1,1);a=a.charCodeAt(0)-97;d=8-d;c=a+""+d}return c};CHESS.util.reverseArrayPosition=function(b){var a=parseInt(b.substr(1,1)),c=parseInt(b.substr(0,1));a=String.fromCharCode(a+97);c=8-c;return a+""+c};CHESS.util.clonePositionArray=function(b){var a=0,c=[];for(a=0;a<8;a+=1){c[a]=b[a].slice(0)}return c};CHESS.util.moveTemp=function(c,b,a){CHESS.util.move(c,b,a)};CHESS.util.move=function(m,b,a,n){var r,q,f,e,d,p,c,o,t,s,h,g,x,l,w,k,v,u="",j;if(!this.isLegal(m,b,a)){return false}if(n!==undefined){n=n.toLowerCase()}m.last_move={sq1:this.getArrayPosition(b),sq2:this.getArrayPosition(a)};if(m.white_to_move){r=b;q=a;f=this.getArrayPosition(r);e=this.getArrayPosition(q);d=parseInt(f.substr(0,1));p=parseInt(f.substr(1,1));c=parseInt(e.substr(0,1));o=parseInt(e.substr(1,1));u=m.position_array[o][c];j=m.position_array[p][d];m.position_array[o][c]=m.position_array[p][d];m.position_array[p][d]="";f=this.getArrayPosition(r);if(j.substr(0,2)==="wp"&&o-p===-2){m.en_passant=this.reverseArrayPosition((o+1)+""+c)}else{m.en_passant=""}if(j.substr(0,2)==="wp"&&c!==d&&u===""){m.position_array[p][c]="";v=q.substr(0,1)+r.substr(1,1)}if(j.substr(0,2)==="wp"&&o===0){if(n==="r"){m.position_array[o][c]="wq"}else{if(n==="b"){m.position_array[o][c]="wb"}else{if(n==="n"){m.position_array[o][c]="wn"}else{m.position_array[o][c]="wq"}}}}if(j==="wk"&&r==="e1"){if(q==="g1"){m.position_array[7][5]="wrk";m.position_array[7][7]=""}else{if(q==="c1"){m.position_array[7][3]="wrq";m.position_array[7][0]=""}}}if(j==="wk"){m.gs_castle_kside_w=false;m.gs_castle_qside_w=false}else{if(j==="wr"&&r==="h1"){m.gs_castle_kside_w=false}else{if(j==="wr"&&r==="a1"){m.gs_castle_qside_w=false}else{if(u==="br"&&q==="a8"){m.gs_castle_qside_b=false}else{if(u==="br"&&q==="h8"){m.gs_castle_kside_b=false}}}}}m.white_to_move=false}else{t=b;s=a;h=this.getArrayPosition(t);g=this.getArrayPosition(s);x=parseInt(h.substr(0,1));l=parseInt(h.substr(1,1));w=parseInt(g.substr(0,1));k=parseInt(g.substr(1,1));u=m.position_array[k][w];j=m.position_array[l][x];m.position_array[k][w]=m.position_array[l][x];m.position_array[l][x]="";h=this.getArrayPosition(t);if(j.substr(0,2)==="bp"&&k-l===2){m.en_passant=this.reverseArrayPosition((k-1)+""+w)}else{m.en_passant=""}if(j.substr(0,2)==="bp"&&w!==x&&u===""){m.position_array[l][w]="";v=s.substr(0,1)+t.substr(1,1)}if(j.substr(0,2)==="bp"&&k===7){if(n==="r"){m.position_array[o][c]="bq"}else{if(n==="b"){m.position_array[o][c]="bb"}else{if(n==="n"){m.position_array[o][c]="bn"}else{m.position_array[o][c]="bq"}}}}if(j==="bk"&&t==="e8"){if(s==="g8"){m.position_array[0][5]="brk";m.position_array[0][7]=""}else{if(s==="c8"){m.position_array[0][3]="brq";m.position_array[0][0]=""}}}if(j==="bk"){m.gs_castle_kside_b=false;m.gs_castle_qside_b=false}else{if(j==="br"&&t==="h8"){m.gs_castle_kside_b=false}else{if(j==="br"&&t==="a8"){m.gs_castle_qside_b=false}else{if(u==="wr"&&s==="a1"){m.gs_castle_qside_w=false}else{if(u==="wr"&&s==="h1"){m.gs_castle_kside_w=false}}}}}m.white_to_move=true}if(this.isMate(m)||this.isStalemate(m)){m.active=false}return true};
CHESS.Board=function(d,e){var f,b={subscribers:{any:[]}},c=CHESS.util.createPosition(),a={container:null,canvas:null,ctx:null,snapshot:null,snapshot_ctx:null,snapshot_img:new Image(),square_size:0,square_color_light:"#ececd7",square_color_dark:"#7389b6",square_hover_light:"#b4d990",square_hover_dark:"#85c249",square_light:new Image(),square_dark:new Image(),dpi_ratio:1,dragok:false,drag_piece:"",drag_clear_i:0,drag_clear_j:0,image_path:"canvaschess/img/",left:0,top:0,last_draw_left:0,last_draw_top:0,loaded_pieces:0,piece_not_lifted:true,white_down:true,gc_opacity:"0.8",highlight_move:false,highlight_move_color:"#FF0000",highlight_move_opacity:"0.5",highlight_hover:false,piece_set:"canvaschess/img/pieces/merida/",show_row_col_labels:true,arrow_list:[],square_list:[],wp:new Image(),wr:new Image(),wn:new Image(),wb:new Image(),wq:new Image(),wk:new Image(),bp:new Image(),br:new Image(),bn:new Image(),bb:new Image(),bq:new Image(),bk:new Image()};b.myCancel=function(g){g.preventDefault();a.dragok=false;a.drag_piece="";a.left=0;a.top=0;a.takeSnapshot()};b.myDown=function(n){var h,g,k,m,l=a.canvas.getBoundingClientRect();if(c.active){if(n.hasOwnProperty("clientX")){a.left=n.clientX-l.left;a.top=n.clientY-l.top;a.canvas.style.cursor="move"}else{if(n.hasOwnProperty("changedTouches")){a.left=n.changedTouches[0].pageX-l.left;a.top=n.changedTouches[0].pageY-l.top}else{return}}a.top=a.top*a.dpi_ratio;a.left=a.left*a.dpi_ratio;h=parseInt(a.top/a.square_size,10);g=parseInt(a.left/a.square_size,10);if(!a.white_down){h=7-h;g=7-g}if(h<8){k=c.position_array[h][g]}else{if(c.mode==="setup"){k=c.piecebox_array[h-8][g]}}if(k===undefined){a.active=false;return}m=k.substr(0,1);if(c.mode!=="setup"&&((c.white_to_move&&m==="b")||(!c.white_to_move&&m==="w"))){a.canvas.style.cursor="default";return}if(k!==""){a.drag_clear_i=h;a.drag_clear_j=g;a.drag_piece=k;a.dragok=true;a.takeSnapshot(false)}else{a.canvas.style.cursor="default"}}};b.myMove=function(q){q.preventDefault();var r=a,l,k,w,o,z,p,n,m,h,v,u,s,t=r.canvas.getBoundingClientRect(),g=r.square_size*8;if(r.dragok){l=parseInt(r.top/r.square_size,10);k=parseInt(r.left/r.square_size,10);p=(k-1)*r.square_size;n=(l-1)*r.square_size;m=r.square_size*3;h=r.square_size*3;if(!(l<0||l>7||k<0||k>7)){if(p<0){p=0}if(n<0){n=0}if(p+m>g){m=g-p}if(n+h>g){h=g-n}r.ctx.drawImage(r.snapshot,p,n,m,h,p,n,m,h)}if(q.hasOwnProperty("clientX")){r.left=q.clientX-t.left;r.top=q.clientY-t.top}else{if(q.hasOwnProperty("changedTouches")){r.left=q.changedTouches[0].pageX-t.left;r.top=q.changedTouches[0].pageY-t.top}else{return}}r.top=r.top*r.dpi_ratio;r.left=r.left*r.dpi_ratio;l=parseInt(r.top/r.square_size,10);k=parseInt(r.left/r.square_size,10);if(l<0||l>7||k<0||k>7){return}if(r.highlight_hover){r.drawSquare("hover",l*r.square_size,k*r.square_size)}w=l;o=k;if(!r.white_down){w=7-l;o=7-k}z=c.position_array[w][o].substr(0,2);if(z!==""&&!(w===r.drag_clear_i&&o===r.drag_clear_j)){v=parseInt((k*r.square_size),10);u=parseInt((l*r.square_size),10);r.ctx.drawImage(r[z],v,u,r.square_size,r.square_size)}z=r.drag_piece.substr(0,2);v=parseInt(((r.left-(r.square_size/2))),10);u=parseInt(((r.top-(r.square_size/2))),10);s=r.square_size;if(c.mode==="setup"&&r.top>r.square_size*7.5){s=s-((r.top-r.square_size*7.5))}r.ctx.drawImage(r[z],v,u,r.square_size,s)}};b.myUp=function(o){var n,l,k=["a","b","c","d","e","f","g","h"],p,m,h,g,t,s,q=a.canvas.getBoundingClientRect(),r;if(c.active&&a.dragok){if(o.hasOwnProperty("clientX")){p=(o.clientX-q.left)*a.dpi_ratio;m=(o.clientY-q.top)*a.dpi_ratio;h=parseInt(m/a.square_size,10);g=parseInt(p/a.square_size,10);a.canvas.style.cursor="default"}else{if(o.hasOwnProperty("changedTouches")){p=(o.changedTouches[0].pageX-q.left)*a.dpi_ratio;m=(o.changedTouches[0].pageY-q.top)*a.dpi_ratio;h=parseInt(m/a.square_size,10);g=parseInt(p/a.square_size,10)}else{return}}if(!a.white_down){h=7-h;g=7-g}r=a.drag_piece;a.dragok=false;a.drag_piece="";a.left=0;a.top=0;a.piece_not_lifted=true;if(a.drag_clear_i>=8){n="piecebox"}else{n=k[a.drag_clear_j]+(8-a.drag_clear_i)}if(h>=8){l="piecebox"}else{l=k[g]+(8-h)}t=CHESS.util.getArrayPosition(n);s=CHESS.util.getArrayPosition(l);if(c.mode==="setup"){if(n!==l&&n!=="piecebox"&&l!=="piecebox"){c.position_array[s.substr(1,1)][s.substr(0,1)]=r;c.position_array[t.substr(1,1)][t.substr(0,1)]=""}else{if(n==="piecebox"&&l==="piecebox"){}else{if(n==="piecebox"){c.position_array[s.substr(1,1)][s.substr(0,1)]=r}else{if(l==="piecebox"){c.position_array[t.substr(1,1)][t.substr(0,1)]=""}}}}}else{c.move(n,l)}a.takeSnapshot()}};b.publish=function(g,h){this.visitSubscribers("publish",g,h)};b.visitSubscribers=function(m,h,l){var j=l||"any",n=this.subscribers[j],k,g=0;if(n!==undefined){g=n.length}for(k=0;k<g;k+=1){if(m==="publish"){n[k](h)}else{if(n[k]===h){n.splice(k,1)}}}};b.resize=function(i,k){var h,j,n=0,m=8,g=window.devicePixelRatio||1,l=a.ctx.webkitBackingStorePixelRatio||a.ctx.mozBackingStorePixelRatio||a.ctx.msBackingStorePixelRatio||a.ctx.oBackingStorePixelRatio||a.ctx.BackingStorePixelRatio||1;i=i||0;k=k||0;i=parseInt(i,10);k=parseInt(k,10);if(i===0||k===0){if(a.canvas.parentNode){i=parseInt(window.getComputedStyle(a.canvas.parentNode,null).getPropertyValue("height"),10);k=parseInt(window.getComputedStyle(a.canvas.parentNode,null).getPropertyValue("width"),10)}}n=(i<k?i:k);if(c.mode==="setup"){m=10}a.square_size=(i<k?parseInt(n/m,10):parseInt(n/8,10));a.canvas.height=a.square_size*m;a.canvas.width=a.square_size*8;a.dpi_ratio=g/l;if(g!==l){h=a.canvas.width,j=a.canvas.height;a.canvas.width=h*a.dpi_ratio;a.canvas.height=j*a.dpi_ratio;a.canvas.style.width=h+"px";a.canvas.style.height=j+"px";a.square_size=a.canvas.width/8}};c.move=function(h,g){var m={position_array:CHESS.util.clonePositionArray(this.position_array),white_to_move:this.white_to_move,en_passant:this.en_passant,active:this.active,gs_castle_kside_w:this.gs_castle_kside_w,gs_castle_qside_w:this.gs_castle_qside_w,gs_castle_kside_b:this.gs_castle_kside_b,gs_castle_qside_b:this.gs_castle_qside_b},j={fen:CHESS.util.getFEN(this),player_to_move:(this.white_to_move?"w":"b"),sq1:h,sq2:g,promote:false,mate:false,stalemate:false},l,k,i;if(this.last_move){m.last_move={sq1:this.last_move.sq1,sq2:this.last_move.sq2}}l=CHESS.util.getArrayPosition(h);k=CHESS.util.getArrayPosition(g);i=c.position_array[l.substr(1,1)][l.substr(0,1)].substr(1,1);if(i==="p"&&((c.white_to_move&&g.substr(1,1)==="8")||(!c.white_to_move&&g.substr(1,1)==="1"))){j.promote=true}if(!CHESS.util.move(m,h,g)){a.takeSnapshot();return}a.arrow_list=[];if(CHESS.util.isMate(m)){j.mate=true}else{if(CHESS.util.isStalemate(m)){j.stalemate=true}}b.publish(j,"move_before");this.position_array=CHESS.util.clonePositionArray(m.position_array);this.white_to_move=m.white_to_move;this.en_passant=m.en_passant;this.active=m.active;this.gs_castle_kside_w=m.gs_castle_kside_w;this.gs_castle_qside_w=m.gs_castle_qside_w;this.gs_castle_kside_b=m.gs_castle_kside_b;this.gs_castle_qside_b=m.gs_castle_qside_b;this.moves+=1;if(m.last_move){this.last_move={sq1:m.last_move.sq1,sq2:m.last_move.sq2}}a.takeSnapshot();if(!this.active){return}};c.setPosition=function(g){CHESS.util.setPosition(this,g)};a.buildHtml=function(g){this.canvas=document.createElement("canvas");this.canvas.className="chessboard";this.canvas.setAttribute("tabindex",0);this.ctx=this.canvas.getContext("2d");this.snapshot=document.createElement("canvas");this.snapshot_ctx=this.snapshot.getContext("2d");if(g!==undefined){document.getElementById(g).appendChild(this.canvas)}};a.arrowAdd=function(i,g,h,j){var k=CHESS.hexToRgba(h);k.a=j;this.arrow_list.push({sq1:i,sq2:g,rgba:k})};a.arrowDraw=function(i,g,p){var v,u,x,m,w,l,s,D,r,A,q=a.square_size/6,t=this.square_size/2.4,y=Math.PI/6,C,h,k,o,n,j,B,z;v=CHESS.util.getArrayPosition(i);u=CHESS.util.getArrayPosition(g);x=v.substr(0,1);m=v.substr(1,1);w=u.substr(0,1);l=u.substr(1,1);if(!a.white_down){x=7-x;m=7-m;w=7-w;l=7-l}x=x*this.square_size+(this.square_size/2);m=m*this.square_size+(this.square_size/2);w=w*this.square_size+(this.square_size/2);l=l*this.square_size+(this.square_size/2);if(x===w){s=w;D=(l>m?l-t:l+t)}else{r=(l-m)/(w-x);A=Math.sqrt(((t*t)/(1+r*r)));s=(w>x?w-A:w+A);D=r*(s-w)+l}this.snapshot_ctx.beginPath();this.snapshot_ctx.strokeStyle="rgba("+p.r+","+p.g+","+p.b+", "+p.a+")";this.snapshot_ctx.fillStyle="rgba("+p.r+","+p.g+","+p.b+", "+p.a+")";this.snapshot_ctx.lineWidth=q;this.snapshot_ctx.moveTo(x,m);this.snapshot_ctx.lineTo(s,D);this.snapshot_ctx.stroke();C=Math.atan2(l-m,w-x);h=Math.abs(t/Math.cos(y));k=C+Math.PI+y;o=w+Math.cos(k)*h;n=l+Math.sin(k)*h;j=C+Math.PI-y;B=w+Math.cos(j)*h;z=l+Math.sin(j)*h;this.snapshot_ctx.beginPath();this.snapshot_ctx.lineWidth=2;this.snapshot_ctx.moveTo(B,z);this.snapshot_ctx.lineTo(o,n);this.snapshot_ctx.lineTo(w,l);this.snapshot_ctx.lineTo(B,z);this.snapshot_ctx.fill()};a.arrowDrawAll=function(){var k,h,g,j;for(k=0;k<this.arrow_list.length;k+=1){h=this.arrow_list[k].sq1;g=this.arrow_list[k].sq2;j=this.arrow_list[k].rgba;a.arrowDraw(h,g,j)}};a.setActive=function(g){c.active=(g===true);if(c.active){a.canvas.onmousedown=b.myDown;a.canvas.onmouseup=b.myUp;a.canvas.onmousemove=b.myMove;a.canvas.addEventListener("touchstart",b.myDown,false);a.canvas.addEventListener("touchend",b.myUp,false);a.canvas.addEventListener("touchmove",b.myMove,false);a.canvas.addEventListener("touchleave",b.myCancel,false);a.canvas.addEventListener("touchcancel",b.myCancel,false)}else{a.canvas.removeEventListener("touchstart",b.myDown);a.canvas.removeEventListener("touchend",b.myUp);a.canvas.removeEventListener("touchmove",b.myMove);a.canvas.removeEventListener("touchleave",b.myCancel);a.canvas.removeEventListener("touchcancel",b.myCancel)}};a.squareAdd=function(j,g,h){var i=CHESS.hexToRgba(g);i.a=h;this.square_list.push({sq:j,rgba:i})};a.squareDraw=function(i,h){var j,g,k;j=CHESS.util.getArrayPosition(i);g=j.substr(0,1);k=j.substr(1,1);if(!a.white_down){g=7-g;k=7-k}this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle="rgba("+h.r+","+h.g+","+h.b+", "+h.a+")";this.snapshot_ctx.rect(g*this.square_size,k*this.square_size,this.square_size,this.square_size);this.snapshot_ctx.fill()};a.squareDrawAll=function(){var h,j,g;for(h=0;h<this.square_list.length;h+=1){j=this.square_list[h].sq;g=this.square_list[h].rgba;a.squareDraw(j,g)}};a.drawPiece=function(h,g,i){if(!/[bw][kqrbnp]/.test(h)){return}this.snapshot_ctx.drawImage(this[h],g,i,this.square_size,this.square_size)};a.drawSquare=function(l,p,o,g){var q=g||this.snapshot_ctx,j,h=parseInt(p/this.square_size,10),r=parseInt(o/this.square_size,10),m,i,n=parseInt(this.square_size/55*13,10),k=parseInt(this.square_size/55*9,10);if(l==="hover"){this.ctx.beginPath();if((h+r)%2===0){this.ctx.fillStyle=this.square_hover_light}else{this.ctx.fillStyle=this.square_hover_dark}this.ctx.rect(r*this.square_size,h*this.square_size,this.square_size,this.square_size);this.ctx.fill()}else{j=(l==="light"?this.square_light:this.square_dark);if(j.src!==""){this.snapshot_ctx.drawImage(j,p,o,this.square_size,this.square_size)}else{this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=(l==="light"?this.square_color_light:this.square_color_dark);this.snapshot_ctx.rect(p,o,this.square_size,this.square_size);this.snapshot_ctx.fill()}}if(this.show_row_col_labels&&(r===7||h===0)){i=parseInt(this.square_size/55*12,10),this.snapshot_ctx.font=i+"px arial";this.snapshot_ctx.fillStyle=(((7-r)+h)%2===0?this.square_color_light:this.square_color_dark);if(h===0){if(this.white_down){m=8-r}else{m=r+1}this.snapshot_ctx.fillText(m,2,(r*this.square_size)+n)}if(r===7){if(this.white_down){m=String.fromCharCode(h+97)}else{m=String.fromCharCode((7-h)+97)}this.snapshot_ctx.fillText(m,((this.square_size*h)+this.square_size)-k,(this.square_size*8)-2)}}};a.takeSnapshot=function(p){var l,h,s,m,r,q,n,k,u,t=8,o,g=CHESS.hexToRgba(this.highlight_move_color);if(c.mode==="setup"){t=10}this.snapshot.width=this.square_size*8;this.snapshot.height=this.square_size*t;for(q=0;q<8;q+=1){for(r=0;r<8;r+=1){if((r+q)%2===0){n=r*this.square_size;k=q*this.square_size;this.drawSquare("light",n,k)}}}for(q=0;q<8;q+=1){for(r=0;r<8;r+=1){if((r+q)%2!==0){n=r*this.square_size;k=q*this.square_size;this.drawSquare("dark",n,k)}}}if(this.highlight_move){if(typeof c.last_move==="object"&&c.last_move.sq1!==undefined){this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle="rgba("+g.r+","+g.g+","+g.b+", "+this.highlight_move_opacity+")";r=c.last_move.sq1.substr(0,1);q=c.last_move.sq1.substr(1,1);if(!this.white_down){r=7-r;q=7-q}this.snapshot_ctx.rect(r*this.square_size,q*this.square_size,this.square_size,this.square_size);r=c.last_move.sq2.substr(0,1);q=c.last_move.sq2.substr(1,1);if(!this.white_down){r=7-r;q=7-q}this.snapshot_ctx.rect(r*this.square_size,q*this.square_size,this.square_size,this.square_size);this.snapshot_ctx.fill()}}this.squareDrawAll();for(l=0;l<8;l+=1){for(h=0;h<8;h+=1){if(!this.dragok||!(l===this.drag_clear_i&&h===this.drag_clear_j)){u=c.position_array[l][h].substr(0,2);s=l;m=h;if(!this.white_down){s=7-l;m=7-h}r=m*this.square_size;q=s*this.square_size;if(u!==""){this.drawPiece(u,r,q)}}}}if(c.mode==="setup"){for(l=0;l<2;l+=1){for(h=0;h<8;h+=1){u=c.piecebox_array[l][h].substr(0,2);r=h*this.square_size;q=(l+8)*this.square_size;if(u!==""){this.drawPiece(u,r,q)}}}}if(this.dragok){l=this.drag_clear_i;h=this.drag_clear_j;if(!this.white_down){l=7-this.drag_clear_i;h=7-this.drag_clear_j}o=(l+h)%2===0;if(o){if(this.square_light.src!==""){this.drawSquare("light",h*this.square_size,l*this.square_size,this.ctx)}else{this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=this.square_color_light;this.snapshot_ctx.rect(h*this.square_size,l*this.square_size,this.square_size,this.square_size);this.snapshot_ctx.fill()}}else{if(this.square_dark.src!==""){this.drawSquare("dark",h*this.square_size,l*this.square_size,this.ctx)}else{this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=this.square_color_dark;this.snapshot_ctx.rect(h*this.square_size,l*this.square_size,this.square_size,this.square_size);this.snapshot_ctx.fill()}}}this.arrowDrawAll();if(p===undefined){p=true}if(p){this.ctx.clearRect(0,this.square_size*8,this.square_size*8,this.square_size*2);this.ctx.drawImage(this.snapshot,0,0)}};this.addArrow=function(i,g,h,j){j=parseFloat(j);j=(j>=0&&j<=1?j:a.gc_opacity);j=(j>=0&&j<=1?j:1);a.arrowAdd(i,g,h,j);a.takeSnapshot()};this.addSquare=function(i,g,h){h=parseFloat(h);h=(h>=0&&h<=1?h:a.gc_opacity);h=(h>=0&&h<=1?h:1);a.squareAdd(i,g,h);a.takeSnapshot()};this.display=function(){a.takeSnapshot()};this.flip=function(g){if(g==="w"){a.white_down=true}else{if(g==="b"){a.white_down=false}else{a.white_down=!a.white_down}}a.takeSnapshot()};this.getActiveColor=function(){return(c.white_to_move?"w":"b")};this.getFEN=function(){return CHESS.util.getFEN(c)};this.getCanvas=function(){return a.canvas};this.getImage=function(){var g=new Image();g.src=a.canvas.toDataURL("image/png");return g};this.isInsufficientMaterial=function(){return CHESS.util.isInsufficientMaterial(c)};this.isMate=function(){return CHESS.util.isMate(c)};this.isStalemate=function(){return CHESS.util.isStalemate(c)};this.move=function(j){var i,h,g;i=CHESS.util.getLongNotation(c,j);i=i.split("-");h=i[0];g=i[1];c.move(h,g)};this.positionClear=function(){c.position_array=[["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""]];c.last_move={};c.en_passant="";c.white_to_move=true;c.gs_castle_kside_w=true;c.gs_castle_qside_w=true;c.gs_castle_kside_b=true;c.gs_castle_qside_b=true;c.moves=0;a.takeSnapshot()};this.positionStart=function(){c.position_array=[["br","bn","bb","bq","bk","bb","bn","br"],["bp","bp","bp","bp","bp","bp","bp","bp"],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["wp","wp","wp","wp","wp","wp","wp","wp"],["wr","wn","wb","wq","wk","wb","wn","wr"]];c.last_move={};c.en_passant="";c.white_to_move=true;c.gs_castle_kside_w=true;c.gs_castle_qside_w=true;c.gs_castle_kside_b=true;c.gs_castle_qside_b=true;c.moves=0;a.takeSnapshot()};this.removeArrow=function(){a.arrow_list.pop();a.takeSnapshot()};this.removeAllArrows=function(){a.arrow_list=[];a.takeSnapshot()};this.removeSquare=function(){a.square_list.pop();a.takeSnapshot()};this.removeAllSquares=function(){a.square_list=[];a.takeSnapshot()};this.resize=function(g,h){b.resize(g,h);a.takeSnapshot()};this.setActive=function(g){a.setActive(g)};this.setLastMove=function(h,g){h=CHESS.util.getArrayPosition(h);g=CHESS.util.getArrayPosition(g);c.last_move={sq1:h,sq2:g}};this.setMode=function(g){c.mode=g;if(g==="setup"){}b.resize(a.canvas.height,a.canvas.width);a.takeSnapshot()};this.setPosition=function(g){c.setPosition(g);a.takeSnapshot()};this.subscribe=function(h,g){h=h||"any";if(b.subscribers[h]===undefined){b.subscribers[h]=[]}b.subscribers[h].push(g)};this.unsubscribe=function(h,g){b.visitSubscribers("unsubscribe",h,g)};f=function(){var g;function h(){if(typeof e==="function"&&a.loaded_pieces===12){e()}}a.buildHtml(d.container);a.highlight_move=(d.highlight_move===true?true:false);a.highlight_hover=(d.highlight_hover===true?true:false);a.show_row_col_labels=(d.show_row_col_labels===false?false:true);a.square_color_light=(d.square_color_light?d.square_color_light:a.square_color_light);a.square_color_dark=(d.square_color_dark?d.square_color_dark:a.square_color_dark);a.gc_opacity=(d.gc_opacity?d.gc_opacity:a.gc_opacity);a.highlight_move_color=(d.highlight_move_color?d.highlight_move_color:a.highlight_move_color);a.highlight_move_opacity=(d.highlight_move_opacity?d.highlight_move_opacity:a.highlight_move_opacity);a.square_hover_light=(d.square_hover_light?d.square_hover_light:a.square_hover_light);a.square_hover_dark=(d.square_hover_dark?d.square_hover_dark:a.square_hover_dark);a.piece_set=(d.piece_set?d.piece_set:a.piece_set);c.mode=d.mode;if(d.fen){c.setPosition(d.fen)}else{c.setPosition("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")}b.resize(d.height,d.width);g=a.piece_set.replace(/\/$/,"");a.wp.src=g+"/wp.svg";a.wp.onload=function(){a.loaded_pieces+=1;if(a.loaded_pieces===12){a.takeSnapshot()}};a.wr.src=g+"/wr.svg";a.wr.onload=function(){a.loaded_pieces+=1;if(a.loaded_pieces===12){a.takeSnapshot();h()}};a.wn.src=g+"/wn.svg";a.wn.onload=function(){a.loaded_pieces+=1;if(a.loaded_pieces===12){a.takeSnapshot();h()}};a.wb.src=g+"/wb.svg";a.wb.onload=function(){a.loaded_pieces+=1;if(a.loaded_pieces===12){a.takeSnapshot();h()}};a.wq.src=g+"/wq.svg";a.wq.onload=function(){a.loaded_pieces+=1;if(a.loaded_pieces===12){a.takeSnapshot();h()}};a.wk.src=g+"/wk.svg";a.wk.onload=function(){a.loaded_pieces+=1;if(a.loaded_pieces===12){a.takeSnapshot();h()}};a.bp.src=g+"/bp.svg";a.bp.onload=function(){a.loaded_pieces+=1;if(a.loaded_pieces===12){a.takeSnapshot();h()}};a.br.src=g+"/br.svg";a.br.onload=function(){a.loaded_pieces+=1;if(a.loaded_pieces===12){a.takeSnapshot();h()}};a.bn.src=g+"/bn.svg";a.bn.onload=function(){a.loaded_pieces+=1;if(a.loaded_pieces===12){a.takeSnapshot();h()}};a.bb.src=g+"/bb.svg";a.bb.onload=function(){a.loaded_pieces+=1;if(a.loaded_pieces===12){a.takeSnapshot();h()}};a.bq.src=g+"/bq.svg";a.bq.onload=function(){a.loaded_pieces+=1;if(a.loaded_pieces===12){a.takeSnapshot();h()}};a.bk.src=g+"/bk.svg";a.bk.onload=function(){a.loaded_pieces+=1;if(a.loaded_pieces===12){a.takeSnapshot();h()}};if(typeof d.square_dark==="string"){a.square_dark.src=d.square_dark;a.square_dark.onload=function(){a.takeSnapshot()}}if(typeof d.square_light==="string"){a.square_light.src=d.square_light;a.square_light.onload=function(){a.takeSnapshot()}}};f()};
CHESS.PgnViewer=function(d){var e,b={},c={black:"",date:"",event:"",result:"",round:"",site:"",white:"",fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",game_list:[]},a={board:null,board_control_box:null,container:null,control_box:null,control_end_elem:null,control_next_elem:null,control_pause_elem:null,control_play_elem:null,control_prev_elem:null,control_start_elem:null,current_move:null,download_btn:null,flip_board_btn:null,game_list:null,header_box:null,header_date_elem:null,header_details_box:null,header_event_elem:null,header_players_elem:null,header_result_elem:null,header_site_elem:null,main_box:null,move_control_box:null,move_list:null,ply:0,start_end_variation:false};b.goEnd=function(){if(a.current_move!==null){a.changeMove(a.current_move.parentNode.lastChild)}};b.goNext=function(){var f;if(a.current_move!==null){f=a.getSiblingMove(a.current_move,1);a.changeMove(f)}};b.goPrev=function(){var f;if(a.current_move!==null){f=a.getSiblingMove(a.current_move,-1);a.changeMove(f)}};b.goStart=function(){if(a.current_move!==null){a.changeMove(a.current_move.parentNode.firstChild)}};b.updateBoard=function(j){var f,h,g;a.board.setPosition(j.currentTarget.fen);a.board.setLastMove(j.currentTarget.move.sq1,j.currentTarget.move.sq2);a.board.removeAllArrows();a.board.removeAllSquares();if(typeof(j.currentTarget.gc)==="object"){h=j.currentTarget.gc;if(h.arrows.length>=1){for(f=0;f<h.arrows.length;f+=1){if(h.arrows[f].color==="R"){g="#F00"}else{if(h.arrows[f].color==="Y"){g="#FF0"}else{g="#0F0"}}a.board.addArrow(h.arrows[f].sq1,h.arrows[f].sq2,g)}}if(h.squares.length>=1){for(f=0;f<h.squares.length;f+=1){if(h.squares[f].color==="R"){g="#F00"}else{if(h.squares[f].color==="Y"){g="#FF0"}else{g="#0F0"}}a.board.addSquare(h.squares[f].sq,g)}}}a.board.display();if(a.current_move!==null){a.current_move.removeAttribute("class")}j.currentTarget.className="current";a.current_move=j.currentTarget};a.buildHtml=function(g,f){var h=document;if(g.id!==undefined){this.container=h.getElementById(g.id)}if(this.container===undefined||this.container===null){h.write("<div id='canvaschess' class='canvaschesspgn'></div>");this.container=h.getElementById("canvaschess");this.container.removeAttribute("id")}if(g.mobile){this.container.classList.add("mobile")}this.container.setAttribute("tabindex",0);this.main_box=h.createElement("div");this.main_box.className="pgn_main_box";this.container.appendChild(this.main_box);this.buildHtmlHeader();this.buildHtmlControls();this.main_box.appendChild(f);this.move_list=h.createElement("ol");this.move_list.className="move_list";this.main_box.appendChild(this.move_list);a.resize()};a.buildHtmlControls=function(){var f=document;this.control_box=f.createElement("div");this.control_box.className="pgn_control_box";this.container.appendChild(this.control_box);this.board_control_box=f.createElement("span");this.board_control_box.className="board_controls";this.control_box.appendChild(this.board_control_box);this.flip_board_btn=f.createElement("a");this.flip_board_btn.className="board_ctrl_btn board_flip";this.flip_board_btn.title="Flip";this.flip_board_btn.onclick=this.board.flip;this.download_btn=f.createElement("a");this.download_btn.className="board_ctrl_btn board_download";this.download_btn.title="Download PGN";this.board_control_box.appendChild(this.flip_board_btn);this.board_control_box.appendChild(this.download_btn);this.move_control_box=f.createElement("span");this.move_control_box.className="move_controls";this.control_box.appendChild(this.move_control_box);this.control_play_elem=f.createElement("a");this.control_play_elem.className="pgn_ctrl_btn pgn_play";this.control_play_elem.title="Play";this.control_play_elem.onclick=b.goPlay;this.control_pause_elem=f.createElement("a");this.control_pause_elem.className="pgn_ctrl_btn pgn_pause";this.control_pause_elem.title="Pause";this.control_pause_elem.onclick=b.goPause;this.control_start_elem=f.createElement("a");this.control_start_elem.className="pgn_ctrl_btn pgn_start";this.control_start_elem.title="Start";this.control_start_elem.onclick=b.goStart;this.control_prev_elem=f.createElement("a");this.control_prev_elem.className="pgn_ctrl_btn pgn_prev";this.control_prev_elem.title="Previous";this.control_prev_elem.onclick=b.goPrev;this.control_next_elem=f.createElement("a");this.control_next_elem.className="pgn_ctrl_btn pgn_next";this.control_next_elem.title="Next";this.control_next_elem.onclick=b.goNext;this.control_end_elem=f.createElement("a");this.control_end_elem.className="pgn_ctrl_btn pgn_end";this.control_end_elem.title="End";this.control_end_elem.onclick=b.goEnd;this.move_control_box.appendChild(this.control_start_elem);this.move_control_box.appendChild(this.control_prev_elem);this.move_control_box.appendChild(this.control_next_elem);this.move_control_box.appendChild(this.control_end_elem)};a.buildHtmlHeader=function(){var f=document;this.header_box=f.createElement("div");this.header_box.className="pgn_header_box";this.container.insertBefore(this.header_box,this.container.firstChild);this.header_details_box=f.createElement("div");this.header_details_box.className="pgn_header_details_box";this.header_box.appendChild(this.header_details_box);this.header_players_elem=f.createElement("span");this.header_players_elem.className="pgn_players";this.header_players_elem.title="Players";this.header_event_elem=f.createElement("span");this.header_event_elem.className="pgn_event";this.header_event_elem.title="Event";this.header_site_elem=f.createElement("span");this.header_site_elem.className="pgn_site";this.header_site_elem.title="Site";this.header_date_elem=f.createElement("span");this.header_date_elem.className="pgn_date";this.header_date_elem.title="Date";this.header_result_elem=f.createElement("span");this.header_result_elem.className="pgn_result";this.header_result_elem.title="Result";this.header_details_box.appendChild(this.header_players_elem);this.header_details_box.appendChild(this.header_event_elem);this.header_details_box.appendChild(this.header_site_elem);this.header_details_box.appendChild(this.header_date_elem);this.header_details_box.appendChild(this.header_result_elem);this.game_list=f.createElement("select");this.game_list.className="game_list";this.game_list.onchange=function(g){a.changeGame(g.currentTarget.value)};this.header_box.appendChild(this.game_list)};a.changeGame=function(h){var t,q,g,s,z,k,v,u,r,n,x,l,p,m,f={comment:"",gc:null},y;c.event="";c.site="";c.date="";c.round="";c.white="";c.black="";c.result="";c.fen="";while(this.move_list.firstChild){this.move_list.removeChild(this.move_list.firstChild)}this.current_move=null;g=c.game_list[h];s=g.match(/\[([^\[%]+)\]/g);for(t=0;t<s.length;t+=1){z=s[t].match(/\[(\S+)\s"(.*)"\]/);z[1]=z[1].replace(/\s+$/,"");z[2]=z[2].replace(/\s+$/,"");switch(z[1].toLowerCase()){case"event":c.event=z[2];break;case"site":c.site=z[2];break;case"date":c.date=z[2];break;case"round":c.round=z[2];break;case"white":c.white=z[2];break;case"black":c.black=z[2];break;case"result":c.result=z[2];break;case"fen":c.fen=z[2];break}}if(c.fen===""){c.fen="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"}this.displayHeader();k=g.match(/\]\s+([{\w][\s\S]+$)/)[1];k=k.replace(/\s*1-0\s*$/,"");k=k.replace(/\s*0-1\s*$/,"");k=k.replace(/\s*1\/2-1\/2\s*$/,"");k=k.replace(/\s*\*\s*$/,"");m=k.match(/\{[^{]*\}/g);k=k.replace(/\{[^{]*\}/g,"{}");v=k.match(/^(\{\})|(\d+[.]{1,3}).+?(?=(\d+[.]{1,3})|$)/g);if(v[0]==="{}"){f=this.getComment(m);this.move(null,f.comment,null,f.gc);f.comment="";f.gc=null}for(t=0;t<v.length;t+=1){u=v[t].match(/\d+[.]{1,3}\s?((?:[^ )]+)\s?(?:\$[\d]+)?)\s?(?:\{\})?/);if(u!==null){x=u[1].match(/([!?=]+)\s*$/);x=(x&&x[0]?x[0]:null);n=u[1].match(/\$(\d+)/);n=(n&&n[1]?n[1]:null);if(n!==null){l=CHESS.nag_code[n];n="<span class='nagcode' title='"+l.desc+"'>"+l.symbol+"</span>"}if(n){p=n}else{if(x){p=x}else{p=""}}u[1]=u[1].replace(/[^1-8a-hRNBQKOx\-]*$/,"");u[1]=u[1].replace(/\s*\$.*$/,"");if(/\{\}/.test(u[0])){f=this.getComment(m)}this.move(u[1],f.comment,p,f.gc);f.comment="";f.gc=null;v[t]=v[t].replace(u[0],"");r=v[t].match(/((?:\w[^ )]+)\s?(?:\$[\d]+)?)\s?(?:\{\})?/);if(r!==null){x=r[1].match(/([!?=]+)\s*$/);x=(x&&x[0]?x[0]:null);n=r[1].match(/\$(\d+)/);n=(n&&n[1]?n[1]:null);if(n!==null){l=CHESS.nag_code[n];n="<span class='nagcode' title='"+l.desc+"'>"+l.symbol+"</span>"}if(n){p=n}else{if(x){p=x}else{p=""}}r[1]=r[1].replace(/[^1-8a-hRNBQKOx\-]*$/,"");r[1]=r[1].replace(/\s*\$.*$/,"");if(/\{\}/.test(r[0])){f=this.getComment(m)}this.move(r[1],f.comment,p,f.gc);f.comment="";f.gc=null}if(/\)/.test(v[t])){y=v[t].match(/\)/g).length;for(q=0;q<y;q+=1){this.endVariation()}}if(/\(/.test(v[t])){this.startVariation();if(/\(\s?\{\}/.test(v[t])){f=this.getComment(m);var o=document.createElement("li");o.move="";var w=document.createElement("span");w.setAttribute("class","comment");w.innerHTML=f.comment;o.appendChild(w);if(f.gc!==undefined&&f.gc!==null){o.gc=f.gc}o.setAttribute("data-ply",this.ply);o.fen=a.getSiblingMove(this.current_move.parentNode.previousSibling,-1).fen;o.onclick=b.updateBoard;this.current_move.appendChild(o);f.comment="";f.gc=null}}}}this.current_move=a.move_list.getElementsByTagName("li")[0];this.board.setPosition(this.current_move.fen);b.updateBoard({currentTarget:this.current_move});a.move_list.scrollTop=0};a.getComment=function(j){var g,f={comment:"",gc:{arrows:[],squares:[]}},n,h,m,k,o,l;f.comment=j.shift().replace(/\{/,"").replace(/\}/,"");if(/\[%cal/.test(f.comment)){n=f.comment.match(/\[%cal (?:[GYR]\w{2}\w{2},?\s*)+\]/)[0];h=n.match(/[GYR]\w{2}\w{2},?\s*/g);for(g=0;g<h.length;g+=1){m=h[g].match(/([GYR])(\w{2})(\w{2}),?\s*/);k=m[1];o=m[2];l=m[3];f.gc.arrows.push({color:k,sq1:o,sq2:l})}f.comment=f.comment.replace(n,"")}if(/\[%csl/.test(f.comment)){n=f.comment.match(/\[%csl (?:[GYR]\w{2},?\s*)+\]/)[0];h=n.match(/[GYR]\w{2},?\s*/g);for(g=0;g<h.length;g+=1){m=h[g].match(/([GYR])(\w{2}),?\s*/);k=m[1];o=m[2];f.gc.squares.push({color:k,sq:o})}f.comment=f.comment.replace(n,"")}f.comment=f.comment.replace(/^\s+|\s+$/g,"");return f};a.changeMove=function(g){var f;if(a.current_move!==g){if(a.current_move!==null&&g!==null){a.current_move.removeAttribute("class")}if(g!==null){g.className="current";b.updateBoard({currentTarget:g});a.current_move=g;f=a.current_move.offsetTop-a.move_list.offsetTop;f-=parseInt(a.move_list.offsetHeight/2,10);a.move_list.scrollTop=f}}};a.displayHeader=function(){if(d.show_tags===false){this.header_details_box.style.display="none"}else{this.header_date_elem.innerHTML=this.getPgnDate(c.date);this.header_players_elem.innerHTML=c.white+" vs "+c.black;this.header_event_elem.innerHTML=c.event;this.header_site_elem.innerHTML=c.site;this.header_result_elem.innerHTML=c.result}};a.endVariation=function(){this.current_move=this.current_move.parentNode.parentNode.previousSibling;this.ply=(+this.current_move.getAttribute("data-ply"));this.start_end_variation=true;return this};a.getPgnDate=function(h){var j=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Jun","Sep","Oct","Nov","Dec"],l=h.split("."),i="",k="",g="",f;if(l.length===3&&l[0].length===4&&l[1].length===2&&l[2].length===2){i=l[0];k=parseInt(l[1],10);g=parseInt(l[2],10);k=(k>0&&k<13?j[k]:"");f=(g>0?g+" ":"")+(k!==""?k+" ":"")+(i>0?i+" ":"");f=f.replace(/\s+$/,"")}return f};a.getSiblingMove=function(f,g){if(g===1){while(f=f.nextSibling){if(!(/variation_list/.test(f.className))){break}}}else{if(g===-1){while(f=f.previousSibling){if(!(/variation_list/.test(f.className))){break}}}}return f};a.importFile=function(k){var j,g,f,n,h,m,l;k=k.replace(/^ +/gm,"").replace(/$ +/gm,"");k=k.replace(/\n/g," ").replace(/\s+/g," ");c.game_list=k.split(/[^\w](?:(?:1-0)|(?:0-1)|(?:1\/2-1\/2)|\*)\s*(?=\[)/);if(c.game_list.length>1){for(j=0;j<c.game_list.length;j+=1){g=c.game_list[j];f=g.match(/\[\s*white\s+['"](.*?)['"]\]/i);f=(f!==null&&f.length>1?f[1]:"");n=g.match(/\[\s*black\s+['"](.*?)['"]\]/i);n=(n!==null&&n.length>1?n[1]:"");h=g.match(/\[\s*date\s+['"]([0-9.?]+)['"]\]/i);h=(h!==null&&h.length>1?h[1]:"");m=f+" vs. "+n;l=document.createElement("option");l.value=j;l.text=m;this.game_list.appendChild(l)}}else{this.game_list.style.display="none"}this.changeGame(0)};a.move=function(m,p,r,u){var k,v,t,g,i,l,s,q,j,n,f,h,o="";if(!m&&!p&&!u){return this}if(this.current_move===null){k=document.createElement("li");if(c.fen.length>0){k.fen=c.fen;n=k.fen.match(/\s+([wbWB])\s+([-kqKQ]+)\s+([-\w]{1,2})\s+(\d+)\s+(\d+)\s*$/);f=n[1].toLowerCase();i=+n[5];this.ply=(i*2)-(f==="w"?2:1);k.setAttribute("data-ply",this.ply)}else{k.setAttribute("data-ply",0)}k.move="";k.onclick=b.updateBoard;this.move_list.appendChild(k);this.current_move=k;if(!m&&typeof p==="string"){g=document.createElement("span");g.setAttribute("class","comment");g.innerHTML=p;k.appendChild(g);if(u!==undefined&&u!==null){k.gc=u}return}}i=(this.ply%2===0?(parseInt(this.ply/2,10)+1)+".&nbsp;":"");if(this.ply%2===1&&this.start_end_variation){i=(parseInt((this.ply-1)/2,10)+1)+"..."}this.start_end_variation=false;this.ply+=1;t=m;if(d.figurine!==false){switch(m.charAt(0)){case"K":t="<span class='figurine fig_k'>K</span>"+m.substring(1);break;case"Q":t="<span class='figurine fig_q'>Q</span>"+m.substring(1);break;case"R":t="<span class='figurine fig_r'>R</span>"+m.substring(1);break;case"B":t="<span class='figurine fig_b'>B</span>"+m.substring(1);break;case"N":t="<span class='figurine fig_n'>N</span>"+m.substring(1);break}}v=document.createElement("span");v.setAttribute("class","move_text");k=document.createElement("li");k.setAttribute("data-ply",this.ply);k.appendChild(v);if(this.current_move.fen===undefined){if(this.current_move.className==="variation"){l=a.getSiblingMove(this.current_move.parentNode.previousSibling,-1).fen}}else{l=this.current_move.fen}s=CHESS.util.createPosition(l);q=CHESS.util.getLongNotation(s,m);j=q.split("-");if(/=[QRBN]/.test(m)){h=m.match(/=([QRBN])/)[1]}CHESS.util.move(s,j[0],j[1],h);l=CHESS.util.getFEN(s);if(CHESS.util.isCheck(s.position_array,(s.white_to_move?"w":"b"))){o="+";if(CHESS.util.isMate(s)){o="#"}}v.innerHTML=i+t+o+" "+r+" ";k.move={sq1:j[0],sq2:j[1]};k.fen=l;if(u!==undefined&&u!==null){k.gc=u}k.onclick=b.updateBoard;if(this.current_move.tagName.toLowerCase()==="ol"){this.current_move.appendChild(k)}else{this.current_move.parentNode.appendChild(k)}if(p){g=document.createElement("span");g.setAttribute("class","comment");g.innerHTML=p;k.appendChild(g)}this.current_move=k;return this};a.resize=function(){var k,s=window,q=document,o=q.documentElement,m=q.getElementsByTagName("body")[0],l=s.innerWidth||o.clientWidth||m.clientWidth,j=s.innerHeight||o.clientHeight||m.clientHeight,f,n,r,p,h;if(d.allow_mobile===undefined){d.allow_mobile=true}if(d.allow_mobile&&d.width>l&&l<j){l=parseInt(l/9,10)*8;f=l;this.header_details_box.style.width=l+"px";this.game_list.style.width=l+"px";this.move_list.style.width=(l-30)+"px";this.move_control_box.style.width=l+"px";this.container.classList.add("mobile")}else{p=0.5;if(d.board_movelist_ratio!==undefined){h=d.board_movelist_ratio.split(":");if(h.length===2){h[0]=parseInt(h[0],10);h[1]=parseInt(h[1],10);if(h[1]!==0){p=h[0]/(h[0]+h[1]);if(p>3){p=3}else{if(p<0.3){p=0.3}}}}}f=parseInt((d.width)*p,10);d.move_list_width=parseInt(d.width,10)-f;this.container.style.width=d.width+"px";this.header_details_box.style.width=f+"px";if(d.move_list_width!==null){this.game_list.style.width=d.move_list_width+"px";this.move_list.style.width=(d.move_list_width-30)+"px";this.move_list.style.height=(parseInt(f/8,10)*8)+"px";this.move_control_box.style.width=d.move_list_width+"px";n=document.getElementsByClassName("pgn_ctrl_btn");r=parseInt((d.move_list_width-120)/8,10);for(k=0;k<n.length;k+=1){n[k].style.margin="0 "+r+"px"}}this.container.classList.remove("mobile")}a.board.resize(f,f)};a.startVariation=function(){var g,f;if(this.current_move.nextSibling===null){g=document.createElement("li");g.setAttribute("class","variation_list")}else{g=this.current_move.nextSibling}f=document.createElement("ol");f.setAttribute("class","variation");g.appendChild(f);this.current_move.parentNode.appendChild(g);this.current_move=f;this.ply-=1;this.start_end_variation=true;return this};this.flip=function(){a.board.flip()};this.load=function(f,h){var g=new XMLHttpRequest();a.download_btn.href=f;g.onreadystatechange=function(){var i;if(g.readyState===4&&g.status===200){i=g.responseText;a.importFile(i);if(typeof h==="function"){h()}}};g.open("GET",f,true);g.send()};this.loadText=function(f){a.importFile(f)};e=function(f){window.onresize=function(){a.resize()};window.addEventListener("touchend",function(){a.resize()},false);d.width=parseInt(d.width,10)||680;a.board=new CHESS.Board({height:d.board_width,width:d.board_width,square_color_light:d.square_color_light,square_color_dark:d.square_color_dark,square_hover_dark:d.square_hover_dark,square_hover_light:d.square_hover_light,square_dark:d.square_dark,square_light:d.square_light,gc_opacity:d.gc_opacity,highlight_move:d.highlight_move,highlight_move_color:d.highlight_move_color,highlight_move_opacity:d.highlight_move_opacity,show_row_col_labels:d.show_row_col_labels,piece_set:d.piece_set});a.board.setActive(false);a.buildHtml(d,a.board.getCanvas());a.container.onkeydown=function(g){g.stopPropagation();if(g.keyCode===37){b.goPrev()}else{if(g.keyCode===39){b.goNext()}}};a.container.getElementsByClassName("chessboard")[0].addEventListener("keydown",function(g){g.stopPropagation();if(g.keyCode===37){b.goPrev()}else{if(g.keyCode===39){b.goNext()}}});if(d.url!==undefined){f.load(d.url)}else{if(d.pgn_text!==undefined){f.loadText(d.pgn_text)}}};e(this)};
if(typeof define==="function"&&define.amd){define("chess",[],function(){return CHESS})};
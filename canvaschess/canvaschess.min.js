var CHESS=CHESS||{};CHESS.config={library_path:"canvaschess"};CHESS.nag_code={"0":"","1":"!","2":"?","3":"!!","4":"??","5":"!?","6":"?!","10":"="};
CHESS.engine={};CHESS.engine.createPosition=function(c){var a=function(){var m="",p=[],l=[],g={},h="",n=true,q=true,j=true,o=true,f=true,k=false,e=0};var d=function(){};d.prototype=a;var b=new d();if(c!==undefined){this.setPosition(b,c)}return b};CHESS.engine.setPosition=function(q,e){var m,o,a,p=[],b="",c=0,g="",r="",d="",n=["a","b","c","d","e","f","g","h"],l=0,h=0,f=0;m=e.split(" ");o=m[0];a=m[2];p=o.split("/");q.en_passant=m[3];q.white_to_move=(m[1]==="w");if(a==="-"){q.gs_castle_kside_w=false;q.gs_castle_qside_w=false;q.gs_castle_kside_b=false;q.gs_castle_qside_b=false}else{if(a.indexOf("K")>=0){q.gs_castle_kside_w=true}if(a.indexOf("Q")>=0){q.gs_castle_qside_w=true}if(a.indexOf("k")>=0){q.gs_castle_kside_b=true}if(a.indexOf("q")>=0){q.gs_castle_qside_b=true}}q.position_array=[["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"]];q.piecebox_array=[["-","wk","wq","wr","wb","wn","wp","-"],["-","bk","bq","br","bb","bn","bp","-"]];q.moves=0;q.last_move={};for(l=0;l<p.length;l+=1){for(h=0;h<p[l].length;h+=1){b=p[l].charAt(h);for(f=0;f<q.position_array[l].length;f+=1){if(q.position_array[l][f]==="-"){c=f;f=q.position_array[l].length}}if(/[0-9]/.test(b)){for(f=0;f<parseInt(b,10);f+=1){q.position_array[l][f+c]=""}}else{g="w";if(/[a-z]/.test(b)){g="b"}r=b.toLowerCase();d="";if(r==="p"){d=n[c]}q.position_array[l][c]=g+r+d}}}};CHESS.engine.getFEN=function(l){var g=[],h,a="",b="",k=[],d="",m="",f=0,e=0,c=0;for(f=0;f<l.position_array.length;f+=1){k[f]="";for(e=0;e<l.position_array[f].length;e+=1){m=l.position_array[f][e];if(m===""){c+=1}else{if(c>0){k[f]+=(c+"");c=0}d=m.substr(0,1);m=m.substr(1,1);if(d==="w"){m=m.toUpperCase()}k[f]+=m}}if(c>0){k[f]+=(c+"");c=0}}h=k.join("/");g.push(h);g.push(l.white_to_move?"w":"b");a="-";if(l.gs_castle_kside_w||l.gs_castle_qside_w||l.gs_castle_kside_b||l.gs_castle_qside_b){if(l.gs_castle_kside_w){a+="K"}if(l.gs_castle_qside_w){a+="Q"}if(l.gs_castle_kside_b){a+="k"}if(l.gs_castle_qside_b){a+="q"}}g.push(a);b=(l.en_passant===""?"-":l.en_passant);g.push(b);g.push("0 1");return g.join(" ")};CHESS.engine.isLegal=function(v,c,a){var s,m,l,u,f,t,e,k,o,p,q,h,b,d,g,n,r,j;m=this.getArrayPosition(c);l=this.getArrayPosition(a);if(!m||!l){return false}u=parseInt(m.substr(0,1));f=parseInt(m.substr(1,1));t=parseInt(l.substr(0,1));e=parseInt(l.substr(1,1));k=v.position_array[f][u];o=v.position_array[e][t];p=k.substr(1,1);q=k.substr(0,1);h=false;if((v.white_to_move&&q==="b")||(!v.white_to_move&&q==="w")){return false}if(o.substr(0,1)===k.substr(0,1)){return false}if(p==="p"){if(f===e){return false}if((q==="w"&&e>f)||(q==="b"&&e<f)){return false}if(!(Math.abs(f-e)===1||(Math.abs(f-e)===2&&((q==="w"&&f===6&&v.position_array[5][u]==="")||(q==="b"&&f===1&&v.position_array[2][u]===""))))){return false}if(Math.abs(u-t)===0&&v.position_array[e][t]!==""){return false}if(Math.abs(u-t)>0){b=(o.substr(0,1)!==""&&o.substr(0,1)!==q);h=v.en_passant===this.reverseArrayPosition(e+""+t);if(!(Math.abs(u-t)===1&&Math.abs(f-e)===1&&(b||h))){return false}}}if(p==="k"){if(Math.abs(u-t)===2){if(q==="w"){if(a==="g1"&&v.gs_castle_kside_w&&v.position_array[7][5]===""&&v.position_array[7][6]===""){if(this.isSquareAttacked(v.position_array,4,7,"w")){return false}if(this.isSquareAttacked(v.position_array,5,7,"w")){return false}if(this.isSquareAttacked(v.position_array,6,7,"w")){return false}}else{if(a==="c1"&&v.gs_castle_qside_w&&v.position_array[7][1]===""&&v.position_array[7][2]===""&&v.position_array[7][3]===""){if(this.isSquareAttacked(v.position_array,2,7,"w")){return false}if(this.isSquareAttacked(v.position_array,3,7,"w")){return false}if(this.isSquareAttacked(v.position_array,4,7,"w")){return false}}else{return false}}}else{if(q==="b"){if(a==="g8"&&v.gs_castle_kside_b&&v.position_array[0][5]===""&&v.position_array[0][6]===""){if(this.isSquareAttacked(v.position_array,4,0,"b")){return false}if(this.isSquareAttacked(v.position_array,5,0,"b")){return false}if(this.isSquareAttacked(v.position_array,6,0,"b")){return false}}else{if(a==="c8"&&v.gs_castle_qside_b&&v.position_array[0][1]===""&&v.position_array[0][2]===""&&v.position_array[0][3]===""){if(this.isSquareAttacked(v.position_array,2,0,"b")){return false}if(this.isSquareAttacked(v.position_array,3,0,"b")){return false}if(this.isSquareAttacked(v.position_array,4,0,"b")){return false}}else{return false}}}}}else{if(!(Math.abs(u-t)<2&&Math.abs(f-e)<2)){return false}}}if(p==="n"&&!((Math.abs(u-t)===1&&Math.abs(f-e)===2)||(Math.abs(u-t)===2&&Math.abs(f-e)===1))){return false}if(p==="r"){if(u!==t&&f!==e){return false}}if(p==="b"){if(Math.abs(u-t)!==Math.abs(f-e)){return false}}if(p==="q"){if((Math.abs(u-t)!==Math.abs(f-e))&&(u!==t&&f!==e)){return false}}if(p==="q"||p==="b"||p==="r"){s=0;d=u-t;g=f-e;n=0;r=0;if(d<0){n=1}else{if(d>0){n=-1}}if(g<0){r=1}else{if(g>0){r=-1}}s=1;while(!(parseInt(u)+s*n===t&&parseInt(f)+s*r===e)){if(s>8){break}if(v.position_array[parseInt(f)+s*r][parseInt(u)+s*n]!==""){return false}s+=1}}j=this.clonePositionArray(v.position_array);j[l.substr(1,1)][l.substr(0,1)]=j[m.substr(1,1)][m.substr(0,1)];j[m.substr(1,1)][m.substr(0,1)]="";if(h){j[m.substr(1,1)][l.substr(0,1)]=""}if(this.isCheck(j,q)){return false}return true};CHESS.engine.isCheck=function(f,e){var d,b,c=0,a=0;for(d=0;d<8;d++){for(b=0;b<8;b++){if(f[d][b]===e+"k"){c=b;a=d}}}if(this.isSquareAttacked(f,c,a,e)){return true}return false};CHESS.engine.isMate=function(y){var u,s,p=(y.white_to_move?"w":"b"),o=0,m=0,r,t,q,n,c=this.clonePositionArray(y.position_array);for(u=0;u<8;u++){for(s=0;s<8;s++){if(c[u][s]===p+"k"){o=s;m=u}}}r=this.getAttacker(c,o,m,p);if(r===""){return false}c[m][o]="";if(m>0){if(c[m-1][o].substr(0,1)!==p){if(!this.isSquareAttacked(c,o,m-1,p)){return false}}}if(m<7){if(c[m+1][o].substr(0,1)!==p){if(!this.isSquareAttacked(c,o,m+1,p)){return false}}}if(o>0){if(c[m][o-1].substr(0,1)!==p){if(!this.isSquareAttacked(c,o-1,m,p)){return false}}}if(o<7){if(c[m][o+1].substr(0,1)!==p){if(!this.isSquareAttacked(c,o+1,m,p)){return false}}}if(o>0&&m>0){if(c[m-1][o-1].substr(0,1)!==p){if(!this.isSquareAttacked(c,o-1,m-1,p)){return false}}}if(o<7&&m>0){if(c[m-1][o+1].substr(0,1)!==p){if(!this.isSquareAttacked(c,o+1,m-1,p)){return false}}}if(o>0&&m<7){if(c[m+1][o-1].substr(0,1)!==p){if(!this.isSquareAttacked(c,o-1,m+1,p)){return false}}}if(o<7&&m<7){if(c[m+1][o+1].substr(0,1)!==p){if(!this.isSquareAttacked(c,o+1,m+1,p)){return false}}}c[m][o]=p+"k";t=parseInt(r.substr(1,1));q=parseInt(r.substr(0,1));var k="b";if(p==="b"){k="w"}n=this.getAttacker(c,q,t,k);if(n!==""){var f=this.reverseArrayPosition(n);var d=this.reverseArrayPosition(r);if(this.isLegal(y,f,d)){return false}}var h=c[q][t].substr(1,1);if(h==="r"||h==="b"||h==="q"){if(Math.abs(o-t)>1||Math.abs(m-q)>1){var w=t-o;var e=q-m;var g=0;var l=0;if(w>0){g=1}if(e>0){l=1}if(w<0){g=-1}if(e<0){l=-1}var x=o+g,v=m+l;c[m][o]=k+"k";while(x!==t||v!==q){if(this.isSquareBlockable(c,x,v,k)){return false}x+=g;v+=l}}}if(h==="p"){if(p==="w"&&q===3&&y.en_passant===this.reverseArrayPosition((q-1)+""+t)){if(t>0&&c[3][t-1].substr(0,2)==="wp"){return false}if(t<7&&c[3][t+1].substr(0,2)==="wp"){return false}}if(p==="b"&&q===4&&y.en_passant===this.reverseArrayPosition((q+1)+""+t)){if(t>0&&c[4][t-1].substr(0,2)==="bp"){return false}if(t<7&&c[4][t+1].substr(0,2)==="bp"){return false}}}return true};CHESS.engine.isSquareAttacked=function(e,c,b,d){var a;c=parseInt(c);b=parseInt(b);if(b>0&&c>1&&e[b-1][c-2].substr(1,1)==="n"&&e[b-1][c-2].substr(0,1)!==d){return true}if(b>0&&c<6&&e[b-1][c+2].substr(1,1)==="n"&&e[b-1][c+2].substr(0,1)!==d){return true}if(b<7&&c>1&&e[b+1][c-2].substr(1,1)==="n"&&e[b+1][c-2].substr(0,1)!==d){return true}if(b<7&&c<6&&e[b+1][c+2].substr(1,1)==="n"&&e[b+1][c+2].substr(0,1)!==d){return true}if(b>1&&c>0&&e[b-2][c-1].substr(1,1)==="n"&&e[b-2][c-1].substr(0,1)!==d){return true}if(b>1&&c<7&&e[b-2][c+1].substr(1,1)==="n"&&e[b-2][c+1].substr(0,1)!==d){return true}if(b<6&&c>0&&e[b+2][c-1].substr(1,1)==="n"&&e[b+2][c-1].substr(0,1)!==d){return true}if(b<6&&c<7&&e[b+2][c+1].substr(1,1)==="n"&&e[b+2][c+1].substr(0,1)!==d){return true}i=1;while(c+i<8){a=e[b][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0){a=e[b][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(b-i>=0){a=e[b-i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(b+i<8){a=e[b+i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c+i<8&&b-i>=0){a=e[b-i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c+i<8&&b+i<8){a=e[b+i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b+i<8){a=e[b+i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b-i>=0){a=e[b-i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}if(d==="w"){if(c-1>=0&&b-1>=0){a=e[b-1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}if(c+1<8&&b-1>=0){a=e[b-1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}}else{if(c-1>=0&&b+1<8){a=e[b+1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}if(c+1<8&&b+1<8){a=e[b+1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}}return false};CHESS.engine.isSquareBlockable=function(d,e,c,b){var a;e=parseInt(e);c=parseInt(c);if(c>0&&e>1&&d[c-1][e-2].substr(1,1)==="n"&&d[c-1][e-2].substr(0,1)!==b){return true}if(c>0&&e<6&&d[c-1][e+2].substr(1,1)==="n"&&d[c-1][e+2].substr(0,1)!==b){return true}if(c<7&&e>1&&d[c+1][e-2].substr(1,1)==="n"&&d[c+1][e-2].substr(0,1)!==b){return true}if(c<7&&e<6&&d[c+1][e+2].substr(1,1)==="n"&&d[c+1][e+2].substr(0,1)!==b){return true}if(c>1&&e>0&&d[c-2][e-1].substr(1,1)==="n"&&d[c-2][e-1].substr(0,1)!==b){return true}if(c>1&&e<7&&d[c-2][e+1].substr(1,1)==="n"&&d[c-2][e+1].substr(0,1)!==b){return true}if(c<6&&e>0&&d[c+2][e-1].substr(1,1)==="n"&&d[c+2][e-1].substr(0,1)!==b){return true}if(c<6&&e<7&&d[c+2][e+1].substr(1,1)==="n"&&d[c+2][e+1].substr(0,1)!==b){return true}i=1;while(e+i<8){a=d[c][e+i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(e-i>=0){a=d[c][e-i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0){a=d[c-i][e];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(c+i<8){a=d[c+i][e];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(e+i<8&&c-i>=0){a=d[c-i][e+i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}i=1;while(e+i<8&&c+i<8){a=d[c+i][e+i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}i=1;while(e-i>=0&&c+i<8){a=d[c+i][e-i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}i=1;while(e-i>=0&&c-i>=0){a=d[c-i][e-i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}if(b==="w"){if(c-1>=0){a=d[c-1][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}if(c===3&&d[2][e]===""){a=d[1][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}}else{if(c+1<8){a=d[c+1][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}if(c===4&&d[5][e]===""){a=d[6][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}}return false};CHESS.engine.getAttacker=function(e,c,b,d){var a;c=parseInt(c);b=parseInt(b);if(b>0&&c>1&&e[b-1][c-2].substr(1,1)==="n"&&e[b-1][c-2].substr(0,1)!==d){return(b-1)+""+(c-2)}if(b>0&&c<6&&e[b-1][c+2].substr(1,1)==="n"&&e[b-1][c+2].substr(0,1)!==d){return(b-1)+""+(c+2)}if(b<7&&c>1&&e[b+1][c-2].substr(1,1)==="n"&&e[b+1][c-2].substr(0,1)!==d){return(b+1)+""+(c-2)}if(b<7&&c<6&&e[b+1][c+2].substr(1,1)==="n"&&e[b+1][c+2].substr(0,1)!==d){return(b+1)+""+(c+2)}if(b>1&&c>0&&e[b-2][c-1].substr(1,1)==="n"&&e[b-2][c-1].substr(0,1)!==d){return(b-2)+""+(c-1)}if(b>1&&c<7&&e[b-2][c+1].substr(1,1)==="n"&&e[b-2][c+1].substr(0,1)!==d){return(b-2)+""+(c+1)}if(b<6&&c>0&&e[b+2][c-1].substr(1,1)==="n"&&e[b+2][c-1].substr(0,1)!==d){return(b+2)+""+(c-1)}if(b<6&&c<7&&e[b+2][c+1].substr(1,1)==="n"&&e[b+2][c+1].substr(0,1)!==d){return(b+2)+""+(c+1)}i=1;while(c+i<8){a=e[b][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b)+""+(c+i)}if(a!==""){break}i+=1}i=1;while(c-i>=0){a=e[b][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b)+""+(c-i)}if(a!==""){break}i+=1}i=1;while(b-i>=0){a=e[b-i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b-i)+""+(c)}if(a!==""){break}i+=1}i=1;while(b+i<8){a=e[b+i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b+i)+""+(c)}if(a!==""){break}i+=1}i=1;while(c+i<8&&b-i>=0){a=e[b-i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b-i)+""+(c+i)}if(a!==""){break}i+=1}i=1;while(c+i<8&&b+i<8){a=e[b+i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b+i)+""+(c+i)}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b+i<8){a=e[b+i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b+i)+""+(c-i)}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b-i>=0){a=e[b-i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b-i)+""+(c-i)}if(a!==""){break}i+=1}if(d==="w"){if(c-1>0&&b-1>=0){a=e[b-1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b-1)+""+(c-1)}}if(c+1<8&&b-1>=0){a=e[b-1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b-1)+""+(c+1)}}}else{if(c-1>=0&&b+1<8){a=e[b+1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b+1)+""+(c-1)}}if(c+1<8&&b+1<8){a=e[b+1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b+1)+""+(c+1)}}}return""};CHESS.engine.isStalemate=function(b){var a=!this.getLegalMoves(b,true);return a};CHESS.engine.getLegalMoves=function(n,h){var g,f,l,k,d="",m=[],e=(n.white_to_move?"w":"b"),c,b=0,a;for(g=0;g<8;g++){for(f=0;f<8;f++){l=this.reverseArrayPosition(g+""+f);if(n.position_array[g][f]===e+"k"){if(g>0){k=this.reverseArrayPosition((g-1)+""+f);d=l+"-"+k;m.push(d)}if(g>0&&f<7){k=this.reverseArrayPosition((g-1)+""+(f+1));d=l+"-"+k;m.push(d)}if(f<7){k=this.reverseArrayPosition(g+""+(f+1));d=l+"-"+k;m.push(d)}if(g<7&&f<7){k=this.reverseArrayPosition((g+1)+""+(f+1));d=l+"-"+k;m.push(d)}if(g<7){k=this.reverseArrayPosition((g+1)+""+f);d=l+"-"+k;m.push(d)}if(g<7&&f>0){k=this.reverseArrayPosition((g+1)+""+(f-1));d=l+"-"+k;m.push(d)}if(f>0){k=this.reverseArrayPosition(g+""+(f-1));d=l+"-"+k;m.push(d)}if(g>0&&f>0){k=this.reverseArrayPosition((g-1)+""+(f-1));d=l+"-"+k;m.push(d)}}if(n.position_array[g][f].substr(0,2)===e+"p"){c=(e==="w"?-1:1);k=this.reverseArrayPosition((g+c)+""+f);d=l+"-"+k;m.push(d);if((e==="w"&&g===6)||(e==="b"&&g===1)){k=this.reverseArrayPosition((g+(c*2))+""+f);d=l+"-"+k;m.push(d)}if(/[a-h][1-8]/.test(n.en_passant)){a=parseInt(this.getArrayPosition(n.en_passant).substr(0,1),10)}if(e==="w"&&g===3){if(a===(f-1)){k=this.reverseArrayPosition((g-1)+""+(f-1));d=l+"-"+k;m.push(d)}if(a===(f+1)){k=this.reverseArrayPosition((g-1)+""+(f+1));d=l+"-"+k;m.push(d)}}if(e==="b"&&g===4){if(a===(f-1)){k=this.reverseArrayPosition((g+1)+""+(f-1));d=l+"-"+k;m.push(d)}if(a===(f+1)){k=this.reverseArrayPosition((g+1)+""+(f+1));d=l+"-"+k;m.push(d)}}}if(n.position_array[g][f]===e+"q"){b=1;while(g-b>=0){k=this.reverseArrayPosition((g-b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(g-b>=0&&f+b<=7){k=this.reverseArrayPosition((g-b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7){k=this.reverseArrayPosition(g+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7&&g+b<=7){k=this.reverseArrayPosition((g+b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7){k=this.reverseArrayPosition((g+b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7&&f-b>=0){k=this.reverseArrayPosition((g+b)+""+(f-b));d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0){k=this.reverseArrayPosition(g+""+(f-b));d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0&&g-b>=0){k=this.reverseArrayPosition((g-b)+""+(f-b));d=l+"-"+k;m.push(d);b++}}if(n.position_array[g][f]===e+"r"){b=1;while(g-b>=0){k=this.reverseArrayPosition((g-b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7){k=this.reverseArrayPosition(g+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7){k=this.reverseArrayPosition((g+b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0){k=this.reverseArrayPosition(g+""+(f-b));d=l+"-"+k;m.push(d);b++}}if(n.position_array[g][f]===e+"b"){b=1;while(g-b>=0&&f+b<=7){k=this.reverseArrayPosition((g-b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7&&g+b<=7){k=this.reverseArrayPosition((g+b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7&&f-b>=0){k=this.reverseArrayPosition((g+b)+""+(f-b));d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0&&g-b>=0){k=this.reverseArrayPosition((g-b)+""+(f-b));d=l+"-"+k;m.push(d);b++}}if(n.position_array[g][f]===e+"n"){if(g>=2&&f<=6){k=this.reverseArrayPosition((g-2)+""+(f+1));d=l+"-"+k;m.push(d)}if(g>=1&&f<=5){k=this.reverseArrayPosition((g-1)+""+(f+2));d=l+"-"+k;m.push(d)}if(g<=6&&f<=5){k=this.reverseArrayPosition((g+1)+""+(f+2));d=l+"-"+k;m.push(d)}if(g<=5&&f<=6){k=this.reverseArrayPosition((g+2)+""+(f+1));d=l+"-"+k;m.push(d)}if(g<=5&&f>=1){k=this.reverseArrayPosition((g+2)+""+(f-1));d=l+"-"+k;m.push(d)}if(g<=6&&f>=2){k=this.reverseArrayPosition((g+1)+""+(f-2));d=l+"-"+k;m.push(d)}if(g>=1&&f>=2){k=this.reverseArrayPosition((g-1)+""+(f-2));d=l+"-"+k;m.push(d)}if(g>=2&&f>=1){k=this.reverseArrayPosition((g-2)+""+(f-1));d=l+"-"+k;m.push(d)}}}}for(g=0;g<m.length;g++){l=m[g].split("-")[0];k=m[g].split("-")[1];if(!this.isLegal(n,l,k)){m.splice(g,1);g--}else{if(h){return true}}}if(h){return false}return m};CHESS.engine.getLongNotation=function(l,b){var e,d,a="",k,h=b.replace(/[#+=xKQRBN]/g,""),c=(l.white_to_move?"w":"b"),m=b.substring(0,1),g="",f="";if(b==="O-O"){if(c==="w"){return"e1-g1"}else{return"e8-g8"}}else{if(b==="O-O-O"){if(c==="w"){return"e1-c1"}else{return"e8-c8"}}}if(h.length===3){g=h.substr(0,1);h=h.substr(h.length-2,2);if(/[0-9]/.test(g)){f="rank"}else{if(/[a-z]/.test(g)){g=g.charCodeAt(0)-97;f="file"}}}if(m!=="K"&&m!=="Q"&&m!=="W"&&m!=="R"&&m!=="B"&&m!=="N"){m="p"}m=m.toLowerCase();for(e=0;e<8;e++){for(d=0;d<8;d++){if(f==="rank"&&parseInt(g)!==(8-e)){continue}else{if(f==="file"&&parseInt(g)!==d){continue}}if(l.position_array[e][d].length>1&&l.position_array[e][d].substr(0,2)===c+m){k=this.reverseArrayPosition(e+""+d);if(this.isLegal(l,k,h)){a=k+"-"+h}}}}return a};CHESS.engine.getArrayPosition=function(b){var a,d,c=false;if(/[a-h][1-8]/.test(b)){a=b.substr(0,1).toLowerCase();d=b.substr(1,1);a=a.charCodeAt(0)-97;d=8-d;c=a+""+d}return c};CHESS.engine.reverseArrayPosition=function(b){var a=parseInt(b.substr(1,1)),c=parseInt(b.substr(0,1));a=String.fromCharCode(a+97);c=8-c;return a+""+c};CHESS.engine.clonePositionArray=function(b){var a=0,c=[];for(a=0;a<8;a+=1){c[a]=b[a].slice(0)}return c};CHESS.engine.moveTemp=function(w,b,a){var p,o,f,e,d,n,c,m,r,q,h,g,v,l,u,k,t,s="",j;if(!this.isLegal(w,b,a)){return false}w.last_move={sq1:this.getArrayPosition(b),sq2:this.getArrayPosition(a)};if(w.white_to_move){p=b;o=a;f=this.getArrayPosition(p);e=this.getArrayPosition(o);d=parseInt(f.substr(0,1));n=parseInt(f.substr(1,1));c=parseInt(e.substr(0,1));m=parseInt(e.substr(1,1));s=w.position_array[m][c];j=w.position_array[n][d];w.position_array[m][c]=w.position_array[n][d];w.position_array[n][d]="";f=this.getArrayPosition(p);if(j.substr(0,2)==="wp"&&m-n===-2){w.en_passant=this.reverseArrayPosition((m+1)+""+c)}else{w.en_passant=""}if(j.substr(0,2)==="wp"&&c!==d&&s===""){w.position_array[n][c]="";t=o.substr(0,1)+p.substr(1,1)}if(j.substr(0,2)==="wp"&&m===0){w.position_array[m][c]="wq"}if(j==="wk"&&p==="e1"){if(o==="g1"){w.position_array[7][5]="wrk";w.position_array[7][7]=""}else{if(o==="c1"){w.position_array[7][3]="wrq";w.position_array[7][0]=""}}}if(j==="wk"){w.gs_castle_kside_w=false;w.gs_castle_qside_w=false}else{if(j==="wr"&&p==="h1"){w.gs_castle_kside_w=false}else{if(j==="wr"&&p==="a1"){w.gs_castle_qside_w=false}else{if(s==="br"&&o==="a8"){w.gs_castle_qside_b=false}else{if(s==="br"&&o==="h8"){w.gs_castle_kside_b=false}}}}}w.white_to_move=false}else{r=b;q=a;h=this.getArrayPosition(r);g=this.getArrayPosition(q);v=parseInt(h.substr(0,1));l=parseInt(h.substr(1,1));u=parseInt(g.substr(0,1));k=parseInt(g.substr(1,1));s=w.position_array[k][u];j=w.position_array[l][v];w.position_array[k][u]=w.position_array[l][v];w.position_array[l][v]="";h=this.getArrayPosition(r);if(j.substr(0,2)==="bp"&&k-l===2){w.en_passant=this.reverseArrayPosition((k-1)+""+u)}else{w.en_passant=""}if(j.substr(0,2)==="bp"&&u!==v&&s===""){w.position_array[l][u]="";t=q.substr(0,1)+r.substr(1,1)}if(j.substr(0,2)==="bp"&&k===7){w.position_array[k][u]="bq"}if(j==="bk"&&r==="e8"){if(q==="g8"){w.position_array[0][5]="brk";w.position_array[0][7]=""}else{if(q==="c8"){w.position_array[0][3]="brq";w.position_array[0][0]=""}}}if(j==="bk"){w.gs_castle_kside_b=false;w.gs_castle_qside_b=false}else{if(j==="br"&&r==="h8"){w.gs_castle_kside_b=false}else{if(j==="br"&&r==="a8"){w.gs_castle_qside_b=false}else{if(s==="wr"&&q==="a1"){w.gs_castle_qside_w=false}else{if(s==="wr"&&q==="h1"){w.gs_castle_kside_w=false}}}}}w.white_to_move=true}if(this.isMate(w)||this.isStalemate(w)){w.active=false}return true};
CHESS.Board=function(d){var e,b={subscribers:{any:[]}},c=CHESS.engine.createPosition(),a={container:null,canvas:null,ctx:null,snapshot:null,snapshot_ctx:null,snapshot_img:new Image(),square_size:80,square_color_light:"#ececd7",square_color_dark:"#7389b6",dragok:false,drag_piece:"",drag_clear_i:0,drag_clear_j:0,left:0,top:0,last_draw_left:0,last_draw_top:0,piece_not_lifted:true,white_down:true,display_coordinates:true,highlight_move:false,show_row_col_labels:true,pieces:new Image()};b.myCancel=function(f){f.preventDefault();a.dragok=false;a.drag_piece="";a.left=0;a.top=0;a.takeSnapshot();a.refresh()};b.myDown=function(m){var g,f,h,l,k=a.canvas.getBoundingClientRect();if(c.active){if(m.hasOwnProperty("clientX")){a.left=m.clientX-k.left;a.top=m.clientY-k.top;a.canvas.style.cursor="move"}else{if(m.hasOwnProperty("changedTouches")){a.left=m.changedTouches[0].pageX-k.left;a.top=m.changedTouches[0].pageY-k.top}else{return}}g=parseInt(a.top/a.square_size,10);f=parseInt(a.left/a.square_size,10);if(!a.white_down){g=7-g;f=7-f}if(g<8){h=c.position_array[g][f]}else{if(c.mode==="setup"){h=c.piecebox_array[g-8][f]}}l=h.substr(0,1);if(c.mode!=="setup"&&((c.white_to_move&&l==="b")||(!c.white_to_move&&l==="w"))){a.canvas.style.cursor="default";return}if(h!==""){a.drag_clear_i=g;a.drag_clear_j=f;a.drag_piece=h;a.dragok=true;a.takeSnapshot()}else{a.canvas.style.cursor="default"}}};b.myMove=function(p){p.preventDefault();var q=a,k,h,v,n,w,o,m,l,f,g,u,s,r,t=q.canvas.getBoundingClientRect();if(q.dragok){k=parseInt(q.top/q.square_size,10);h=parseInt(q.left/q.square_size,10);o=(h-1)*q.square_size;m=(k-1)*q.square_size;l=q.square_size*3;f=q.square_size*3;if(!(k<0||k>7||h<0||h>7)){if(o<0){o=0}if(m<0){m=0}if(o+l>q.square_size*8){l=(q.square_size*8)-o}if(m+f>q.square_size*8){f=(q.square_size*8)-m}q.ctx.drawImage(q.snapshot,o,m,l,f,o,m,l,f)}if(p.hasOwnProperty("clientX")){q.left=p.clientX-t.left;q.top=p.clientY-t.top}else{if(p.hasOwnProperty("changedTouches")){q.left=p.changedTouches[0].pageX-t.left;q.top=p.changedTouches[0].pageY-t.top}else{return}}k=parseInt(q.top/q.square_size,10);h=parseInt(q.left/q.square_size,10);if(k<0||k>7||h<0||h>7){return}q.ctx.beginPath();if((k+h)%2===0){q.ctx.fillStyle="#b4d990"}else{q.ctx.fillStyle="#85c249"}q.ctx.rect(h*q.square_size,k*q.square_size,q.square_size,q.square_size);q.ctx.fill();if(q.piece_not_lifted&&q.drag_clear_i<8){q.piece_not_lifted=false;q.ctx.beginPath();if((q.drag_clear_i+q.drag_clear_j)%2===0){q.ctx.fillStyle=this.square_color_light}else{q.ctx.fillStyle=this.square_color_dark}v=q.drag_clear_i;n=q.drag_clear_j;if(!q.white_down){v=7-v;n=7-n}q.ctx.rect(n*q.square_size,v*q.square_size,q.square_size,q.square_size);q.ctx.fill()}q.ctx.save();g=(q.square_size/55);q.ctx.scale(g,g);v=k;n=h;if(!q.white_down){v=7-k;n=7-h}w=c.position_array[v][n].substr(0,2);if(w!==""&&!(v===q.drag_clear_i&&n===q.drag_clear_j)){u=parseInt((h*q.square_size/g),10);s=parseInt((k*q.square_size/g),10);switch(w){case"wk":q.ctx.drawImage(q.pieces,0,0,55,55,u,s,55,55);break;case"wq":q.ctx.drawImage(q.pieces,55,0,55,55,u,s,55,55);break;case"wr":q.ctx.drawImage(q.pieces,110,0,55,55,u,s,55,55);break;case"wb":q.ctx.drawImage(q.pieces,160,0,55,55,u,s,55,55);break;case"wn":q.ctx.drawImage(q.pieces,215,0,55,55,u,s,55,55);break;case"wp":q.ctx.drawImage(q.pieces,270,0,55,55,u,s,55,55);break;case"bk":q.ctx.drawImage(q.pieces,0,55,55,55,u,s,55,55);break;case"bq":q.ctx.drawImage(q.pieces,55,55,55,55,u,s,55,55);break;case"br":q.ctx.drawImage(q.pieces,110,55,55,55,u,s,55,55);break;case"bb":q.ctx.drawImage(q.pieces,160,55,55,55,u,s,55,55);break;case"bn":q.ctx.drawImage(q.pieces,215,55,55,55,u,s,55,55);break;case"bp":q.ctx.drawImage(q.pieces,270,55,55,55,u,s,55,55);break}}w=q.drag_piece.substr(0,2);u=parseInt(((q.left-(q.square_size/2))/g),10);s=parseInt(((q.top-(q.square_size/2))/g),10);r=55;if(c.mode==="setup"&&q.top>q.square_size*7.5){r=r-((q.top-q.square_size*7.5)/g)}switch(w){case"wk":q.ctx.drawImage(q.pieces,0,0,55,55,u,s,55,r);break;case"wq":q.ctx.drawImage(q.pieces,55,0,55,55,u,s,55,r);break;case"wr":q.ctx.drawImage(q.pieces,110,0,55,55,u,s,55,r);break;case"wb":q.ctx.drawImage(q.pieces,160,0,55,55,u,s,55,r);break;case"wn":q.ctx.drawImage(q.pieces,215,0,55,55,u,s,55,r);break;case"wp":q.ctx.drawImage(q.pieces,270,0,55,55,u,s,55,r);break;case"bk":q.ctx.drawImage(q.pieces,0,55,55,55,u,s,55,r);break;case"bq":q.ctx.drawImage(q.pieces,55,55,55,55,u,s,55,r);break;case"br":q.ctx.drawImage(q.pieces,110,55,55,55,u,s,55,r);break;case"bb":q.ctx.drawImage(q.pieces,160,55,55,55,u,s,55,r);break;case"bn":q.ctx.drawImage(q.pieces,215,55,55,55,u,s,55,r);break;case"bp":q.ctx.drawImage(q.pieces,270,55,55,55,u,s,55,r);break}q.ctx.restore()}};b.myUp=function(m){var l,k,h=["a","b","c","d","e","f","g","h"],g,f,q,p,n=a.canvas.getBoundingClientRect(),o;if(c.active&&a.dragok){if(m.hasOwnProperty("clientX")){g=parseInt((m.clientY-n.top)/a.square_size,10);f=parseInt((m.clientX-n.left)/a.square_size,10);a.canvas.style.cursor="default"}else{if(m.hasOwnProperty("changedTouches")){g=parseInt((m.changedTouches[0].pageY-n.top)/a.square_size,10);f=parseInt((m.changedTouches[0].pageX-n.left)/a.square_size,10)}else{return}}if(!a.white_down){g=7-g;f=7-f}o=a.drag_piece;a.dragok=false;a.drag_piece="";a.left=0;a.top=0;a.piece_not_lifted=true;if(a.drag_clear_i>=8){l="piecebox"}else{l=h[a.drag_clear_j]+(8-a.drag_clear_i)}if(g>=8){k="piecebox"}else{k=h[f]+(8-g)}q=CHESS.engine.getArrayPosition(l);p=CHESS.engine.getArrayPosition(k);if(c.mode==="setup"){if(l!==k&&l!=="piecebox"&&k!=="piecebox"){c.position_array[p.substr(1,1)][p.substr(0,1)]=o;c.position_array[q.substr(1,1)][q.substr(0,1)]=""}else{if(l==="piecebox"&&k==="piecebox"){}else{if(l==="piecebox"){c.position_array[p.substr(1,1)][p.substr(0,1)]=o}else{if(k==="piecebox"){c.position_array[q.substr(1,1)][q.substr(0,1)]=""}}}}}else{c.move(l,k)}a.takeSnapshot();a.refresh()}};b.publish=function(f,g){this.visitSubscribers("publish",f,g)};b.visitSubscribers=function(l,g,k){var h=k||"any",m=this.subscribers[h],j,f=0;if(m!==undefined){f=m.length}for(j=0;j<f;j+=1){if(l==="publish"){m[j](g)}else{if(m[j]===g){m.splice(j,1)}}}};b.resize=function(f,g){var i=0,h=8;f=f||0;g=g||0;f=parseInt(f,10);g=parseInt(g,10);if(f===0||g===0){f=parseInt(window.getComputedStyle(a.canvas.parentNode,null).getPropertyValue("height"),10);g=parseInt(window.getComputedStyle(a.canvas.parentNode,null).getPropertyValue("width"),10)}i=(f<g?f:g);if(c.mode==="setup"){h=10}a.square_size=(f<g?parseInt(i/h,10):parseInt(i/8,10));a.canvas.height=a.square_size*h;a.canvas.width=a.square_size*8};c.move=function(g,f){var l={position_array:CHESS.engine.clonePositionArray(this.position_array),white_to_move:this.white_to_move,en_passant:this.en_passant,active:this.active,gs_castle_kside_w:this.gs_castle_kside_w,gs_castle_qside_w:this.gs_castle_qside_w,gs_castle_kside_b:this.gs_castle_kside_b,gs_castle_qside_b:this.gs_castle_qside_b},i={fen:CHESS.engine.getFEN(this),player_to_move:(this.white_to_move?"w":"b"),sq1:g,sq2:f,promote:false},k,j,h;if(this.last_move){l.last_move={sq1:this.last_move.sq1,sq2:this.last_move.sq2}}k=CHESS.engine.getArrayPosition(g);j=CHESS.engine.getArrayPosition(f);h=c.position_array[k.substr(1,1)][k.substr(0,1)].substr(1,1);if(h==="p"&&((c.white_to_move&&f.substr(1,1)==="8")||(!c.white_to_move&&f.substr(1,1)==="1"))){i.promote=true}if(!CHESS.engine.moveTemp(l,g,f)){a.takeSnapshot();a.refresh();return}b.publish(i,"move_before");this.position_array=CHESS.engine.clonePositionArray(l.position_array);this.white_to_move=l.white_to_move;this.en_passant=l.en_passant;this.active=l.active;this.gs_castle_kside_w=l.gs_castle_kside_w;this.gs_castle_qside_w=l.gs_castle_qside_w;this.gs_castle_kside_b=l.gs_castle_kside_b;this.gs_castle_qside_b=l.gs_castle_qside_b;this.moves+=1;if(l.last_move){this.last_move={sq1:l.last_move.sq1,sq2:l.last_move.sq2}}a.takeSnapshot();a.refresh();if(!this.active){return}};c.setPosition=function(f){CHESS.engine.setPosition(this,f)};a.buildHtml=function(f){this.canvas=document.createElement("canvas");this.canvas.className="chessboard";this.canvas.setAttribute("tabindex",0);this.ctx=this.canvas.getContext("2d");this.snapshot=document.createElement("canvas");if(f!==undefined){document.getElementById(f).appendChild(this.canvas)}};a.drawPiece=function(g,f,k){var i,h,j=1;this.snapshot_ctx.save();j=this.square_size/55;this.snapshot_ctx.scale(j,j);i=f/j;h=k/j;switch(g){case"wk":this.snapshot_ctx.drawImage(this.pieces,0,0,55,55,i,h,55,55);break;case"wq":this.snapshot_ctx.drawImage(this.pieces,55,0,55,55,i,h,55,55);break;case"wr":this.snapshot_ctx.drawImage(this.pieces,110,0,55,55,i,h,55,55);break;case"wb":this.snapshot_ctx.drawImage(this.pieces,160,0,55,55,i,h,55,55);break;case"wn":this.snapshot_ctx.drawImage(this.pieces,215,0,55,55,i,h,55,55);break;case"wp":this.snapshot_ctx.drawImage(this.pieces,270,0,55,55,i,h,55,55);break;case"bk":this.snapshot_ctx.drawImage(this.pieces,0,55,55,55,i,h,55,55);break;case"bq":this.snapshot_ctx.drawImage(this.pieces,55,55,55,55,i,h,55,55);break;case"br":this.snapshot_ctx.drawImage(this.pieces,110,55,55,55,i,h,55,55);break;case"bb":this.snapshot_ctx.drawImage(this.pieces,160,55,55,55,i,h,55,55);break;case"bn":this.snapshot_ctx.drawImage(this.pieces,215,55,55,55,i,h,55,55);break;case"bp":this.snapshot_ctx.drawImage(this.pieces,270,55,55,55,i,h,55,55);break}this.snapshot_ctx.restore()};a.refresh=function(){this.ctx.clearRect(0,this.square_size*8,this.square_size*8,this.square_size*2);this.ctx.drawImage(this.snapshot,0,0)};a.takeSnapshot=function(){var g,f,n,k,m,l,p,o=8,h;if(c.mode==="setup"){o=10}this.snapshot.width=this.square_size*8;this.snapshot.height=this.square_size*o;this.snapshot_ctx=this.snapshot.getContext("2d");this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=this.square_color_light;this.snapshot_ctx.rect(0,0,this.square_size*8,this.square_size*8);this.snapshot_ctx.fill();this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=this.square_color_dark;for(l=0;l<4;l+=1){for(m=0;m<4;m+=1){this.snapshot_ctx.rect(m*(this.square_size*2)+this.square_size,l*(this.square_size*2),this.square_size,this.square_size)}}for(l=0;l<4;l+=1){for(m=0;m<4;m+=1){this.snapshot_ctx.rect(m*(this.square_size*2),l*(this.square_size*2)+this.square_size,this.square_size,this.square_size)}}this.snapshot_ctx.fill();if(this.show_row_col_labels){this.snapshot_ctx.font="9px arial";for(l=0;l<8;l+=1){if(this.white_down){h=8-l}else{h=l+1}this.snapshot_ctx.fillStyle=(l%2===0?this.square_color_dark:this.square_color_light);this.snapshot_ctx.fillText(h,2,(l*this.square_size)+10)}for(m=0;m<8;m+=1){if(this.white_down){h=String.fromCharCode(m+97)}else{h=String.fromCharCode((7-m)+97)}this.snapshot_ctx.fillStyle=(m%2===0?this.square_color_light:this.square_color_dark);this.snapshot_ctx.fillText(h,(this.square_size*m)+this.square_size-7,(this.square_size*8)-2)}}if(this.highlight_move){if(typeof c.last_move==="object"&&c.last_move.sq1!==undefined){m=c.last_move.sq1.substr(0,1);l=c.last_move.sq1.substr(1,1);if(!this.white_down){m=7-m;l=7-l}this.snapshot_ctx.lineWidth=2;this.snapshot_ctx.strokeStyle="#ff8d8d";this.snapshot_ctx.strokeRect(m*this.square_size,l*this.square_size,this.square_size,this.square_size);m=c.last_move.sq2.substr(0,1);l=c.last_move.sq2.substr(1,1);if(!this.white_down){m=7-m;l=7-l}this.snapshot_ctx.strokeRect(m*this.square_size,l*this.square_size,this.square_size,this.square_size)}}for(g=0;g<8;g+=1){for(f=0;f<8;f+=1){if(!this.dragok||!(g===this.drag_clear_i&&f===this.drag_clear_j)){p=c.position_array[g][f].substr(0,2);n=g;k=f;if(!this.white_down){n=7-g;k=7-f}m=k*this.square_size;l=n*this.square_size;if(p!==""){this.drawPiece(p,m,l)}}}}if(c.mode==="setup"){for(g=0;g<2;g+=1){for(f=0;f<8;f+=1){p=c.piecebox_array[g][f].substr(0,2);m=f*this.square_size;l=(g+8)*this.square_size;if(p!==""){this.drawPiece(p,m,l)}}}}if(this.dragok){g=this.drag_clear_i;f=this.drag_clear_j;if(!this.white_down){g=7-this.drag_clear_i;f=7-this.drag_clear_j}this.snapshot_ctx.beginPath();this.snapshot_ctx.fillStyle=this.square_color_dark;if((g+f)%2===0){this.snapshot_ctx.fillStyle=this.square_color_light}this.snapshot_ctx.rect(f*this.square_size,g*this.square_size,this.square_size,this.square_size);this.snapshot_ctx.fill()}};this.display=function(){a.takeSnapshot();a.refresh()};this.flip=function(){a.white_down=!a.white_down;a.takeSnapshot();a.refresh()};this.getCanvas=function(){return a.canvas};this.move=function(g){var i,h,f;i=CHESS.engine.getLongNotation(c,g);i=i.split("-");h=i[0];f=i[1];c.move(h,f)};this.positionClear=function(){c.position_array=[["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""]];c.last_move={};c.en_passant="";c.white_to_move=true;c.gs_castle_kside_w=true;c.gs_castle_qside_w=true;c.gs_castle_kside_b=true;c.gs_castle_qside_b=true;c.moves=0;a.takeSnapshot();a.refresh()};this.positionStart=function(){c.position_array=[["br","bn","bb","bq","bk","bb","bn","br"],["bp","bp","bp","bp","bp","bp","bp","bp"],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["","","","","","","",""],["wp","wp","wp","wp","wp","wp","wp","wp"],["wr","wn","wb","wq","wk","wb","wn","wr"]];c.last_move={};c.en_passant="";c.white_to_move=true;c.gs_castle_kside_w=true;c.gs_castle_qside_w=true;c.gs_castle_kside_b=true;c.gs_castle_qside_b=true;c.moves=0;a.takeSnapshot();a.refresh()};this.resize=function(f,g){b.resize(f,g);a.takeSnapshot();a.refresh()};this.setActive=function(f){c.active=(f===true)};this.setLastMove=function(g,f){g=CHESS.engine.getArrayPosition(g);f=CHESS.engine.getArrayPosition(f);c.last_move={sq1:g,sq2:f}};this.setMode=function(f){c.mode=f;if(f==="setup"){c.active=true}b.resize(a.canvas.height,a.canvas.width);a.takeSnapshot();a.refresh()};this.setPosition=function(f){c.setPosition(f);a.takeSnapshot();a.refresh()};this.subscribe=function(g,f){f=f||"any";if(b.subscribers[f]===undefined){b.subscribers[f]=[]}b.subscribers[f].push(g)};this.unsubscribe=function(g,f){b.visitSubscribers("unsubscribe",g,f)};e=function(){a.buildHtml(d.container);a.canvas.onmousedown=b.myDown;a.canvas.onmouseup=b.myUp;a.canvas.onmousemove=b.myMove;a.canvas.addEventListener("touchstart",b.myDown,false);a.canvas.addEventListener("touchend",b.myUp,false);a.canvas.addEventListener("touchmove",b.myMove,false);a.canvas.addEventListener("touchleave",b.myCancel,false);a.canvas.addEventListener("touchcancel",b.myCancel,false);a.highlight_move=(d.highlight_move===true?true:false);a.show_row_col_labels=(d.show_row_col_labels===false?false:true);a.square_color_light=(d.square_color_light?d.square_color_light:a.square_color_light);a.square_color_dark=(d.square_color_dark?d.square_color_dark:a.square_color_dark);c.mode=d.mode;c.active=true;if(d.fen){c.setPosition(d.fen)}else{c.setPosition("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")}b.resize(d.height,d.width);a.pieces.src=CHESS.config.library_path+"/img/pieces.png";a.pieces.onload=function(){a.takeSnapshot();a.refresh()}};e()};
CHESS.PgnViewer=function(d){var e,b={},c={event:"",site:"",date:"",round:"",white:"",black:"",result:"",fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",game_list:[]},a={board:null,container:null,main_box:null,header_box:null,header_details_box:null,control_box:null,move_control_box:null,board_control_box:null,header_players_elem:null,header_event_elem:null,header_site_elem:null,header_date_elem:null,header_result_elem:null,control_play_elem:null,control_pause_elem:null,control_start_elem:null,control_prev_elem:null,control_next_elem:null,control_end_elem:null,download_btn:null,flip_board_btn:null,move_list:null,game_list:null,current_move:null,ply:0,start_end_variation:false};b.goEnd=function(){if(a.current_move!==null){a.changeMove(a.current_move.parentNode.lastChild)}};b.goNext=function(){var f;if(a.current_move!==null){f=a.getSiblingMove(a.current_move,1);a.changeMove(f)}};b.goPrev=function(){var f;if(a.current_move!==null){f=a.getSiblingMove(a.current_move,-1);a.changeMove(f)}};b.goStart=function(){if(a.current_move!==null){a.changeMove(a.current_move.parentNode.firstChild)}};b.updateBoard=function(f){a.board.setPosition(f.currentTarget.fen);a.board.setLastMove(f.currentTarget.move.sq1,f.currentTarget.move.sq2);a.board.display();a.board.setActive(true);if(a.current_move!==null){a.current_move.removeAttribute("class")}f.currentTarget.className="current";a.current_move=f.currentTarget};a.buildHtml=function(h,g){var j,l=document,k,f;if(h.id!==undefined){this.container=document.getElementById(h.id)}if(this.container===undefined||this.container===null){document.write("<div id='canvaschess' class='canvaschesspgn'></div>");this.container=document.getElementById("canvaschess");this.container.removeAttribute("id")}this.container.setAttribute("tabindex",0);this.main_box=l.createElement("div");this.main_box.className="pgn_main_box";this.container.appendChild(this.main_box);this.buildHtmlHeader();this.buildHtmlControls();this.main_box.appendChild(g);this.move_list=l.createElement("ol");this.move_list.className="move_list";this.main_box.appendChild(this.move_list);if(h.width!==null){this.container.style.width=h.width+"px"}if(h.board_width!==null){this.header_details_box.style.width=h.board_width+"px"}if(h.move_list_width!==null){this.game_list.style.width=h.move_list_width+"px";this.move_list.style.width=(h.move_list_width-30)+"px";this.move_list.style.height=h.board_width+"px";this.move_control_box.style.width=h.move_list_width+"px";k=document.getElementsByClassName("pgn_ctrl_btn");f=parseInt((h.move_list_width-120)/8,10);for(j=0;j<k.length;j+=1){k[j].style.margin="0 "+f+"px"}}};a.buildHtmlControls=function(){var f=document;this.control_box=f.createElement("div");this.control_box.className="pgn_control_box";this.container.appendChild(this.control_box);this.board_control_box=f.createElement("span");this.board_control_box.className="board_controls";this.control_box.appendChild(this.board_control_box);this.flip_board_btn=f.createElement("a");this.flip_board_btn.className="board_ctrl_btn board_flip";this.flip_board_btn.title="Flip";this.flip_board_btn.onclick=this.board.flip;this.download_btn=f.createElement("a");this.download_btn.className="board_ctrl_btn board_download";this.download_btn.title="Download PGN";this.board_control_box.appendChild(this.flip_board_btn);this.board_control_box.appendChild(this.download_btn);this.move_control_box=f.createElement("span");this.move_control_box.className="move_controls";this.control_box.appendChild(this.move_control_box);this.control_play_elem=f.createElement("a");this.control_play_elem.className="pgn_ctrl_btn pgn_play";this.control_play_elem.title="Play";this.control_play_elem.onclick=b.goPlay;this.control_pause_elem=f.createElement("a");this.control_pause_elem.className="pgn_ctrl_btn pgn_pause";this.control_pause_elem.title="Pause";this.control_pause_elem.onclick=b.goPause;this.control_start_elem=f.createElement("a");this.control_start_elem.className="pgn_ctrl_btn pgn_start";this.control_start_elem.title="Start";this.control_start_elem.onclick=b.goStart;this.control_prev_elem=f.createElement("a");this.control_prev_elem.className="pgn_ctrl_btn pgn_prev";this.control_prev_elem.title="Previous";this.control_prev_elem.onclick=b.goPrev;this.control_next_elem=f.createElement("a");this.control_next_elem.className="pgn_ctrl_btn pgn_next";this.control_next_elem.title="Next";this.control_next_elem.onclick=b.goNext;this.control_end_elem=f.createElement("a");this.control_end_elem.className="pgn_ctrl_btn pgn_end";this.control_end_elem.title="End";this.control_end_elem.onclick=b.goEnd;this.move_control_box.appendChild(this.control_start_elem);this.move_control_box.appendChild(this.control_prev_elem);this.move_control_box.appendChild(this.control_next_elem);this.move_control_box.appendChild(this.control_end_elem)};a.buildHtmlHeader=function(){var f=document;this.header_box=f.createElement("div");this.header_box.className="pgn_header_box";this.container.insertBefore(this.header_box,this.container.firstChild);this.header_details_box=f.createElement("div");this.header_details_box.className="pgn_header_details_box";this.header_box.appendChild(this.header_details_box);this.header_players_elem=f.createElement("span");this.header_players_elem.className="pgn_players";this.header_players_elem.title="Players";this.header_players_elem.innerHTML="Players";this.header_event_elem=f.createElement("span");this.header_event_elem.className="pgn_event";this.header_event_elem.title="Event";this.header_event_elem.innerHTML="Event";this.header_site_elem=f.createElement("span");this.header_site_elem.className="pgn_site";this.header_site_elem.title="Site";this.header_site_elem.innerHTML="Site";this.header_date_elem=f.createElement("span");this.header_date_elem.className="pgn_date";this.header_date_elem.title="Date";this.header_date_elem.innerHTML="Date";this.header_result_elem=f.createElement("span");this.header_result_elem.className="pgn_result";this.header_result_elem.title="Result";this.header_result_elem.innerHTML="Result";this.header_details_box.appendChild(this.header_players_elem);this.header_details_box.appendChild(this.header_event_elem);this.header_details_box.appendChild(this.header_site_elem);this.header_details_box.appendChild(this.header_date_elem);this.header_details_box.appendChild(this.header_result_elem);this.game_list=f.createElement("select");this.game_list.className="game_list";this.game_list.onchange=function(g){a.changeGame(g.currentTarget.value)};this.header_box.appendChild(this.game_list)};a.changeGame=function(h){var j,o,k,g,s,f,r,q,t,m,p,n,l;c.event="";c.site="";c.date="";c.round="";c.white="";c.black="";c.result="";c.fen="";while(this.move_list.firstChild){this.move_list.removeChild(this.move_list.firstChild)}this.current_move=null;o=c.game_list[h];k=o.match(/\[([^\[]+)\]/g);for(j=0;j<k.length;j+=1){g=k[j].match(/\[(\S+)\s"(.+?)"\]/);g[1]=g[1].replace(/\s+$/,"");g[2]=g[2].replace(/\s+$/,"");switch(g[1].toLowerCase()){case"event":c.event=g[2];break;case"site":c.site=g[2];break;case"date":c.date=g[2];break;case"round":c.round=g[2];break;case"white":c.white=g[2];break;case"black":c.black=g[2];break;case"result":c.result=g[2];break;case"fen":c.fen=g[2];break}}if(c.fen===""){c.fen="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"}this.displayHeader();s=o.match(/\]\s+([{\w][\s\S]+$)/)[1];s=s.replace(/\s*1-0\s*$/,"");s=s.replace(/\s*0-1\s*$/,"");s=s.replace(/\s*1\/2-1\/2\s*$/,"");s=s.replace(/\s*\*\s*$/,"");n=s.match(/\{[^{]*\}/g);s=s.replace(/\{[^{]*\}/g,"{}");f=s.match(/^(\{\})|(\d+[.]{1,3}).+?(?=(\d+[.]{1,3})|$)/g);for(j=0;j<f.length;j+=1){r=f[j].match(/\d+[.]{1,3}\s?([^ )]+)\s?(?:\{\})?/);if(r!==null){m=r[1].match(/[!?=]+/);m=(m&&m[0]?m[0]:null);t=r[1].match(/\$(\d+)/);t=(t&&t[1]?t[1]:null);t=CHESS.nag_code[t];if(t){p=t}else{if(m){p=m}else{p=""}}r[1]=r[1].replace(/[^1-8a-hRNBQKOx\-]*$/,"");r[1]=r[1].replace(/\s*\$.*$/,"");l="";if(/\{\}/.test(r[0])){l=n.shift().replace(/\{/,"").replace(/\}/,"")}this.move(r[1],l,p);f[j]=f[j].replace(r[0],"");q=f[j].match(/(\w[^ )]+)\s?(?:\{\})?/);if(q!==null){m=q[1].match(/[!?=]+/);m=(m&&m[0]?m[0]:null);t=q[1].match(/\$(\d+)/);t=(t&&t[1]?t[1]:null);t=CHESS.nag_code[t];if(t){p=t}else{if(m){p=m}else{p=""}}q[1]=q[1].replace(/[^1-8a-hRNBQKOx\-]*$/,"");q[1]=q[1].replace(/\s*\$.*$/,"");l="";if(/{}/.test(q[0])){l=n.shift().replace(/\{/,"").replace(/\}/,"")}this.move(q[1],l,p)}if(/\)/.test(f[j])){this.endVariation()}if(/\(/.test(f[j])){this.startVariation()}}}this.current_move=a.move_list.getElementsByTagName("li")[0];this.board.setPosition(this.current_move.fen);this.board.display();a.move_list.scrollTop=0};a.changeMove=function(g){var f;if(a.current_move!==g){if(a.current_move!==null&&g!==null){a.current_move.removeAttribute("class")}if(g!==null){g.className="current";b.updateBoard({currentTarget:g});a.current_move=g;f=a.current_move.offsetTop-a.move_list.offsetTop;f-=parseInt(a.move_list.offsetHeight/2,10);a.move_list.scrollTop=f}}};a.displayHeader=function(){this.header_date_elem.innerHTML=this.getPgnDate(c.date);this.header_players_elem.innerHTML=c.white+" vs "+c.black;this.header_event_elem.innerHTML=c.event;this.header_site_elem.innerHTML=c.site;this.header_result_elem.innerHTML=c.result};a.endVariation=function(){this.current_move=this.current_move.parentNode.parentNode.previousSibling;this.ply=(+this.current_move.getAttribute("data-ply"));this.start_end_variation=true;return this};a.getPgnDate=function(h){var j=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Jun","Sep","Oct","Nov","Dec"],l=h.split("."),i="",k="",g="",f;if(l.length===3&&l[0].length===4&&l[1].length===2&&l[2].length===2){i=l[0];k=parseInt(l[1],10);g=parseInt(l[2],10);k=(k>0&&k<13?j[k]:"");f=(g>0?g+" ":"")+(k!==""?k+" ":"")+(i>0?i+" ":"");f=f.replace(/\s+$/,"")}return f};a.getSiblingMove=function(f,g){if(g===1){while(f=f.nextSibling){if(!(/variation_list/.test(f.className))){break}}}else{if(g===-1){while(f=f.previousSibling){if(!(/variation_list/.test(f.className))){break}}}}return f};a.importFile=function(k){var j,g,f,n,h,m,l;k=k.replace(/^ +/gm,"").replace(/$ +/gm,"");k=k.replace(/\n/g," ").replace(/\s+/g," ");c.game_list=k.split(/[^\w](?:(?:1-0)|(?:0-1)|(?:1\/2-1\/2)|\*)\s*(?=\[)/);if(c.game_list.length>1){for(j=0;j<c.game_list.length;j+=1){g=c.game_list[j];f=g.match(/\[\s*white\s+['"](.*?)['"]\]/i);f=(f!==null&&f.length>1?f[1]:"");n=g.match(/\[\s*black\s+['"](.*?)['"]\]/i);n=(n!==null&&n.length>1?n[1]:"");h=g.match(/\[\s*date\s+['"]([0-9.?]+)['"]\]/i);h=(h!==null&&h.length>1?h[1]:"");m=f+" vs. "+n;l=document.createElement("option");l.value=j;l.text=m;this.game_list.appendChild(l)}}else{this.game_list.style.display="none"}this.changeGame(0)};a.move=function(l,n,p){var j,r,g,h,k,q,o,i,m,f;if(!l){return this}if(this.current_move===null){j=document.createElement("li");if(c.fen.length>0){j.fen=c.fen;m=j.fen.match(/\s+([wbWB])\s+([-kqKQ]+)\s+([-\w]{1,2})\s+(\d+)\s+(\d+)\s*$/);f=m[1].toLowerCase();h=+m[5];this.ply=(h*2)-(f==="w"?2:1);j.setAttribute("data-ply",this.ply)}else{j.setAttribute("data-ply",0)}j.move="";j.onclick=b.updateBoard;this.move_list.appendChild(j);this.current_move=j}h=(this.ply%2===0?(parseInt(this.ply/2,10)+1)+".&nbsp;":"");if(this.ply%2===1&&this.start_end_variation){h=(parseInt((this.ply-1)/2,10)+1)+"..."}this.start_end_variation=false;this.ply+=1;r=document.createElement("span");r.setAttribute("class","move_text");r.innerHTML=h+l+p+" ";j=document.createElement("li");j.setAttribute("data-ply",this.ply);j.appendChild(r);if(this.current_move.fen===undefined){if(this.current_move.className==="variation"){k=a.getSiblingMove(this.current_move.parentNode.previousSibling,-1).fen}}else{k=this.current_move.fen}q=CHESS.engine.createPosition(k);o=CHESS.engine.getLongNotation(q,l);i=o.split("-");CHESS.engine.moveTemp(q,i[0],i[1]);k=CHESS.engine.getFEN(q);j.move={sq1:i[0],sq2:i[1]};j.fen=k;j.onclick=b.updateBoard;if(this.current_move.tagName.toLowerCase()==="ol"){this.current_move.appendChild(j)}else{this.current_move.parentNode.appendChild(j)}if(n){g=document.createElement("span");g.setAttribute("class","comment");g.innerHTML=n;j.appendChild(g)}this.current_move=j;return this};a.startVariation=function(){var g,f;if(this.current_move.nextSibling===null){g=document.createElement("li");g.setAttribute("class","variation_list")}else{g=this.current_move.nextSibling}f=document.createElement("ol");f.setAttribute("class","variation");g.appendChild(f);this.current_move.parentNode.appendChild(g);this.current_move=f;this.ply-=1;this.start_end_variation=true;return this};this.flip=function(){a.board.flip()};this.load=function(f,h){var g=new XMLHttpRequest();a.download_btn.href=f;g.onreadystatechange=function(){var i;if(g.readyState===4&&g.status===200){i=g.responseText;a.importFile(i);if(typeof h==="function"){h()}}};g.open("GET",f,true);g.send()};this.loadText=function(f){a.importFile(f)};e=function(f){if(d.width===undefined){d.width=null;d.board_width=null;d.move_list_width=null}else{d.width=parseInt(d.width,10);d.board_width=parseInt((d.width-10)*0.54,10);d.move_list_width=parseInt(d.width,10)-d.board_width}a.board=new CHESS.Board({height:d.board_width,width:d.board_width,square_color_light:d.square_color_light,square_color_dark:d.square_color_dark,highlight_move:d.highlight_move,show_row_col_labels:d.show_row_col_labels});a.buildHtml(d,a.board.getCanvas());a.container.onkeydown=function(g){g.stopPropagation();if(g.keyCode===37){b.goPrev()}else{if(g.keyCode===39){b.goNext()}}};a.container.getElementsByClassName("chessboard")[0].addEventListener("keydown",function(g){g.stopPropagation();if(g.keyCode===37){b.goPrev()}else{if(g.keyCode===39){b.goNext()}}});if(d.url!==undefined){f.load(d.url)}else{if(d.pgn_text!==undefined){f.loadText(d.pgn_text)}}};e(this)};
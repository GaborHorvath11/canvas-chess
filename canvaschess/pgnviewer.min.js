var CHESS=CHESS||{};CHESS.PgnViewer=function(d){var e,b={},c={event:"",site:"",date:"",round:"",white:"",black:"",result:"",fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",game_list:[]},a={board:null,container:null,main_box:null,header_box:null,header_details_box:null,control_box:null,move_control_box:null,board_control_box:null,header_players_elem:null,header_event_elem:null,header_site_elem:null,header_date_elem:null,header_result_elem:null,control_play_elem:null,control_pause_elem:null,control_start_elem:null,control_prev_elem:null,control_next_elem:null,control_end_elem:null,download_btn:null,flip_board_btn:null,move_list:null,game_list:null,current_move:null,ply:0,start_end_variation:false};b.goEnd=function(){if(a.current_move!==null){a.changeMove(a.current_move.parentNode.lastChild)}};b.goNext=function(){var f;if(a.current_move!==null){f=a.getSiblingMove(a.current_move,1);a.changeMove(f)}};b.goPrev=function(){var f;if(a.current_move!==null){f=a.getSiblingMove(a.current_move,-1);a.changeMove(f)}};b.goStart=function(){if(a.current_move!==null){a.changeMove(a.current_move.parentNode.firstChild)}};b.updateBoard=function(f){a.board.setPosition(f.currentTarget.fen);a.board.setLastMove(f.currentTarget.move.sq1,f.currentTarget.move.sq2);a.board.display();a.board.setActive(true);if(a.current_move!==null){a.current_move.removeAttribute("class")}f.currentTarget.className="current";a.current_move=f.currentTarget};a.buildHtml=function(h,g){var j,l=document,k,f;if(h.id!==undefined){this.container=document.getElementById(h.id)}if(this.container===undefined||this.container===null){document.write("<div id='canvaschess' class='canvaschesspgn'></div>");this.container=document.getElementById("canvaschess");this.container.removeAttribute("id")}this.container.setAttribute("tabindex",0);this.main_box=l.createElement("div");this.main_box.className="pgn_main_box";this.container.appendChild(this.main_box);this.buildHtmlHeader();this.buildHtmlControls();this.main_box.appendChild(g);this.move_list=l.createElement("ol");this.move_list.className="move_list";this.main_box.appendChild(this.move_list);if(h.width!==null){this.container.style.width=h.width+"px"}if(h.board_width!==null){this.header_details_box.style.width=h.board_width+"px"}if(h.move_list_width!==null){this.game_list.style.width=h.move_list_width+"px";this.move_list.style.width=(h.move_list_width-30)+"px";this.move_list.style.height=h.board_width+"px";this.move_control_box.style.width=h.move_list_width+"px";k=document.getElementsByClassName("pgn_ctrl_btn");f=parseInt((h.move_list_width-120)/8,10);for(j=0;j<k.length;j+=1){k[j].style.margin="0 "+f+"px"}}};a.buildHtmlControls=function(){var f=document;this.control_box=f.createElement("div");this.control_box.className="pgn_control_box";this.container.appendChild(this.control_box);this.board_control_box=f.createElement("span");this.board_control_box.className="board_controls";this.control_box.appendChild(this.board_control_box);this.flip_board_btn=f.createElement("a");this.flip_board_btn.className="board_ctrl_btn board_flip";this.flip_board_btn.title="Flip";this.flip_board_btn.onclick=this.board.flip;this.download_btn=f.createElement("a");this.download_btn.className="board_ctrl_btn board_download";this.download_btn.title="Download PGN";this.board_control_box.appendChild(this.flip_board_btn);this.board_control_box.appendChild(this.download_btn);this.move_control_box=f.createElement("span");this.move_control_box.className="move_controls";this.control_box.appendChild(this.move_control_box);this.control_play_elem=f.createElement("a");this.control_play_elem.className="pgn_ctrl_btn pgn_play";this.control_play_elem.title="Play";this.control_play_elem.onclick=b.goPlay;this.control_pause_elem=f.createElement("a");this.control_pause_elem.className="pgn_ctrl_btn pgn_pause";this.control_pause_elem.title="Pause";this.control_pause_elem.onclick=b.goPause;this.control_start_elem=f.createElement("a");this.control_start_elem.className="pgn_ctrl_btn pgn_start";this.control_start_elem.title="Start";this.control_start_elem.onclick=b.goStart;this.control_prev_elem=f.createElement("a");this.control_prev_elem.className="pgn_ctrl_btn pgn_prev";this.control_prev_elem.title="Previous";this.control_prev_elem.onclick=b.goPrev;this.control_next_elem=f.createElement("a");this.control_next_elem.className="pgn_ctrl_btn pgn_next";this.control_next_elem.title="Next";this.control_next_elem.onclick=b.goNext;this.control_end_elem=f.createElement("a");this.control_end_elem.className="pgn_ctrl_btn pgn_end";this.control_end_elem.title="End";this.control_end_elem.onclick=b.goEnd;this.move_control_box.appendChild(this.control_start_elem);this.move_control_box.appendChild(this.control_prev_elem);this.move_control_box.appendChild(this.control_next_elem);this.move_control_box.appendChild(this.control_end_elem)};a.buildHtmlHeader=function(){var f=document;this.header_box=f.createElement("div");this.header_box.className="pgn_header_box";this.container.insertBefore(this.header_box,this.container.firstChild);this.header_details_box=f.createElement("div");this.header_details_box.className="pgn_header_details_box";this.header_box.appendChild(this.header_details_box);this.header_players_elem=f.createElement("span");this.header_players_elem.className="pgn_players";this.header_players_elem.title="Players";this.header_players_elem.innerHTML="Players";this.header_event_elem=f.createElement("span");this.header_event_elem.className="pgn_event";this.header_event_elem.title="Event";this.header_event_elem.innerHTML="Event";this.header_site_elem=f.createElement("span");this.header_site_elem.className="pgn_site";this.header_site_elem.title="Site";this.header_site_elem.innerHTML="Site";this.header_date_elem=f.createElement("span");this.header_date_elem.className="pgn_date";this.header_date_elem.title="Date";this.header_date_elem.innerHTML="Date";this.header_result_elem=f.createElement("span");this.header_result_elem.className="pgn_result";this.header_result_elem.title="Result";this.header_result_elem.innerHTML="Result";this.header_details_box.appendChild(this.header_players_elem);this.header_details_box.appendChild(this.header_event_elem);this.header_details_box.appendChild(this.header_site_elem);this.header_details_box.appendChild(this.header_date_elem);this.header_details_box.appendChild(this.header_result_elem);this.game_list=f.createElement("select");this.game_list.className="game_list";this.game_list.onchange=function(g){a.changeGame(g.currentTarget.value)};this.header_box.appendChild(this.game_list)};a.changeGame=function(h){var j,o,k,g,s,f,r,q,t,m,p,n,l;c.event="";c.site="";c.date="";c.round="";c.white="";c.black="";c.result="";c.fen="";while(this.move_list.firstChild){this.move_list.removeChild(this.move_list.firstChild)}this.current_move=null;o=c.game_list[h];k=o.match(/\[([^\[]+)\]/g);for(j=0;j<k.length;j+=1){g=k[j].match(/\[(\S+)\s"(.+?)"\]/);g[1]=g[1].replace(/\s+$/,"");g[2]=g[2].replace(/\s+$/,"");switch(g[1].toLowerCase()){case"event":c.event=g[2];break;case"site":c.site=g[2];break;case"date":c.date=g[2];break;case"round":c.round=g[2];break;case"white":c.white=g[2];break;case"black":c.black=g[2];break;case"result":c.result=g[2];break;case"fen":c.fen=g[2];break}}if(c.fen===""){c.fen="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"}this.displayHeader();s=o.match(/\]\s+([{\w][\s\S]+$)/)[1];s=s.replace(/\s*1-0\s*$/,"");s=s.replace(/\s*0-1\s*$/,"");s=s.replace(/\s*1\/2-1\/2\s*$/,"");s=s.replace(/\s*\*\s*$/,"");n=s.match(/\{[^{]*\}/g);s=s.replace(/\{[^{]*\}/g,"{}");f=s.match(/^(\{\})|(\d+[.]{1,3}).+?(?=(\d+[.]{1,3})|$)/g);if(f[0]==="{}"){l=n.shift().replace(/\{/,"").replace(/\}/,"");this.move(null,l)}for(j=0;j<f.length;j+=1){r=f[j].match(/\d+[.]{1,3}\s?([^ )]+)\s?(?:\{\})?/);if(r!==null){m=r[1].match(/[!?=]+/);m=(m&&m[0]?m[0]:null);t=r[1].match(/\$(\d+)/);t=(t&&t[1]?t[1]:null);t=CHESS.nag_code[t];if(t){p=t}else{if(m){p=m}else{p=""}}r[1]=r[1].replace(/[^1-8a-hRNBQKOx\-]*$/,"");r[1]=r[1].replace(/\s*\$.*$/,"");l="";if(/\{\}/.test(r[0])){l=n.shift().replace(/\{/,"").replace(/\}/,"")}this.move(r[1],l,p);f[j]=f[j].replace(r[0],"");q=f[j].match(/(\w[^ )]+)\s?(?:\{\})?/);if(q!==null){m=q[1].match(/[!?=]+/);m=(m&&m[0]?m[0]:null);t=q[1].match(/\$(\d+)/);t=(t&&t[1]?t[1]:null);t=CHESS.nag_code[t];if(t){p=t}else{if(m){p=m}else{p=""}}q[1]=q[1].replace(/[^1-8a-hRNBQKOx\-]*$/,"");q[1]=q[1].replace(/\s*\$.*$/,"");l="";if(/\{\}/.test(q[0])){l=n.shift().replace(/\{/,"").replace(/\}/,"")}this.move(q[1],l,p)}if(/\)/.test(f[j])){this.endVariation()}if(/\(/.test(f[j])){this.startVariation()}}}this.current_move=a.move_list.getElementsByTagName("li")[0];this.board.setPosition(this.current_move.fen);this.board.display();a.move_list.scrollTop=0};a.changeMove=function(g){var f;if(a.current_move!==g){if(a.current_move!==null&&g!==null){a.current_move.removeAttribute("class")}if(g!==null){g.className="current";b.updateBoard({currentTarget:g});a.current_move=g;f=a.current_move.offsetTop-a.move_list.offsetTop;f-=parseInt(a.move_list.offsetHeight/2,10);a.move_list.scrollTop=f}}};a.displayHeader=function(){this.header_date_elem.innerHTML=this.getPgnDate(c.date);this.header_players_elem.innerHTML=c.white+" vs "+c.black;this.header_event_elem.innerHTML=c.event;this.header_site_elem.innerHTML=c.site;this.header_result_elem.innerHTML=c.result};a.endVariation=function(){this.current_move=this.current_move.parentNode.parentNode.previousSibling;this.ply=(+this.current_move.getAttribute("data-ply"));this.start_end_variation=true;return this};a.getPgnDate=function(h){var j=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Jun","Sep","Oct","Nov","Dec"],l=h.split("."),i="",k="",g="",f;if(l.length===3&&l[0].length===4&&l[1].length===2&&l[2].length===2){i=l[0];k=parseInt(l[1],10);g=parseInt(l[2],10);k=(k>0&&k<13?j[k]:"");f=(g>0?g+" ":"")+(k!==""?k+" ":"")+(i>0?i+" ":"");f=f.replace(/\s+$/,"")}return f};a.getSiblingMove=function(f,g){if(g===1){while(f=f.nextSibling){if(!(/variation_list/.test(f.className))){break}}}else{if(g===-1){while(f=f.previousSibling){if(!(/variation_list/.test(f.className))){break}}}}return f};a.importFile=function(k){var j,g,f,n,h,m,l;k=k.replace(/^ +/gm,"").replace(/$ +/gm,"");k=k.replace(/\n/g," ").replace(/\s+/g," ");c.game_list=k.split(/[^\w](?:(?:1-0)|(?:0-1)|(?:1\/2-1\/2)|\*)\s*(?=\[)/);if(c.game_list.length>1){for(j=0;j<c.game_list.length;j+=1){g=c.game_list[j];f=g.match(/\[\s*white\s+['"](.*?)['"]\]/i);f=(f!==null&&f.length>1?f[1]:"");n=g.match(/\[\s*black\s+['"](.*?)['"]\]/i);n=(n!==null&&n.length>1?n[1]:"");h=g.match(/\[\s*date\s+['"]([0-9.?]+)['"]\]/i);h=(h!==null&&h.length>1?h[1]:"");m=f+" vs. "+n;l=document.createElement("option");l.value=j;l.text=m;this.game_list.appendChild(l)}}else{this.game_list.style.display="none"}this.changeGame(0)};a.move=function(l,n,p){var j,r,g,h,k,q,o,i,m,f;if(!l&&!n){return this}if(this.current_move===null){j=document.createElement("li");if(c.fen.length>0){j.fen=c.fen;m=j.fen.match(/\s+([wbWB])\s+([-kqKQ]+)\s+([-\w]{1,2})\s+(\d+)\s+(\d+)\s*$/);f=m[1].toLowerCase();h=+m[5];this.ply=(h*2)-(f==="w"?2:1);j.setAttribute("data-ply",this.ply)}else{j.setAttribute("data-ply",0)}j.move="";j.onclick=b.updateBoard;this.move_list.appendChild(j);this.current_move=j;if(!l&&typeof n==="string"){g=document.createElement("span");g.setAttribute("class","comment");g.innerHTML=n;j.appendChild(g);return}}h=(this.ply%2===0?(parseInt(this.ply/2,10)+1)+".&nbsp;":"");if(this.ply%2===1&&this.start_end_variation){h=(parseInt((this.ply-1)/2,10)+1)+"..."}this.start_end_variation=false;this.ply+=1;r=document.createElement("span");r.setAttribute("class","move_text");r.innerHTML=h+l+p+" ";j=document.createElement("li");j.setAttribute("data-ply",this.ply);j.appendChild(r);if(this.current_move.fen===undefined){if(this.current_move.className==="variation"){k=a.getSiblingMove(this.current_move.parentNode.previousSibling,-1).fen}}else{k=this.current_move.fen}q=CHESS.engine.createPosition(k);o=CHESS.engine.getLongNotation(q,l);i=o.split("-");CHESS.engine.moveTemp(q,i[0],i[1]);k=CHESS.engine.getFEN(q);j.move={sq1:i[0],sq2:i[1]};j.fen=k;j.onclick=b.updateBoard;if(this.current_move.tagName.toLowerCase()==="ol"){this.current_move.appendChild(j)}else{this.current_move.parentNode.appendChild(j)}if(n){g=document.createElement("span");g.setAttribute("class","comment");g.innerHTML=n;j.appendChild(g)}this.current_move=j;return this};a.startVariation=function(){var g,f;if(this.current_move.nextSibling===null){g=document.createElement("li");g.setAttribute("class","variation_list")}else{g=this.current_move.nextSibling}f=document.createElement("ol");f.setAttribute("class","variation");g.appendChild(f);this.current_move.parentNode.appendChild(g);this.current_move=f;this.ply-=1;this.start_end_variation=true;return this};this.flip=function(){a.board.flip()};this.load=function(f,h){var g=new XMLHttpRequest();a.download_btn.href=f;g.onreadystatechange=function(){var i;if(g.readyState===4&&g.status===200){i=g.responseText;a.importFile(i);if(typeof h==="function"){h()}}};g.open("GET",f,true);g.send()};this.loadText=function(f){a.importFile(f)};e=function(f){if(d.width===undefined){d.width=null;d.board_width=null;d.move_list_width=null}else{d.width=parseInt(d.width,10);d.board_width=parseInt((d.width-10)*0.54,10);d.move_list_width=parseInt(d.width,10)-d.board_width}a.board=new CHESS.Board({height:d.board_width,width:d.board_width,square_color_light:d.square_color_light,square_color_dark:d.square_color_dark,square_hover_dark:d.square_hover_dark,square_hover_light:d.square_hover_light,square_dark:d.square_dark,square_light:d.square_light,highlight_move:d.highlight_move,show_row_col_labels:d.show_row_col_labels});a.buildHtml(d,a.board.getCanvas());a.container.onkeydown=function(g){g.stopPropagation();if(g.keyCode===37){b.goPrev()}else{if(g.keyCode===39){b.goNext()}}};a.container.getElementsByClassName("chessboard")[0].addEventListener("keydown",function(g){g.stopPropagation();if(g.keyCode===37){b.goPrev()}else{if(g.keyCode===39){b.goNext()}}});if(d.url!==undefined){f.load(d.url)}else{if(d.pgn_text!==undefined){f.loadText(d.pgn_text)}}};e(this)};
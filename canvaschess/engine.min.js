var CHESS=CHESS||{};CHESS.engine={};CHESS.engine.createPosition=function(c){var a=function(){var m="",p=[],l=[],g={},h="",n=true,q=true,j=true,o=true,f=true,k=false,e=0};var d=function(){};d.prototype=a;var b=new d();if(c!==undefined){this.setPosition(b,c)}return b};CHESS.engine.setPosition=function(q,e){var m,o,a,p=[],b="",c=0,g="",r="",d="",n=["a","b","c","d","e","f","g","h"],l=0,h=0,f=0;m=e.split(" ");o=m[0];a=m[2];p=o.split("/");q.en_passant=m[3];q.white_to_move=(m[1]==="w");if(a==="-"){q.gs_castle_kside_w=false;q.gs_castle_qside_w=false;q.gs_castle_kside_b=false;q.gs_castle_qside_b=false}else{if(a.indexOf("K")>=0){q.gs_castle_kside_w=true}if(a.indexOf("Q")>=0){q.gs_castle_qside_w=true}if(a.indexOf("k")>=0){q.gs_castle_kside_b=true}if(a.indexOf("q")>=0){q.gs_castle_qside_b=true}}q.position_array=[["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"],["-","-","-","-","-","-","-","-"]];q.piecebox_array=[["-","wk","wq","wr","wb","wn","wp","-"],["-","bk","bq","br","bb","bn","bp","-"]];q.moves=0;q.last_move={};for(l=0;l<p.length;l+=1){for(h=0;h<p[l].length;h+=1){b=p[l].charAt(h);for(f=0;f<q.position_array[l].length;f+=1){if(q.position_array[l][f]==="-"){c=f;f=q.position_array[l].length}}if(/[0-9]/.test(b)){for(f=0;f<parseInt(b,10);f+=1){q.position_array[l][f+c]=""}}else{g="w";if(/[a-z]/.test(b)){g="b"}r=b.toLowerCase();d="";if(r==="p"){d=n[c]}q.position_array[l][c]=g+r+d}}}};CHESS.engine.getFEN=function(l){var g=[],h,a="",b="",k=[],d="",m="",f=0,e=0,c=0;for(f=0;f<l.position_array.length;f+=1){k[f]="";for(e=0;e<l.position_array[f].length;e+=1){m=l.position_array[f][e];if(m===""){c+=1}else{if(c>0){k[f]+=(c+"");c=0}d=m.substr(0,1);m=m.substr(1,1);if(d==="w"){m=m.toUpperCase()}k[f]+=m}}if(c>0){k[f]+=(c+"");c=0}}h=k.join("/");g.push(h);g.push(l.white_to_move?"w":"b");a="-";if(l.gs_castle_kside_w||l.gs_castle_qside_w||l.gs_castle_kside_b||l.gs_castle_qside_b){if(l.gs_castle_kside_w){a+="K"}if(l.gs_castle_qside_w){a+="Q"}if(l.gs_castle_kside_b){a+="k"}if(l.gs_castle_qside_b){a+="q"}}g.push(a);b=(l.en_passant===""?"-":l.en_passant);g.push(b);g.push("0 1");return g.join(" ")};CHESS.engine.isLegal=function(v,c,a){var s,m,l,u,f,t,e,k,o,p,q,h,b,d,g,n,r,j;m=this.getArrayPosition(c);l=this.getArrayPosition(a);if(!m||!l){return false}u=parseInt(m.substr(0,1));f=parseInt(m.substr(1,1));t=parseInt(l.substr(0,1));e=parseInt(l.substr(1,1));k=v.position_array[f][u];o=v.position_array[e][t];p=k.substr(1,1);q=k.substr(0,1);h=false;if((v.white_to_move&&q==="b")||(!v.white_to_move&&q==="w")){return false}if(o.substr(0,1)===k.substr(0,1)){return false}if(p==="p"){if(f===e){return false}if((q==="w"&&e>f)||(q==="b"&&e<f)){return false}if(!(Math.abs(f-e)===1||(Math.abs(f-e)===2&&((q==="w"&&f===6&&v.position_array[5][u]==="")||(q==="b"&&f===1&&v.position_array[2][u]===""))))){return false}if(Math.abs(u-t)===0&&v.position_array[e][t]!==""){return false}if(Math.abs(u-t)>0){b=(o.substr(0,1)!==""&&o.substr(0,1)!==q);h=v.en_passant===this.reverseArrayPosition(e+""+t);if(!(Math.abs(u-t)===1&&Math.abs(f-e)===1&&(b||h))){return false}}}if(p==="k"){if(Math.abs(u-t)===2){if(q==="w"){if(a==="g1"&&v.gs_castle_kside_w&&v.position_array[7][5]===""&&v.position_array[7][6]===""){if(this.isSquareAttacked(v.position_array,4,7,"w")){return false}if(this.isSquareAttacked(v.position_array,5,7,"w")){return false}if(this.isSquareAttacked(v.position_array,6,7,"w")){return false}}else{if(a==="c1"&&v.gs_castle_qside_w&&v.position_array[7][1]===""&&v.position_array[7][2]===""&&v.position_array[7][3]===""){if(this.isSquareAttacked(v.position_array,2,7,"w")){return false}if(this.isSquareAttacked(v.position_array,3,7,"w")){return false}if(this.isSquareAttacked(v.position_array,4,7,"w")){return false}}else{return false}}}else{if(q==="b"){if(a==="g8"&&v.gs_castle_kside_b&&v.position_array[0][5]===""&&v.position_array[0][6]===""){if(this.isSquareAttacked(v.position_array,4,0,"b")){return false}if(this.isSquareAttacked(v.position_array,5,0,"b")){return false}if(this.isSquareAttacked(v.position_array,6,0,"b")){return false}}else{if(a==="c8"&&v.gs_castle_qside_b&&v.position_array[0][1]===""&&v.position_array[0][2]===""&&v.position_array[0][3]===""){if(this.isSquareAttacked(v.position_array,2,0,"b")){return false}if(this.isSquareAttacked(v.position_array,3,0,"b")){return false}if(this.isSquareAttacked(v.position_array,4,0,"b")){return false}}else{return false}}}}}else{if(!(Math.abs(u-t)<2&&Math.abs(f-e)<2)){return false}}}if(p==="n"&&!((Math.abs(u-t)===1&&Math.abs(f-e)===2)||(Math.abs(u-t)===2&&Math.abs(f-e)===1))){return false}if(p==="r"){if(u!==t&&f!==e){return false}}if(p==="b"){if(Math.abs(u-t)!==Math.abs(f-e)){return false}}if(p==="q"){if((Math.abs(u-t)!==Math.abs(f-e))&&(u!==t&&f!==e)){return false}}if(p==="q"||p==="b"||p==="r"){s=0;d=u-t;g=f-e;n=0;r=0;if(d<0){n=1}else{if(d>0){n=-1}}if(g<0){r=1}else{if(g>0){r=-1}}s=1;while(!(parseInt(u)+s*n===t&&parseInt(f)+s*r===e)){if(s>8){break}if(v.position_array[parseInt(f)+s*r][parseInt(u)+s*n]!==""){return false}s+=1}}j=this.clonePositionArray(v.position_array);j[l.substr(1,1)][l.substr(0,1)]=j[m.substr(1,1)][m.substr(0,1)];j[m.substr(1,1)][m.substr(0,1)]="";if(h){j[m.substr(1,1)][l.substr(0,1)]=""}if(this.isCheck(j,q)){return false}return true};CHESS.engine.isCheck=function(f,e){var d,b,c=0,a=0;for(d=0;d<8;d++){for(b=0;b<8;b++){if(f[d][b]===e+"k"){c=b;a=d}}}if(this.isSquareAttacked(f,c,a,e)){return true}return false};CHESS.engine.isMate=function(y){var u,s,p=(y.white_to_move?"w":"b"),o=0,m=0,r,t,q,n,c=this.clonePositionArray(y.position_array);for(u=0;u<8;u++){for(s=0;s<8;s++){if(c[u][s]===p+"k"){o=s;m=u}}}r=this.getAttacker(c,o,m,p);if(r===""){return false}c[m][o]="";if(m>0){if(c[m-1][o].substr(0,1)!==p){if(!this.isSquareAttacked(c,o,m-1,p)){return false}}}if(m<7){if(c[m+1][o].substr(0,1)!==p){if(!this.isSquareAttacked(c,o,m+1,p)){return false}}}if(o>0){if(c[m][o-1].substr(0,1)!==p){if(!this.isSquareAttacked(c,o-1,m,p)){return false}}}if(o<7){if(c[m][o+1].substr(0,1)!==p){if(!this.isSquareAttacked(c,o+1,m,p)){return false}}}if(o>0&&m>0){if(c[m-1][o-1].substr(0,1)!==p){if(!this.isSquareAttacked(c,o-1,m-1,p)){return false}}}if(o<7&&m>0){if(c[m-1][o+1].substr(0,1)!==p){if(!this.isSquareAttacked(c,o+1,m-1,p)){return false}}}if(o>0&&m<7){if(c[m+1][o-1].substr(0,1)!==p){if(!this.isSquareAttacked(c,o-1,m+1,p)){return false}}}if(o<7&&m<7){if(c[m+1][o+1].substr(0,1)!==p){if(!this.isSquareAttacked(c,o+1,m+1,p)){return false}}}c[m][o]=p+"k";t=parseInt(r.substr(1,1));q=parseInt(r.substr(0,1));var k="b";if(p==="b"){k="w"}n=this.getAttacker(c,q,t,k);if(n!==""){var f=this.reverseArrayPosition(n);var d=this.reverseArrayPosition(r);if(this.isLegal(y,f,d)){return false}}var h=c[q][t].substr(1,1);if(h==="r"||h==="b"||h==="q"){if(Math.abs(o-t)>1||Math.abs(m-q)>1){var w=t-o;var e=q-m;var g=0;var l=0;if(w>0){g=1}if(e>0){l=1}if(w<0){g=-1}if(e<0){l=-1}var x=o+g,v=m+l;c[m][o]=k+"k";while(x!==t||v!==q){if(this.isSquareBlockable(c,x,v,k)){return false}x+=g;v+=l}}}if(h==="p"){if(p==="w"&&q===3&&y.en_passant===this.reverseArrayPosition((q-1)+""+t)){if(t>0&&c[3][t-1].substr(0,2)==="wp"){return false}if(t<7&&c[3][t+1].substr(0,2)==="wp"){return false}}if(p==="b"&&q===4&&y.en_passant===this.reverseArrayPosition((q+1)+""+t)){if(t>0&&c[4][t-1].substr(0,2)==="bp"){return false}if(t<7&&c[4][t+1].substr(0,2)==="bp"){return false}}}return true};CHESS.engine.isSquareAttacked=function(e,c,b,d){var a;c=parseInt(c);b=parseInt(b);if(b>0&&c>1&&e[b-1][c-2].substr(1,1)==="n"&&e[b-1][c-2].substr(0,1)!==d){return true}if(b>0&&c<6&&e[b-1][c+2].substr(1,1)==="n"&&e[b-1][c+2].substr(0,1)!==d){return true}if(b<7&&c>1&&e[b+1][c-2].substr(1,1)==="n"&&e[b+1][c-2].substr(0,1)!==d){return true}if(b<7&&c<6&&e[b+1][c+2].substr(1,1)==="n"&&e[b+1][c+2].substr(0,1)!==d){return true}if(b>1&&c>0&&e[b-2][c-1].substr(1,1)==="n"&&e[b-2][c-1].substr(0,1)!==d){return true}if(b>1&&c<7&&e[b-2][c+1].substr(1,1)==="n"&&e[b-2][c+1].substr(0,1)!==d){return true}if(b<6&&c>0&&e[b+2][c-1].substr(1,1)==="n"&&e[b+2][c-1].substr(0,1)!==d){return true}if(b<6&&c<7&&e[b+2][c+1].substr(1,1)==="n"&&e[b+2][c+1].substr(0,1)!==d){return true}i=1;while(c+i<8){a=e[b][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0){a=e[b][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(b-i>=0){a=e[b-i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(b+i<8){a=e[b+i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c+i<8&&b-i>=0){a=e[b-i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c+i<8&&b+i<8){a=e[b+i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b+i<8){a=e[b+i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b-i>=0){a=e[b-i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return true}if(a!==""){break}i+=1}if(d==="w"){if(c-1>=0&&b-1>=0){a=e[b-1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}if(c+1<8&&b-1>=0){a=e[b-1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}}else{if(c-1>=0&&b+1<8){a=e[b+1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}if(c+1<8&&b+1<8){a=e[b+1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return true}}}return false};CHESS.engine.isSquareBlockable=function(d,e,c,b){var a;e=parseInt(e);c=parseInt(c);if(c>0&&e>1&&d[c-1][e-2].substr(1,1)==="n"&&d[c-1][e-2].substr(0,1)!==b){return true}if(c>0&&e<6&&d[c-1][e+2].substr(1,1)==="n"&&d[c-1][e+2].substr(0,1)!==b){return true}if(c<7&&e>1&&d[c+1][e-2].substr(1,1)==="n"&&d[c+1][e-2].substr(0,1)!==b){return true}if(c<7&&e<6&&d[c+1][e+2].substr(1,1)==="n"&&d[c+1][e+2].substr(0,1)!==b){return true}if(c>1&&e>0&&d[c-2][e-1].substr(1,1)==="n"&&d[c-2][e-1].substr(0,1)!==b){return true}if(c>1&&e<7&&d[c-2][e+1].substr(1,1)==="n"&&d[c-2][e+1].substr(0,1)!==b){return true}if(c<6&&e>0&&d[c+2][e-1].substr(1,1)==="n"&&d[c+2][e-1].substr(0,1)!==b){return true}if(c<6&&e<7&&d[c+2][e+1].substr(1,1)==="n"&&d[c+2][e+1].substr(0,1)!==b){return true}i=1;while(e+i<8){a=d[c][e+i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(e-i>=0){a=d[c][e-i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(c-i>=0){a=d[c-i][e];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(c+i<8){a=d[c+i][e];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="r"||a.substr(1,1)==="q")){return true}if(a!==""){break}i+=1}i=1;while(e+i<8&&c-i>=0){a=d[c-i][e+i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}i=1;while(e+i<8&&c+i<8){a=d[c+i][e+i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}i=1;while(e-i>=0&&c+i<8){a=d[c+i][e-i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}i=1;while(e-i>=0&&c-i>=0){a=d[c-i][e-i];if(a!==""&&a.substr(0,1)!==b&&(a.substr(1,1)==="q"||a.substr(1,1)==="b")){return true}if(a!==""){break}i+=1}if(b==="w"){if(c-1>=0){a=d[c-1][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}if(c===3&&d[2][e]===""){a=d[1][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}}else{if(c+1<8){a=d[c+1][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}if(c===4&&d[5][e]===""){a=d[6][e];if(a!==""&&a.substr(0,1)!==b&&a.substr(1,1)==="p"){return true}}}return false};CHESS.engine.getAttacker=function(e,c,b,d){var a;c=parseInt(c);b=parseInt(b);if(b>0&&c>1&&e[b-1][c-2].substr(1,1)==="n"&&e[b-1][c-2].substr(0,1)!==d){return(b-1)+""+(c-2)}if(b>0&&c<6&&e[b-1][c+2].substr(1,1)==="n"&&e[b-1][c+2].substr(0,1)!==d){return(b-1)+""+(c+2)}if(b<7&&c>1&&e[b+1][c-2].substr(1,1)==="n"&&e[b+1][c-2].substr(0,1)!==d){return(b+1)+""+(c-2)}if(b<7&&c<6&&e[b+1][c+2].substr(1,1)==="n"&&e[b+1][c+2].substr(0,1)!==d){return(b+1)+""+(c+2)}if(b>1&&c>0&&e[b-2][c-1].substr(1,1)==="n"&&e[b-2][c-1].substr(0,1)!==d){return(b-2)+""+(c-1)}if(b>1&&c<7&&e[b-2][c+1].substr(1,1)==="n"&&e[b-2][c+1].substr(0,1)!==d){return(b-2)+""+(c+1)}if(b<6&&c>0&&e[b+2][c-1].substr(1,1)==="n"&&e[b+2][c-1].substr(0,1)!==d){return(b+2)+""+(c-1)}if(b<6&&c<7&&e[b+2][c+1].substr(1,1)==="n"&&e[b+2][c+1].substr(0,1)!==d){return(b+2)+""+(c+1)}i=1;while(c+i<8){a=e[b][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b)+""+(c+i)}if(a!==""){break}i+=1}i=1;while(c-i>=0){a=e[b][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b)+""+(c-i)}if(a!==""){break}i+=1}i=1;while(b-i>=0){a=e[b-i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b-i)+""+(c)}if(a!==""){break}i+=1}i=1;while(b+i<8){a=e[b+i][c];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="r"||a.substr(1,1)==="q"||(i===1&&a.substr(1,1)==="k"))){return(b+i)+""+(c)}if(a!==""){break}i+=1}i=1;while(c+i<8&&b-i>=0){a=e[b-i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b-i)+""+(c+i)}if(a!==""){break}i+=1}i=1;while(c+i<8&&b+i<8){a=e[b+i][c+i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b+i)+""+(c+i)}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b+i<8){a=e[b+i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b+i)+""+(c-i)}if(a!==""){break}i+=1}i=1;while(c-i>=0&&b-i>=0){a=e[b-i][c-i];if(a!==""&&a.substr(0,1)!==d&&(a.substr(1,1)==="q"||a.substr(1,1)==="b"||(i===1&&a.substr(1,1)==="k"))){return(b-i)+""+(c-i)}if(a!==""){break}i+=1}if(d==="w"){if(c-1>0&&b-1>=0){a=e[b-1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b-1)+""+(c-1)}}if(c+1<8&&b-1>=0){a=e[b-1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b-1)+""+(c+1)}}}else{if(c-1>=0&&b+1<8){a=e[b+1][c-1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b+1)+""+(c-1)}}if(c+1<8&&b+1<8){a=e[b+1][c+1];if(a!==""&&a.substr(0,1)!==d&&a.substr(1,1)==="p"){return(b+1)+""+(c+1)}}}return""};CHESS.engine.isStalemate=function(b){var a=!this.getLegalMoves(b,true);return a};CHESS.engine.getLegalMoves=function(n,h){var g,f,l,k,d="",m=[],e=(n.white_to_move?"w":"b"),c,b=0,a;for(g=0;g<8;g++){for(f=0;f<8;f++){l=this.reverseArrayPosition(g+""+f);if(n.position_array[g][f]===e+"k"){if(g>0){k=this.reverseArrayPosition((g-1)+""+f);d=l+"-"+k;m.push(d)}if(g>0&&f<7){k=this.reverseArrayPosition((g-1)+""+(f+1));d=l+"-"+k;m.push(d)}if(f<7){k=this.reverseArrayPosition(g+""+(f+1));d=l+"-"+k;m.push(d)}if(g<7&&f<7){k=this.reverseArrayPosition((g+1)+""+(f+1));d=l+"-"+k;m.push(d)}if(g<7){k=this.reverseArrayPosition((g+1)+""+f);d=l+"-"+k;m.push(d)}if(g<7&&f>0){k=this.reverseArrayPosition((g+1)+""+(f-1));d=l+"-"+k;m.push(d)}if(f>0){k=this.reverseArrayPosition(g+""+(f-1));d=l+"-"+k;m.push(d)}if(g>0&&f>0){k=this.reverseArrayPosition((g-1)+""+(f-1));d=l+"-"+k;m.push(d)}}if(n.position_array[g][f].substr(0,2)===e+"p"){c=(e==="w"?-1:1);k=this.reverseArrayPosition((g+c)+""+f);d=l+"-"+k;m.push(d);if((e==="w"&&g===6)||(e==="b"&&g===1)){k=this.reverseArrayPosition((g+(c*2))+""+f);d=l+"-"+k;m.push(d)}if(/[a-h][1-8]/.test(n.en_passant)){a=parseInt(this.getArrayPosition(n.en_passant).substr(0,1),10)}if(e==="w"&&g===3){if(a===(f-1)){k=this.reverseArrayPosition((g-1)+""+(f-1));d=l+"-"+k;m.push(d)}if(a===(f+1)){k=this.reverseArrayPosition((g-1)+""+(f+1));d=l+"-"+k;m.push(d)}}if(e==="b"&&g===4){if(a===(f-1)){k=this.reverseArrayPosition((g+1)+""+(f-1));d=l+"-"+k;m.push(d)}if(a===(f+1)){k=this.reverseArrayPosition((g+1)+""+(f+1));d=l+"-"+k;m.push(d)}}}if(n.position_array[g][f]===e+"q"){b=1;while(g-b>=0){k=this.reverseArrayPosition((g-b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(g-b>=0&&f+b<=7){k=this.reverseArrayPosition((g-b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7){k=this.reverseArrayPosition(g+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7&&g+b<=7){k=this.reverseArrayPosition((g+b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7){k=this.reverseArrayPosition((g+b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7&&f-b>=0){k=this.reverseArrayPosition((g+b)+""+(f-b));d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0){k=this.reverseArrayPosition(g+""+(f-b));d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0&&g-b>=0){k=this.reverseArrayPosition((g-b)+""+(f-b));d=l+"-"+k;m.push(d);b++}}if(n.position_array[g][f]===e+"r"){b=1;while(g-b>=0){k=this.reverseArrayPosition((g-b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7){k=this.reverseArrayPosition(g+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7){k=this.reverseArrayPosition((g+b)+""+f);d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0){k=this.reverseArrayPosition(g+""+(f-b));d=l+"-"+k;m.push(d);b++}}if(n.position_array[g][f]===e+"b"){b=1;while(g-b>=0&&f+b<=7){k=this.reverseArrayPosition((g-b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(f+b<=7&&g+b<=7){k=this.reverseArrayPosition((g+b)+""+(f+b));d=l+"-"+k;m.push(d);b++}b=1;while(g+b<=7&&f-b>=0){k=this.reverseArrayPosition((g+b)+""+(f-b));d=l+"-"+k;m.push(d);b++}b=1;while(f-b>=0&&g-b>=0){k=this.reverseArrayPosition((g-b)+""+(f-b));d=l+"-"+k;m.push(d);b++}}if(n.position_array[g][f]===e+"n"){if(g>=2&&f<=6){k=this.reverseArrayPosition((g-2)+""+(f+1));d=l+"-"+k;m.push(d)}if(g>=1&&f<=5){k=this.reverseArrayPosition((g-1)+""+(f+2));d=l+"-"+k;m.push(d)}if(g<=6&&f<=5){k=this.reverseArrayPosition((g+1)+""+(f+2));d=l+"-"+k;m.push(d)}if(g<=5&&f<=6){k=this.reverseArrayPosition((g+2)+""+(f+1));d=l+"-"+k;m.push(d)}if(g<=5&&f>=1){k=this.reverseArrayPosition((g+2)+""+(f-1));d=l+"-"+k;m.push(d)}if(g<=6&&f>=2){k=this.reverseArrayPosition((g+1)+""+(f-2));d=l+"-"+k;m.push(d)}if(g>=1&&f>=2){k=this.reverseArrayPosition((g-1)+""+(f-2));d=l+"-"+k;m.push(d)}if(g>=2&&f>=1){k=this.reverseArrayPosition((g-2)+""+(f-1));d=l+"-"+k;m.push(d)}}}}for(g=0;g<m.length;g++){l=m[g].split("-")[0];k=m[g].split("-")[1];if(!this.isLegal(n,l,k)){m.splice(g,1);g--}else{if(h){return true}}}if(h){return false}return m};CHESS.engine.getLongNotation=function(l,b){var e,d,a="",k,h=b.replace(/[#+=xKQRBN]/g,""),c=(l.white_to_move?"w":"b"),m=b.substring(0,1),g="",f="";if(b==="O-O"){if(c==="w"){return"e1-g1"}else{return"e8-g8"}}else{if(b==="O-O-O"){if(c==="w"){return"e1-c1"}else{return"e8-c8"}}}if(h.length===3){g=h.substr(0,1);h=h.substr(h.length-2,2);if(/[0-9]/.test(g)){f="rank"}else{if(/[a-z]/.test(g)){g=g.charCodeAt(0)-97;f="file"}}}if(m!=="K"&&m!=="Q"&&m!=="W"&&m!=="R"&&m!=="B"&&m!=="N"){m="p"}m=m.toLowerCase();for(e=0;e<8;e++){for(d=0;d<8;d++){if(f==="rank"&&parseInt(g)!==(8-e)){continue}else{if(f==="file"&&parseInt(g)!==d){continue}}if(l.position_array[e][d].length>1&&l.position_array[e][d].substr(0,2)===c+m){k=this.reverseArrayPosition(e+""+d);if(this.isLegal(l,k,h)){a=k+"-"+h}}}}return a};CHESS.engine.getArrayPosition=function(b){var a,d,c=false;if(/[a-h][1-8]/.test(b)){a=b.substr(0,1).toLowerCase();d=b.substr(1,1);a=a.charCodeAt(0)-97;d=8-d;c=a+""+d}return c};CHESS.engine.reverseArrayPosition=function(b){var a=parseInt(b.substr(1,1)),c=parseInt(b.substr(0,1));a=String.fromCharCode(a+97);c=8-c;return a+""+c};CHESS.engine.clonePositionArray=function(b){var a=0,c=[];for(a=0;a<8;a+=1){c[a]=b[a].slice(0)}return c};CHESS.engine.moveTemp=function(w,b,a){var p,o,f,e,d,n,c,m,r,q,h,g,v,l,u,k,t,s="",j;if(!this.isLegal(w,b,a)){return false}w.last_move={sq1:this.getArrayPosition(b),sq2:this.getArrayPosition(a)};if(w.white_to_move){p=b;o=a;f=this.getArrayPosition(p);e=this.getArrayPosition(o);d=parseInt(f.substr(0,1));n=parseInt(f.substr(1,1));c=parseInt(e.substr(0,1));m=parseInt(e.substr(1,1));s=w.position_array[m][c];j=w.position_array[n][d];w.position_array[m][c]=w.position_array[n][d];w.position_array[n][d]="";f=this.getArrayPosition(p);if(j.substr(0,2)==="wp"&&m-n===-2){w.en_passant=this.reverseArrayPosition((m+1)+""+c)}else{w.en_passant=""}if(j.substr(0,2)==="wp"&&c!==d&&s===""){w.position_array[n][c]="";t=o.substr(0,1)+p.substr(1,1)}if(j.substr(0,2)==="wp"&&m===0){w.position_array[m][c]="wq"}if(j==="wk"&&p==="e1"){if(o==="g1"){w.position_array[7][5]="wrk";w.position_array[7][7]=""}else{if(o==="c1"){w.position_array[7][3]="wrq";w.position_array[7][0]=""}}}if(j==="wk"){w.gs_castle_kside_w=false;w.gs_castle_qside_w=false}else{if(j==="wr"&&p==="h1"){w.gs_castle_kside_w=false}else{if(j==="wr"&&p==="a1"){w.gs_castle_qside_w=false}else{if(s==="br"&&o==="a8"){w.gs_castle_qside_b=false}else{if(s==="br"&&o==="h8"){w.gs_castle_kside_b=false}}}}}w.white_to_move=false}else{r=b;q=a;h=this.getArrayPosition(r);g=this.getArrayPosition(q);v=parseInt(h.substr(0,1));l=parseInt(h.substr(1,1));u=parseInt(g.substr(0,1));k=parseInt(g.substr(1,1));s=w.position_array[k][u];j=w.position_array[l][v];w.position_array[k][u]=w.position_array[l][v];w.position_array[l][v]="";h=this.getArrayPosition(r);if(j.substr(0,2)==="bp"&&k-l===2){w.en_passant=this.reverseArrayPosition((k-1)+""+u)}else{w.en_passant=""}if(j.substr(0,2)==="bp"&&u!==v&&s===""){w.position_array[l][u]="";t=q.substr(0,1)+r.substr(1,1)}if(j.substr(0,2)==="bp"&&k===7){w.position_array[k][u]="bq"}if(j==="bk"&&r==="e8"){if(q==="g8"){w.position_array[0][5]="brk";w.position_array[0][7]=""}else{if(q==="c8"){w.position_array[0][3]="brq";w.position_array[0][0]=""}}}if(j==="bk"){w.gs_castle_kside_b=false;w.gs_castle_qside_b=false}else{if(j==="br"&&r==="h8"){w.gs_castle_kside_b=false}else{if(j==="br"&&r==="a8"){w.gs_castle_qside_b=false}else{if(s==="wr"&&q==="a1"){w.gs_castle_qside_w=false}else{if(s==="wr"&&q==="h1"){w.gs_castle_kside_w=false}}}}}w.white_to_move=true}if(this.isMate(w)||this.isStalemate(w)){w.active=false}return true};